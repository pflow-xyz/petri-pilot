// Generated by petri-pilot. DO NOT EDIT.

import { createNavigation, refreshNavigation } from './navigation.js'
import { navigate, initRouter, getRouteParams, getCurrentRoute } from './router.js'
import { loadViews, renderFormView, renderDetailView, renderTableView, getFormData } from './views.js'

// API client
const API_BASE = ''

// App state
let currentUser = null
let authToken = null
let instances = []
let currentInstance = null

// ============================================================================
// Auth
// ============================================================================

function loadAuth() {
  const stored = localStorage.getItem('auth')
  if (stored) {
    try {
      const auth = JSON.parse(stored)
      if (auth.expires_at && new Date(auth.expires_at) > new Date()) {
        authToken = auth.token
        currentUser = auth.user
        return true
      }
      localStorage.removeItem('auth')
    } catch (e) {
      localStorage.removeItem('auth')
    }
  }
  return false
}

function saveAuth(data) {
  localStorage.setItem('auth', JSON.stringify(data))
  authToken = data.token
  currentUser = data.user
  window.dispatchEvent(new CustomEvent('auth-change'))
}

function clearAuth() {
  localStorage.removeItem('auth')
  authToken = null
  currentUser = null
  window.dispatchEvent(new CustomEvent('auth-change'))
}

function getHeaders() {
  const headers = { 'Content-Type': 'application/json' }
  if (authToken) {
    headers['Authorization'] = `Bearer ${authToken}`
  }
  return headers
}

// ============================================================================
// API
// ============================================================================

async function handleResponse(response) {
  if (response.status === 401) {
    clearAuth()
    showError('Session expired. Please log in again.')
    throw new Error('Unauthorized')
  }
  if (!response.ok) {
    const error = await response.json().catch(() => ({}))
    throw new Error(error.message || response.statusText)
  }
  return response.json()
}

const api = {
  async getMe() {
    const response = await fetch(`${API_BASE}/auth/me`, { headers: getHeaders() })
    return handleResponse(response)
  },

  async logout() {
    await fetch(`${API_BASE}/auth/logout`, { method: 'POST', headers: getHeaders() })
    clearAuth()
  },

  async listInstances() {
    const response = await fetch(`${API_BASE}/admin/instances`, { headers: getHeaders() })
    return handleResponse(response)
  },

  async getInstance(id) {
    const response = await fetch(`${API_BASE}/api/{{.PackageName}}/${id}`, { headers: getHeaders() })
    return handleResponse(response)
  },

  async createInstance(data = {}) {
    const response = await fetch(`${API_BASE}/api/{{.PackageName}}`, {
      method: 'POST',
      headers: getHeaders(),
      body: JSON.stringify(data),
    })
    return handleResponse(response)
  },

  async executeTransition(transitionId, aggregateId, data = {}) {
    const response = await fetch(`${API_BASE}/api/${transitionId}`, {
      method: 'POST',
      headers: getHeaders(),
      body: JSON.stringify({ aggregate_id: aggregateId, data }),
    })
    return handleResponse(response)
  },
}

// Export for global access
window.api = api

// Export auth functions for testing
window.setAuthToken = function(token) {
  authToken = token
}
window.saveAuth = saveAuth
window.clearAuth = clearAuth

// ============================================================================
// UI Helpers
// ============================================================================

function showError(message) {
  const app = document.getElementById('app')
  const existing = app.querySelector('.alert-error')
  if (existing) existing.remove()

  const alert = document.createElement('div')
  alert.className = 'alert alert-error'
  alert.textContent = message
  app.insertBefore(alert, app.firstChild)

  setTimeout(() => alert.remove(), 5000)
}

function showSuccess(message) {
  const app = document.getElementById('app')
  const existing = app.querySelector('.alert-success')
  if (existing) existing.remove()

  const alert = document.createElement('div')
  alert.className = 'alert alert-success'
  alert.textContent = message
  app.insertBefore(alert, app.firstChild)

  setTimeout(() => alert.remove(), 3000)
}

// Get human-readable status from places
function getStatus(places) {
  if (!places) return 'unknown'
  for (const [place, tokens] of Object.entries(places)) {
    if (tokens > 0) return place
  }
  return 'unknown'
}

// Format status as badge
function formatStatus(status) {
  const statusClass = `badge-${status.toLowerCase().replace(/_/g, '-')}`
  return `<span class="badge ${statusClass}">${status.replace(/_/g, ' ')}</span>`
}

// ============================================================================
// Page Renderers
// ============================================================================

// List page - shows all instances
async function renderListPage() {
  const app = document.getElementById('app')
  app.innerHTML = `
    <div class="page">
      <div class="page-header">
        <h1>{{.ModelName}}</h1>
        <button class="btn btn-primary" onclick="handleCreateNew()">+ New</button>
      </div>
      <div id="instances-list" class="entity-list">
        <div class="loading">Loading...</div>
      </div>
    </div>
  `

  try {
    const result = await api.listInstances()
    instances = result.instances || []
    renderInstancesList()
  } catch (err) {
    document.getElementById('instances-list').innerHTML = `
      <div class="empty-state">
        <h3>No instances yet</h3>
        <p>Create your first instance to get started.</p>
        <button class="btn btn-primary" onclick="handleCreateNew()" style="margin-top: 1rem">+ Create New</button>
      </div>
    `
  }
}

function renderInstancesList() {
  const container = document.getElementById('instances-list')
  if (!container) return

  if (instances.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <h3>No instances yet</h3>
        <p>Create your first instance to get started.</p>
        <button class="btn btn-primary" onclick="handleCreateNew()" style="margin-top: 1rem">+ Create New</button>
      </div>
    `
    return
  }

  container.innerHTML = instances.map(inst => {
    const status = getStatus(inst.state || inst.places)
    return `
      <div class="entity-card" onclick="navigate('/{{.ProjectName}}/${inst.id}')">
        <div class="entity-info">
          <h3>${inst.id}</h3>
          <div class="entity-meta">
            ${formatStatus(status)} &middot; Version ${inst.version || 0}
          </div>
        </div>
        <div class="entity-actions">
          <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); navigate('/{{.ProjectName}}/${inst.id}')">
            View
          </button>
        </div>
      </div>
    `
  }).join('')
}

// Detail page - shows single instance with actions
async function renderDetailPage() {
  const params = getRouteParams()
  const id = params.id

  const app = document.getElementById('app')
  app.innerHTML = `
    <div class="page">
      <div class="page-header">
        <div>
          <button class="btn btn-link" onclick="navigate('/{{.ProjectName}}')" style="margin-left: -0.5rem">
            &larr; Back to List
          </button>
          <h1 style="margin-top: 0.5rem">Instance: ${id}</h1>
        </div>
      </div>
      <div id="instance-detail">
        <div class="loading">Loading...</div>
      </div>
    </div>
  `

  try {
    const result = await api.getInstance(id)
    currentInstance = {
      id: result.aggregate_id || id,
      version: result.version,
      state: result.state,
      places: result.places,
      enabled: result.enabled || result.enabled_transitions || [],
    }
    renderInstanceDetail()
  } catch (err) {
    document.getElementById('instance-detail').innerHTML = `
      <div class="alert alert-error">Failed to load instance: ${err.message}</div>
    `
  }
}

function renderInstanceDetail() {
  const container = document.getElementById('instance-detail')
  if (!container || !currentInstance) return

  const status = getStatus(currentInstance.places)
  const enabled = currentInstance.enabled || []

  // Transition definitions
  const transitions = [
{{- range .Transitions}}
    { id: '{{.ID}}', name: '{{.DisplayName}}', description: '{{.Description}}' },
{{- end}}
  ]

  container.innerHTML = `
    <div class="card">
      <div class="card-header">Status</div>
      <div class="detail-list">
        <div class="detail-field">
          <dt>ID</dt>
          <dd><code>${currentInstance.id}</code></dd>
        </div>
        <div class="detail-field">
          <dt>Status</dt>
          <dd>${formatStatus(status)}</dd>
        </div>
        <div class="detail-field">
          <dt>Version</dt>
          <dd>${currentInstance.version || 0}</dd>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">Actions</div>
      <div class="view-actions">
        ${transitions.map(t => {
          const isEnabled = enabled.includes(t.id)
          return `
            <button
              class="btn ${isEnabled ? 'btn-primary' : 'btn-secondary'}"
              onclick="handleTransition('${t.id}')"
              ${isEnabled ? '' : 'disabled'}
              title="${t.description || t.name}"
            >
              ${t.name}
            </button>
          `
        }).join('')}
      </div>
      ${enabled.length === 0 ? '<p style="color: #666; margin-top: 1rem;">No actions available in current state.</p>' : ''}
    </div>

    <div class="card">
      <div class="card-header">Current State</div>
      <div class="detail-list">
        ${Object.entries(currentInstance.places || {}).map(([place, tokens]) => `
          <div class="detail-field">
            <dt>${place}</dt>
            <dd>${tokens > 0 ? `<span class="badge badge-${place}">${tokens} token${tokens > 1 ? 's' : ''}</span>` : '<span style="color: #999;">0</span>'}</dd>
          </div>
        `).join('')}
      </div>
    </div>
  `
}

// Form page - create new instance
async function renderFormPage() {
  const app = document.getElementById('app')
  app.innerHTML = `
    <div class="page">
      <div class="page-header">
        <div>
          <button class="btn btn-link" onclick="navigate('/{{.ProjectName}}')" style="margin-left: -0.5rem">
            &larr; Cancel
          </button>
          <h1 style="margin-top: 0.5rem">Create New</h1>
        </div>
      </div>
      <div class="card">
        <form id="create-form" onsubmit="handleSubmitCreate(event)">
          <p style="color: #666; margin-bottom: 1rem;">Create a new workflow instance. The instance will start in the initial state.</p>
          <div class="form-actions">
            <button type="submit" class="btn btn-primary">Create</button>
            <button type="button" class="btn btn-secondary" onclick="navigate('/{{.ProjectName}}')">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  `
}

// Admin dashboard
async function renderAdminPage() {
  const app = document.getElementById('app')
  app.innerHTML = `
    <div class="page">
      <div class="page-header">
        <h1>Admin Dashboard</h1>
      </div>
      <div id="admin-stats" class="card">
        <div class="loading">Loading statistics...</div>
      </div>
      <div id="admin-instances" class="card">
        <div class="card-header">Recent Instances</div>
        <div class="loading">Loading...</div>
      </div>
    </div>
  `

  try {
    const [stats, instancesResult] = await Promise.all([
      fetch(`${API_BASE}/admin/stats`, { headers: getHeaders() }).then(r => r.json()).catch(() => null),
      api.listInstances()
    ])

    if (stats) {
      document.getElementById('admin-stats').innerHTML = `
        <div class="card-header">Statistics</div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
          <div>
            <div style="font-size: 2rem; font-weight: 600;">${stats.total_streams || 0}</div>
            <div style="color: #666;">Total Instances</div>
          </div>
          <div>
            <div style="font-size: 2rem; font-weight: 600;">${stats.total_events || 0}</div>
            <div style="color: #666;">Total Events</div>
          </div>
        </div>
      `
    } else {
      document.getElementById('admin-stats').innerHTML = ''
    }

    instances = instancesResult.instances || []
    const container = document.getElementById('admin-instances').querySelector('.loading')
    if (container) {
      container.outerHTML = instances.length > 0
        ? `<table class="table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Status</th>
                <th>Version</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${instances.slice(0, 20).map(inst => {
                const status = getStatus(inst.state || inst.places)
                return `
                  <tr>
                    <td><code>${inst.id}</code></td>
                    <td>${formatStatus(status)}</td>
                    <td>${inst.version || 0}</td>
                    <td><button class="btn btn-sm btn-link" onclick="navigate('/{{.ProjectName}}/${inst.id}')">View</button></td>
                  </tr>
                `
              }).join('')}
            </tbody>
          </table>`
        : '<p style="color: #666; padding: 1rem;">No instances yet.</p>'
    }
  } catch (err) {
    showError('Failed to load admin data: ' + err.message)
  }
}

// ============================================================================
// Event Handlers
// ============================================================================

window.navigate = navigate

window.handleCreateNew = async function() {
  navigate('/{{.ProjectName}}/new')
}

window.handleSubmitCreate = async function(event) {
  event.preventDefault()
  try {
    const result = await api.createInstance({})
    showSuccess('Instance created successfully!')
    navigate(`/{{.ProjectName}}/${result.aggregate_id || result.id}`)
  } catch (err) {
    showError('Failed to create: ' + err.message)
  }
}

window.handleTransition = async function(transitionId) {
  if (!currentInstance) return

  try {
    const result = await api.executeTransition(transitionId, currentInstance.id)
    currentInstance = {
      ...currentInstance,
      version: result.version,
      state: result.state,
      places: result.state,
      enabled: result.enabled || [],
    }
    renderInstanceDetail()
    showSuccess(`Action "${transitionId}" completed!`)
  } catch (err) {
    showError(`Failed to execute ${transitionId}: ${err.message}`)
  }
}

// ============================================================================
// Routing
// ============================================================================

function handleRouteChange(event) {
  const route = event.detail?.route || getCurrentRoute()
  if (!route) {
    renderListPage()
    return
  }

  const path = route.path
  if (path === '/{{.ProjectName}}' || path === '/') {
    renderListPage()
  } else if (path === '/{{.ProjectName}}/new') {
    renderFormPage()
  } else if (path === '/{{.ProjectName}}/:id') {
    renderDetailPage()
  } else if (path === '/admin' || path.startsWith('/admin')) {
    renderAdminPage()
  } else {
    renderListPage()
  }
}

// ============================================================================
// OAuth Callback Handler
// ============================================================================

async function handleOAuthCallback() {
  const params = new URLSearchParams(window.location.search)
  const token = params.get('token')
  const expiresAt = params.get('expires_at')

  if (token) {
    authToken = token
    try {
      const user = await api.getMe()
      saveAuth({ token, expires_at: expiresAt, user })
      window.history.replaceState({}, '', window.location.pathname)
      await refreshNavigation()
    } catch (err) {
      clearAuth()
      showError('Failed to complete login')
    }
  }
}

// ============================================================================
// Initialize
// ============================================================================

async function init() {
  // Load auth state
  loadAuth()

  // Handle OAuth callback
  await handleOAuthCallback()

  // Load view definitions
  await loadViews()

  // Render navigation
  const nav = document.getElementById('nav')
  nav.innerHTML = await createNavigation()

  // Setup routing
  window.addEventListener('route-change', handleRouteChange)
  initRouter()

  // Initial render
  handleRouteChange({ detail: { route: getCurrentRoute() } })
}

{{if .HasDebug}}
// ============================================================================
// Debug WebSocket Client
// ============================================================================

let debugWs = null
let debugSessionId = null

function initDebugWebSocket() {
  const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:'
  const wsUrl = `${wsProtocol}//${window.location.host}/ws`

  debugWs = new WebSocket(wsUrl)

  debugWs.onopen = () => {
    console.log('[Debug] WebSocket connected')
  }

  debugWs.onmessage = (event) => {
    try {
      const msg = JSON.parse(event.data)

      if (msg.id === 'session' && msg.type === 'session') {
        // Data is already parsed from JSON
        const data = typeof msg.data === 'string' ? JSON.parse(msg.data) : msg.data
        debugSessionId = data.session_id
        console.log('[Debug] Session ID:', debugSessionId)
      } else if (msg.type === 'eval') {
        handleDebugEval(msg)
      }
    } catch (e) {
      console.error('[Debug] Failed to parse message:', e)
    }
  }

  debugWs.onclose = () => {
    console.log('[Debug] WebSocket disconnected, reconnecting in 3s...')
    debugSessionId = null
    setTimeout(initDebugWebSocket, 3000)
  }

  debugWs.onerror = (err) => {
    console.error('[Debug] WebSocket error:', err)
  }
}

async function handleDebugEval(msg) {
  try {
    // Data may be parsed object or string
    const data = typeof msg.data === 'string' ? JSON.parse(msg.data) : msg.data
    const code = data.code

    // Execute the code using Function constructor
    const fn = new Function('return (async () => { ' + code + ' })()')
    const result = await fn()

    // Send response back - data should be an object, not a string
    const response = {
      type: 'response',
      id: msg.id,
      data: {
        result: result,
        type: typeof result
      }
    }
    debugWs.send(JSON.stringify(response))
  } catch (e) {
    // Send error response
    const response = {
      type: 'response',
      id: msg.id,
      data: {
        error: e.message
      }
    }
    debugWs.send(JSON.stringify(response))
  }
}

// Export debug functions for external use
window.debugSessionId = () => debugSessionId
window.debugWs = () => debugWs
{{end}}

// Start the app
init()
{{if .HasDebug}}

// Initialize debug WebSocket after app init
initDebugWebSocket()
{{end}}
