// Generated by petri-pilot. DO NOT EDIT.

/**
 * Debug Wallet Module for {{.ModelName}}
 * Provides MetaMask-like behavior for testing without actual blockchain
 */

// API base path for when service is mounted at a prefix
const API_BASE = window.API_BASE || ''

// ============================================================================
// Wallet Configuration
// ============================================================================

const WALLET_ACCOUNTS = [
{{- range .Wallet.Accounts}}
  {
    address: '{{.Address}}',
    name: '{{if .Name}}{{.Name}}{{else}}{{.Address}}{{end}}',
    roles: {{.RolesJSON}},
    initialBalance: '{{.InitialBalance}}',
  },
{{- end}}
]

const BALANCE_FIELD = '{{.Wallet.BalanceField}}'
const AUTO_CONNECT = {{.Wallet.AutoConnect}}
const SHOW_IN_NAV = {{.Wallet.ShowInNav}}

// ============================================================================
// Wallet State
// ============================================================================

let connectedAccount = null
let accountIndex = -1
const listeners = {
  connect: [],
  disconnect: [],
  accountChanged: [],
}

// ============================================================================
// Event System
// ============================================================================

function emit(event, data) {
  if (listeners[event]) {
    listeners[event].forEach(cb => cb(data))
  }
}

export function on(event, callback) {
  if (listeners[event]) {
    listeners[event].push(callback)
  }
}

export function off(event, callback) {
  if (listeners[event]) {
    listeners[event] = listeners[event].filter(cb => cb !== callback)
  }
}

// ============================================================================
// Connection Functions
// ============================================================================

/**
 * Connect to a wallet account by index
 */
export async function connect(index = 0) {
  if (index < 0 || index >= WALLET_ACCOUNTS.length) {
    throw new Error(`Invalid account index: ${index}`)
  }

  const account = WALLET_ACCOUNTS[index]
  connectedAccount = account
  accountIndex = index

  // Login with the account's roles via debug endpoint
  try {
    const response = await fetch(`${API_BASE}/api/debug/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        user_id: account.address,
        login: account.name || account.address,
        roles: account.roles,
      }),
    })

    if (!response.ok) {
      throw new Error('Failed to authenticate wallet')
    }

    const authData = await response.json()

    // Store auth in localStorage
    localStorage.setItem('auth', JSON.stringify(authData))

    // Store wallet connection
    localStorage.setItem('wallet', JSON.stringify({
      accountIndex: index,
      address: account.address,
    }))

    emit('connect', { account, index, authData })

    return { account, index, authData }
  } catch (err) {
    connectedAccount = null
    accountIndex = -1
    throw err
  }
}

/**
 * Disconnect the current wallet
 */
export async function disconnect() {
  const wasConnected = connectedAccount

  connectedAccount = null
  accountIndex = -1

  // Clear auth
  localStorage.removeItem('auth')
  localStorage.removeItem('wallet')

  // Logout from server
  try {
    await fetch(`${API_BASE}/auth/logout`, { method: 'POST' })
  } catch (e) {
    // Ignore logout errors
  }

  if (wasConnected) {
    emit('disconnect', { account: wasConnected })
  }
}

/**
 * Switch to a different account
 */
export async function switchAccount(index) {
  if (index === accountIndex) return getAccount()

  await disconnect()
  return connect(index)
}

/**
 * Restore wallet connection from localStorage
 */
export async function restore() {
  const stored = localStorage.getItem('wallet')
  if (stored) {
    try {
      const { accountIndex: idx } = JSON.parse(stored)
      if (idx >= 0 && idx < WALLET_ACCOUNTS.length) {
        return connect(idx)
      }
    } catch (e) {
      localStorage.removeItem('wallet')
    }
  }
  return null
}

// ============================================================================
// Getters
// ============================================================================

export function isConnected() {
  return connectedAccount !== null
}

export function getAccount() {
  return connectedAccount
}

export function getAddress() {
  return connectedAccount?.address || null
}

export function getAccountIndex() {
  return accountIndex
}

export function getAccounts() {
  return WALLET_ACCOUNTS
}

export function getAccountRoles() {
  return connectedAccount?.roles || []
}

/**
 * Get balance for an address from the current instance state
 */
export function getBalance(address, state) {
  if (!state || !BALANCE_FIELD) return null

  const balances = state[BALANCE_FIELD]
  if (!balances || typeof balances !== 'object') return null

  return balances[address] || 0
}

/**
 * Get the connected account's balance
 */
export function getMyBalance(state) {
  if (!connectedAccount) return null
  return getBalance(connectedAccount.address, state)
}

// ============================================================================
// Wallet UI Components
// ============================================================================

/**
 * Create wallet status HTML for navigation bar
 */
export function createWalletStatus(state) {
  if (!SHOW_IN_NAV) return ''

  if (!connectedAccount) {
    return `
      <div class="wallet-status disconnected">
        <span class="wallet-dot"></span>
        <span class="wallet-text">Not Connected</span>
        <button onclick="window.showWalletModal()" class="btn btn-primary btn-sm">Connect</button>
      </div>
    `
  }

  const balance = getMyBalance(state)
  const displayBalance = balance !== null ? formatBalance(balance) : '...'

  return `
    <div class="wallet-status connected">
      <span class="wallet-dot connected"></span>
      <span class="wallet-address" title="${connectedAccount.address}">
        ${formatAddress(connectedAccount.address)}
      </span>
      {{if .Unit}}<span class="wallet-balance">${displayBalance} {{.Unit}}</span>{{end}}
      <button onclick="window.toggleDebugWalletView()" class="btn btn-link btn-sm" title="Show all accounts">Debug</button>
      <button onclick="window.showWalletModal()" class="btn btn-link btn-sm">Switch</button>
      <button onclick="window.disconnectWallet()" class="btn btn-link btn-sm">Disconnect</button>
    </div>
  `
}

/**
 * Create wallet selector modal HTML
 */
export function createWalletModal() {
  const accountButtons = WALLET_ACCOUNTS.map((acc, idx) => {
    const isActive = idx === accountIndex
    return `
      <div class="wallet-account-row">
        <button
          onclick="window.connectWalletAccount(${idx})"
          class="wallet-account-btn ${isActive ? 'active' : ''}"
        >
          <div class="wallet-account-info">
            <span class="wallet-account-name">${acc.name || 'Account ' + idx}</span>
            <span class="wallet-account-address">${formatAddress(acc.address)}</span>
          </div>
          <div class="wallet-account-roles">
            ${acc.roles.map(r => `<span class="role-badge">${r}</span>`).join('')}
          </div>
          ${isActive ? '<span class="wallet-account-active">Connected</span>' : ''}
        </button>
        <button
          onclick="window.copyAddress('${acc.address}')"
          class="copy-btn"
          title="Copy full address"
        >
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
          </svg>
        </button>
      </div>
    `
  }).join('')

  return `
    <div id="wallet-modal" class="modal" style="display: none;">
      <div class="modal-backdrop" onclick="window.hideWalletModal()"></div>
      <div class="modal-content">
        <div class="modal-header">
          <h3>Select Account</h3>
          <button onclick="window.hideWalletModal()" class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <p>Choose an account to connect:</p>
          <div class="wallet-account-list">
            ${accountButtons}
          </div>
        </div>
      </div>
    </div>
    <style>
      .wallet-status {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      .wallet-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #f59e0b;
      }
      .wallet-dot.connected {
        background: #10b981;
      }
      .wallet-address {
        font-family: monospace;
        font-size: 0.85rem;
        color: rgba(255,255,255,0.9);
      }
      .wallet-balance {
        font-weight: 600;
        color: #10b981;
      }
      .wallet-account-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }
      .wallet-account-row {
        display: flex;
        gap: 0.5rem;
        align-items: stretch;
      }
      .wallet-account-btn {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1rem;
        border: 1px solid #ddd;
        border-radius: 6px;
        background: #f9f9f9;
        cursor: pointer;
        transition: all 0.2s;
        text-align: left;
        flex: 1;
      }
      .wallet-account-btn:hover {
        background: #e5e5e5;
        border-color: #007bff;
      }
      .wallet-account-btn.active {
        background: #e3f2fd;
        border-color: #007bff;
      }
      .copy-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0.5rem;
        border: 1px solid #ddd;
        border-radius: 6px;
        background: #f9f9f9;
        cursor: pointer;
        transition: all 0.2s;
        color: #666;
      }
      .copy-btn:hover {
        background: #e5e5e5;
        border-color: #007bff;
        color: #007bff;
      }
      .copy-btn.copied {
        background: #d4edda;
        border-color: #28a745;
        color: #28a745;
      }
      .wallet-account-info {
        display: flex;
        flex-direction: column;
      }
      .wallet-account-name {
        font-weight: 600;
      }
      .wallet-account-address {
        font-family: monospace;
        font-size: 0.8rem;
        color: #666;
      }
      .wallet-account-roles {
        display: flex;
        gap: 0.25rem;
      }
      .role-badge {
        padding: 0.125rem 0.5rem;
        background: #e5e5e5;
        border-radius: 4px;
        font-size: 0.75rem;
      }
      .wallet-account-active {
        color: #10b981;
        font-size: 0.8rem;
      }
    </style>
  `
}

// ============================================================================
// Debug Wallet View - Shows all accounts with balances
// ============================================================================

/**
 * Create debug wallet view showing all accounts and their balances
 */
export function createDebugWalletView(state, instanceId = null) {
  const balances = state?.[BALANCE_FIELD] || {}
  const hasInstance = instanceId !== null

  const rows = WALLET_ACCOUNTS.map((acc, idx) => {
    const balance = balances[acc.address] || 0
    const isConnected = idx === accountIndex

    return `
      <tr class="${isConnected ? 'debug-wallet-connected' : ''}">
        <td>
          <div class="debug-wallet-account">
            <span class="debug-wallet-name">${acc.name || 'Account ' + idx}</span>
            ${isConnected ? '<span class="debug-wallet-badge">Connected</span>' : ''}
          </div>
        </td>
        <td class="debug-wallet-address">
          <code>${acc.address}</code>
          <button onclick="window.copyAddress('${acc.address}')" class="copy-btn-small" title="Copy">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
              <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
          </button>
        </td>
        <td class="debug-wallet-roles">
          ${acc.roles.length > 0 ? acc.roles.map(r => `<span class="role-badge">${r}</span>`).join(' ') : '<span class="no-roles">none</span>'}
        </td>
        <td class="debug-wallet-balance">
          <strong>${formatBalance(balance)}</strong>{{if .Unit}} {{.Unit}}{{end}}
        </td>
      </tr>
    `
  }).join('')

  // Calculate totals
  const totalBalance = WALLET_ACCOUNTS.reduce((sum, acc) => sum + (balances[acc.address] || 0), 0)
  const totalSupply = state?.total_supply || 0

  return `
    <div id="debug-wallet-view" class="debug-wallet-view">
      <div class="debug-wallet-header">
        <h3>Debug Wallet ${hasInstance ? `<span class="debug-wallet-instance">Instance: ${instanceId.slice(0, 8)}...</span>` : '<span class="debug-wallet-no-instance">No instance selected</span>'}</h3>
        <div class="debug-wallet-controls">
          <button onclick="window.toggleDebugWalletFullscreen()" class="debug-wallet-btn" title="Toggle fullscreen">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>
            </svg>
          </button>
          <button onclick="window.hideDebugWalletView()" class="debug-wallet-btn" title="Close">&times;</button>
        </div>
      </div>
      ${!hasInstance ? '<div class="debug-wallet-warning">Navigate to an instance to see balances</div>' : ''}
      <div class="debug-wallet-body">
        <table class="debug-wallet-table">
          <thead>
            <tr>
              <th>Account</th>
              <th>Address</th>
              <th>Roles</th>
              <th>Balance</th>
            </tr>
          </thead>
          <tbody>
            ${rows}
          </tbody>
          <tfoot>
            <tr>
              <td colspan="3"><strong>Total Balances</strong></td>
              <td class="debug-wallet-balance"><strong>${formatBalance(totalBalance)}</strong>{{if .Unit}} {{.Unit}}{{end}}</td>
            </tr>
            <tr>
              <td colspan="3"><strong>Total Supply</strong></td>
              <td class="debug-wallet-balance"><strong>${formatBalance(totalSupply)}</strong>{{if .Unit}} {{.Unit}}{{end}}</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
    <style>
      .debug-wallet-view {
        position: fixed;
        bottom: 1rem;
        right: 1rem;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        z-index: 1000;
        min-width: 400px;
        min-height: 200px;
        width: 650px;
        max-width: 90vw;
        max-height: 80vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        resize: both;
        overflow: auto;
      }
      .debug-wallet-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1rem;
        background: #24292e;
        color: white;
        cursor: move;
        user-select: none;
      }
      .debug-wallet-header h3 {
        margin: 0;
        font-size: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: rgba(255,255,255,0.15);
        padding: 0.25rem 0.75rem;
        border-radius: 6px;
      }
      .debug-wallet-instance {
        font-size: 0.8rem;
        font-weight: normal;
        color: #10b981;
        font-family: monospace;
      }
      .debug-wallet-no-instance {
        font-size: 0.8rem;
        font-weight: normal;
        color: #f59e0b;
      }
      .debug-wallet-warning {
        padding: 0.5rem 1rem;
        background: #fef3cd;
        color: #856404;
        font-size: 0.85rem;
      }
      .debug-wallet-controls {
        display: flex;
        gap: 0.25rem;
      }
      .debug-wallet-btn {
        background: transparent;
        border: none;
        color: rgba(255,255,255,0.7);
        cursor: pointer;
        padding: 0.25rem 0.5rem;
        font-size: 1.25rem;
        line-height: 1;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .debug-wallet-btn:hover {
        background: rgba(255,255,255,0.1);
        color: white;
      }
      .debug-wallet-view.fullscreen {
        top: 1rem !important;
        left: 1rem !important;
        right: 1rem !important;
        bottom: 1rem !important;
        width: auto !important;
        height: auto !important;
        max-width: none;
        max-height: none;
      }
      .debug-wallet-body {
        padding: 1rem;
        overflow: auto;
      }
      .debug-wallet-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
        table-layout: fixed;
      }
      .debug-wallet-table th {
        text-align: left;
        padding: 0.5rem;
        border-bottom: 2px solid #ddd;
        font-weight: 600;
        color: #555;
      }
      .debug-wallet-table th:nth-child(1) { width: 20%; }
      .debug-wallet-table th:nth-child(2) { width: 40%; }
      .debug-wallet-table th:nth-child(3) { width: 18%; }
      .debug-wallet-table th:nth-child(4) { width: 22%; }
      .debug-wallet-address {
        overflow: hidden;
      }
      .debug-wallet-address code {
        display: inline-block;
        max-width: calc(100% - 30px);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        vertical-align: middle;
        background: #f5f5f5;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
      }
      .debug-wallet-table td {
        padding: 0.5rem;
        border-bottom: 1px solid #eee;
        vertical-align: middle;
      }
      .debug-wallet-table tfoot td {
        border-top: 2px solid #ddd;
        border-bottom: none;
        background: #f9f9f9;
      }
      .debug-wallet-connected {
        background: #e8f5e9;
      }
      .debug-wallet-account {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      .debug-wallet-name {
        font-weight: 500;
      }
      .debug-wallet-badge {
        font-size: 0.7rem;
        padding: 0.125rem 0.375rem;
        background: #10b981;
        color: white;
        border-radius: 4px;
      }
      .debug-wallet-address {
        font-family: monospace;
        font-size: 0.8rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      .copy-btn-small {
        padding: 0.25rem;
        border: none;
        background: transparent;
        cursor: pointer;
        color: #666;
        display: flex;
        align-items: center;
      }
      .copy-btn-small:hover {
        color: #007bff;
      }
      .debug-wallet-roles {
        display: flex;
        gap: 0.25rem;
        flex-wrap: wrap;
      }
      .no-roles {
        color: #999;
        font-style: italic;
      }
      .debug-wallet-balance {
        text-align: right;
        font-family: monospace;
      }
    </style>
  `
}

// ============================================================================
// Utility Functions
// ============================================================================

function formatAddress(address) {
  if (!address) return ''
  if (address.length <= 12) return address
  return address.slice(0, 6) + '...' + address.slice(-4)
}

function formatBalance(amount) {
  if (amount === null || amount === undefined) return '0'
  const num = typeof amount === 'string' ? parseFloat(amount) : amount
  if (num === 0) return '0'
  if (num < 0.0001) return '<0.0001'
  if (num < 1) return num.toFixed(4)
  if (num < 1000) return num.toFixed(2)
  return num.toLocaleString(undefined, { maximumFractionDigits: 2 })
}

// ============================================================================
// Global Window Functions (for onclick handlers)
// ============================================================================

window.showWalletModal = function() {
  const modal = document.getElementById('wallet-modal')
  if (modal) modal.style.display = 'flex'
}

window.hideWalletModal = function() {
  const modal = document.getElementById('wallet-modal')
  if (modal) modal.style.display = 'none'
}

window.connectWalletAccount = async function(index) {
  try {
    await connect(index)
    window.hideWalletModal()
    // Dispatch auth change event to refresh UI
    window.dispatchEvent(new CustomEvent('auth-change'))
  } catch (err) {
    console.error('Wallet connection failed:', err)
    alert('Failed to connect wallet: ' + err.message)
  }
}

window.disconnectWallet = async function() {
  await disconnect()
  window.dispatchEvent(new CustomEvent('auth-change'))
}

window.showDebugWalletView = function() {
  // Get current state and instance info from window (set by main.js)
  const state = window.currentInstanceState || {}
  const instanceId = window.currentInstance?.id || null

  // Remove existing view if present
  const existing = document.getElementById('debug-wallet-container')
  if (existing) existing.remove()

  // Create and append the view
  const container = document.createElement('div')
  container.id = 'debug-wallet-container'
  container.innerHTML = createDebugWalletView(state, instanceId)
  document.body.appendChild(container)

  // Make it draggable
  initDraggable()
}

function initDraggable() {
  const view = document.getElementById('debug-wallet-view')
  const header = view?.querySelector('.debug-wallet-header')
  if (!view || !header) return

  let isDragging = false
  let startX, startY, startLeft, startTop

  header.addEventListener('mousedown', (e) => {
    if (e.target.closest('button')) return // Don't drag when clicking buttons
    isDragging = true
    startX = e.clientX
    startY = e.clientY
    const rect = view.getBoundingClientRect()
    startLeft = rect.left
    startTop = rect.top
    // Switch from bottom/right to top/left positioning
    view.style.bottom = 'auto'
    view.style.right = 'auto'
    view.style.left = startLeft + 'px'
    view.style.top = startTop + 'px'
    e.preventDefault()
  })

  document.addEventListener('mousemove', (e) => {
    if (!isDragging) return
    const dx = e.clientX - startX
    const dy = e.clientY - startY
    view.style.left = (startLeft + dx) + 'px'
    view.style.top = (startTop + dy) + 'px'
  })

  document.addEventListener('mouseup', () => {
    isDragging = false
  })
}

window.hideDebugWalletView = function() {
  const container = document.getElementById('debug-wallet-container')
  if (container) container.remove()
}

window.toggleDebugWalletFullscreen = function() {
  const view = document.getElementById('debug-wallet-view')
  if (view) {
    view.classList.toggle('fullscreen')
  }
}

window.toggleDebugWalletView = function() {
  const existing = document.getElementById('debug-wallet-container')
  if (existing) {
    window.hideDebugWalletView()
  } else {
    window.showDebugWalletView()
  }
}

window.copyAddress = async function(address) {
  try {
    await navigator.clipboard.writeText(address)
    // Find and highlight the button that was clicked
    const buttons = document.querySelectorAll('.copy-btn')
    buttons.forEach(btn => {
      if (btn.onclick?.toString().includes(address)) {
        btn.classList.add('copied')
        setTimeout(() => btn.classList.remove('copied'), 1500)
      }
    })
  } catch (err) {
    // Fallback for older browsers
    const textArea = document.createElement('textarea')
    textArea.value = address
    document.body.appendChild(textArea)
    textArea.select()
    document.execCommand('copy')
    document.body.removeChild(textArea)
  }
}

// ============================================================================
// Auto-initialization
// ============================================================================

// Try to restore wallet connection on load
if (typeof window !== 'undefined') {
  window.addEventListener('DOMContentLoaded', async () => {
    // First try to restore
    const restored = await restore()

    // If not restored and auto-connect is enabled, connect to first account
    if (!restored && AUTO_CONNECT && WALLET_ACCOUNTS.length > 0) {
      try {
        await connect(0)
        window.dispatchEvent(new CustomEvent('auth-change'))
      } catch (err) {
        console.error('Auto-connect failed:', err)
      }
    }
  })
}

// Export for global access
export default {
  connect,
  disconnect,
  switchAccount,
  restore,
  isConnected,
  getAccount,
  getAddress,
  getAccountIndex,
  getAccounts,
  getAccountRoles,
  getBalance,
  getMyBalance,
  createWalletStatus,
  createWalletModal,
  createDebugWalletView,
  on,
  off,
}
