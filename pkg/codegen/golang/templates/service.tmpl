// Code generated by petri-pilot. DO NOT EDIT.

package {{.PackageName}}

import (
{{- if .HasTimers}}
	"context"
{{- end}}
{{- if or .HasBlobstore .HasAnyFeatures}}
	"database/sql"
{{- end}}
	"net/http"

	"github.com/pflow-xyz/go-pflow/eventsource"
	"github.com/pflow-xyz/petri-pilot/pkg/serve"
{{- if or .HasBlobstore .HasAnyFeatures}}
	_ "modernc.org/sqlite"
{{- end}}
)

// ServiceName is the registered name for this service.
const ServiceName = "{{.ModelName}}"

func init() {
	serve.Register(ServiceName, NewService)
}

// Service implements serve.Service for the {{.ModelName}} workflow.
type Service struct {
	store eventsource.Store
	app   *Application

{{- if .HasAccessControl}}
	sessions   SessionStore
	middleware *Middleware
{{- end}}
{{- if .HasNavigation}}
	navigation *Navigation
{{- end}}
{{- if .HasDebug}}
	debugBroker *DebugBroker
{{- end}}
{{- if .HasBlobstore}}
	blobDB    *sql.DB
	blobStore *BlobStore
{{- end}}
{{- if .HasAnyFeatures}}
	featuresDB *sql.DB
{{- end}}
{{- if .HasTimers}}
	timerManager *TimerManager
	timerCancel  context.CancelFunc
{{- end}}
{{- if .HasNotifications}}
	notificationManager *NotificationManager
{{- end}}
{{- if .HasComments}}
	commentStore *CommentStore
{{- end}}
{{- if .HasTags}}
	tagStore *TagStore
{{- end}}
{{- if .HasFavorites}}
	favoriteStore *FavoriteStore
{{- end}}
{{- if .HasActivity}}
	activityStore *ActivityStore
{{- end}}
{{- if .HasExport}}
	exportHandler *ExportHandler
{{- end}}
{{- if .HasBatch}}
	batchHandler *BatchHandler
{{- end}}
{{- if .HasInboundWebhooks}}
	webhookHandler *WebhookHandler
{{- end}}
{{- if .HasTemplates}}
	templateStore *TemplateStore
{{- end}}
{{- if .HasIndexes}}
	searchHandler *SearchHandler
{{- end}}
{{- if .HasApprovals}}
	approvalStore *ApprovalStore
{{- end}}
{{- if .HasRelationships}}
	relationshipStore *RelationshipStore
{{- end}}
{{- if .HasDocuments}}
	documentGenerator *DocumentGenerator
{{- end}}
{{- if .HasSoftDelete}}
	softDeleteStore *SoftDeleteStore
{{- end}}
}

// NewService creates a new {{.ModelName}} service instance.
func NewService() (serve.Service, error) {
	svc := &Service{}

	// Initialize event store (in-memory for development)
	svc.store = eventsource.NewMemoryStore()

	// Create application
	svc.app = NewApplication(svc.store)

{{- if .HasAccessControl}}
	// Initialize sessions for authentication
	svc.sessions = NewInMemorySessionStore()

	// Configure access control rules
	accessRules := []*AccessControl{
		{{- range .AccessRules}}
		{
			TransitionID: "{{.TransitionID}}",
			Roles:        []string{ {{- range .Roles}}"{{.}}", {{end}} },
			Guard:        "{{.Guard}}",
		},
		{{- end}}
	}

	// Initialize middleware
	svc.middleware = NewMiddleware(svc.sessions, accessRules)
{{- end}}

{{- if .HasNavigation}}
	// Initialize navigation
	svc.navigation = &Navigation{
		Brand: "{{.Navigation.Brand}}",
		Items: []NavigationItem{
			{{- range .Navigation.Items}}
			{Label: "{{.Label}}", Path: "{{.Path}}", Icon: "{{.Icon}}", Roles: []string{ {{- range .Roles}}"{{.}}",{{end}} }},
			{{- end}}
		},
	}
{{- end}}

{{- if .HasDebug}}
	// Initialize debug broker
	svc.debugBroker = NewDebugBroker()
{{- end}}

{{- if or .HasBlobstore .HasAnyFeatures}}
	var err error
{{- end}}

{{- if .HasBlobstore}}
	// Initialize blobstore
	svc.blobDB, err = sql.Open("sqlite", "blobs.db")
	if err != nil {
		return nil, err
	}

	svc.blobStore = NewBlobStore(svc.blobDB, {{.Blobstore.MaxSize}}, []string{ {{- range .Blobstore.AllowedTypes}}"{{.}}", {{end}} })
	if err := svc.blobStore.InitSchema(); err != nil {
		return nil, err
	}
{{- end}}

{{- if .HasAnyFeatures}}
	// Initialize features database
	svc.featuresDB, err = sql.Open("sqlite", "features.db")
	if err != nil {
		return nil, err
	}
{{- end}}

{{- if .HasTimers}}
	// Initialize timer manager
	svc.timerManager = NewTimerManager(svc.featuresDB, svc.app)
	if err := svc.timerManager.InitSchema(); err != nil {
		return nil, err
	}
	var timerCtx context.Context
	timerCtx, svc.timerCancel = context.WithCancel(context.Background())
	go svc.timerManager.Start(timerCtx)
{{- end}}

{{- if .HasNotifications}}
	// Initialize notification manager
	svc.notificationManager = NewNotificationManager(svc.featuresDB)
	if err := svc.notificationManager.InitSchema(); err != nil {
		return nil, err
	}
{{- end}}

{{- if .HasComments}}
	// Initialize comment store
	svc.commentStore = NewCommentStore(svc.featuresDB)
	if err := svc.commentStore.InitSchema(); err != nil {
		return nil, err
	}
{{- end}}

{{- if .HasTags}}
	// Initialize tag store
	svc.tagStore = NewTagStore(svc.featuresDB)
	if err := svc.tagStore.InitSchema(); err != nil {
		return nil, err
	}
{{- end}}

{{- if .HasFavorites}}
	// Initialize favorite store
	svc.favoriteStore = NewFavoriteStore(svc.featuresDB)
	if err := svc.favoriteStore.InitSchema(); err != nil {
		return nil, err
	}
{{- end}}

{{- if .HasActivity}}
	// Initialize activity store
	svc.activityStore = NewActivityStore(svc.featuresDB)
	if err := svc.activityStore.InitSchema(); err != nil {
		return nil, err
	}
{{- end}}

{{- if .HasExport}}
	// Initialize export handler
	svc.exportHandler = NewExportHandler(svc.featuresDB, svc.app)
{{- end}}

{{- if .HasBatch}}
	// Initialize batch handler
	svc.batchHandler = NewBatchHandler(svc.featuresDB, svc.app)
	if err := svc.batchHandler.InitSchema(); err != nil {
		return nil, err
	}
{{- end}}

{{- if .HasInboundWebhooks}}
	// Initialize webhook handler
	svc.webhookHandler = NewWebhookHandler(svc.featuresDB, svc.app)
	if err := svc.webhookHandler.InitSchema(); err != nil {
		return nil, err
	}
{{- end}}

{{- if .HasTemplates}}
	// Initialize template store
	svc.templateStore = NewTemplateStore(svc.featuresDB, svc.app)
	if err := svc.templateStore.InitSchema(); err != nil {
		return nil, err
	}
{{- end}}

{{- if .HasIndexes}}
	// Initialize search handler
	svc.searchHandler = NewSearchHandler(svc.featuresDB, svc.app)
	if err := svc.searchHandler.InitSchema(); err != nil {
		return nil, err
	}
{{- end}}

{{- if .HasApprovals}}
	// Initialize approval store
	svc.approvalStore = NewApprovalStore(svc.featuresDB, svc.app)
	if err := svc.approvalStore.InitSchema(); err != nil {
		return nil, err
	}
{{- end}}

{{- if .HasRelationships}}
	// Initialize relationship store
	svc.relationshipStore = NewRelationshipStore(svc.featuresDB)
	if err := svc.relationshipStore.InitSchema(); err != nil {
		return nil, err
	}
{{- end}}

{{- if .HasDocuments}}
	// Initialize document generator
	svc.documentGenerator = NewDocumentGenerator(nil)
{{- end}}

{{- if .HasSoftDelete}}
	// Initialize soft delete store
	svc.softDeleteStore = NewSoftDeleteStore(svc.featuresDB, {{if .SoftDelete.RetentionDays}}{{.SoftDelete.RetentionDays}}{{else}}30{{end}})
	if err := svc.softDeleteStore.InitSchema(); err != nil {
		return nil, err
	}
{{- end}}

	return svc, nil
}

// Name returns the service name.
func (s *Service) Name() string {
	return ServiceName
}

// BuildHandler returns the HTTP handler for this service.
func (s *Service) BuildHandler() http.Handler {
	return BuildRouter(s.app{{if .HasAccessControl}}, s.middleware, s.sessions{{end}}{{if .HasNavigation}}, s.navigation{{end}}{{if .HasDebug}}, s.debugBroker{{end}}{{if .HasBlobstore}}, s.blobStore{{end}}{{if .HasTimers}}, s.timerManager{{end}}{{if .HasNotifications}}, s.notificationManager{{end}}{{if .HasComments}}, s.commentStore{{end}}{{if .HasTags}}, s.tagStore{{end}}{{if .HasFavorites}}, s.favoriteStore{{end}}{{if .HasActivity}}, s.activityStore{{end}}{{if .HasExport}}, s.exportHandler{{end}}{{if .HasBatch}}, s.batchHandler{{end}}{{if .HasInboundWebhooks}}, s.webhookHandler{{end}}{{if .HasTemplates}}, s.templateStore{{end}}{{if .HasIndexes}}, s.searchHandler{{end}}{{if .HasApprovals}}, s.approvalStore{{end}}{{if .HasRelationships}}, s.relationshipStore{{end}}{{if .HasDocuments}}, s.documentGenerator{{end}}{{if .HasSoftDelete}}, s.softDeleteStore{{end}})
}

// Close cleans up resources used by the service.
func (s *Service) Close() error {
{{- if .HasTimers}}
	if s.timerCancel != nil {
		s.timerCancel()
	}
{{- end}}
{{- if .HasBlobstore}}
	if s.blobDB != nil {
		s.blobDB.Close()
	}
{{- end}}
{{- if .HasAnyFeatures}}
	if s.featuresDB != nil {
		s.featuresDB.Close()
	}
{{- end}}
	if s.store != nil {
		return s.store.Close()
	}
	return nil
}
