{{/* README.md template for generated applications */}}
# {{.ModelName}}

{{if .ModelDescription}}{{.ModelDescription}}{{else}}A Petri net-based workflow application generated by [petri-pilot](https://github.com/pflow-xyz/petri-pilot).{{end}}

## Quick Start

```bash
# Build and run
go build -o server .
./server

# Server starts on http://localhost:8080
```

## Architecture

This application uses **event sourcing** with a **Petri net** state machine to model workflows. All state changes are captured as immutable events, enabling:

- Full audit trail of all transitions
- Time-travel debugging
- Event replay for recovery
- Deterministic state reconstruction

## State Machine

### Places (States)

| Place | Type | Initial | Description |
|-------|------|---------|-------------|
{{range .Places -}}
| `{{.ID}}` | {{if .IsData}}Data{{else}}Token{{end}} | {{.Initial}} | {{if .Description}}{{.Description}}{{else}}-{{end}} |
{{end}}

### Transitions (Actions)

| Transition | Event | Guard | Description |
|------------|-------|-------|-------------|
{{range .Transitions -}}
| `{{.ID}}` | `{{.EventType}}` | {{if .Guard}}`{{.Guard}}`{{else}}-{{end}} | {{if .Description}}{{.Description}}{{else}}-{{end}} |
{{end}}

### Petri Net Diagram

```mermaid
stateDiagram-v2
    direction LR
{{range .Places}}
    state "{{.ID}}{{if gt .Initial 0}} ({{.Initial}}){{end}}" as {{.ConstName}}
{{- end}}

{{range .Transitions}}
    state "{{.ID}}" as t_{{.ConstName}} <<choice>>
{{- end}}

{{range $t := .Transitions}}
{{- range $t.Inputs}}
    {{.ConstName}} --> t_{{$t.ConstName}}: {{if gt .Weight 1}}{{.Weight}}{{end}}
{{- end}}
{{- range $t.Outputs}}
    t_{{$t.ConstName}} --> {{.ConstName}}: {{if gt .Weight 1}}{{.Weight}}{{end}}
{{- end}}
{{end}}
```

### Workflow Diagram

```mermaid
flowchart TD
    subgraph Places
{{- range .Places}}
        {{.ConstName}}[("{{.ID}}{{if gt .Initial 0}}<br/>initial: {{.Initial}}{{end}}")]
{{- end}}
    end

    subgraph Transitions
{{- range .Transitions}}
        t_{{.ConstName}}["{{.ID}}"]
{{- end}}
    end

{{range $t := .Transitions}}
{{- range $t.Inputs}}
    {{.ConstName}} -->|{{if gt .Weight 1}}{{.Weight}}{{end}}| t_{{$t.ConstName}}
{{- end}}
{{- range $t.Outputs}}
    t_{{$t.ConstName}} -->|{{if gt .Weight 1}}{{.Weight}}{{end}}| {{.ConstName}}
{{- end}}
{{end}}

    style Places fill:#e1f5fe
    style Transitions fill:#fff3e0
```
{{if .Events}}

## Events

Events are immutable records of state transitions. Each event captures the transition that occurred and any associated data.

| Event Type | Transition | Fields |
|------------|------------|--------|
{{range .Events -}}
| `{{.Type}}` | `{{.TransitionID}}` | {{if .Fields}}{{range $i, $f := .Fields}}{{if $i}}, {{end}}`{{$f.JSONName}}`{{end}}{{else}}-{{end}} |
{{end}}

```mermaid
classDiagram
    class Event {
        +string ID
        +string StreamID
        +string Type
        +int Version
        +time.Time Timestamp
        +json.RawMessage Data
    }

{{range .Events}}
    class {{.StructName}} {
{{- range .Fields}}
        +{{.Type}} {{.Name}}
{{- end}}
    }
    Event <|-- {{.StructName}}
{{end}}
```
{{end}}
{{if .AccessRules}}

## Access Control

Role-based access control (RBAC) restricts which users can execute transitions.

{{if .Roles}}
### Roles

| Role | Description | Inherits |
|------|-------------|----------|
{{range .Roles -}}
| `{{.ID}}` | {{if .Description}}{{.Description}}{{else}}-{{end}} | {{if .Inherits}}{{range $i, $r := .Inherits}}{{if $i}}, {{end}}`{{$r}}`{{end}}{{else}}-{{end}} |
{{end}}
{{end}}

### Permissions

| Transition | Required Roles | Guard |
|------------|----------------|-------|
{{range .AccessRules -}}
| `{{.TransitionID}}` | {{range $i, $r := .Roles}}{{if $i}}, {{end}}`{{$r}}`{{end}} | {{if .HasGuard}}`{{.Guard}}`{{else}}-{{end}} |
{{end}}

```mermaid
graph TD
    subgraph Roles
{{- range .Roles}}
        role_{{.ID}}["{{.ID}}"]
{{- end}}
    end

    subgraph Transitions
{{- range .AccessRules}}
        t_{{.TransitionID}}["{{.TransitionID}}"]
{{- end}}
    end

{{range $rule := .AccessRules}}
{{- range $rule.Roles}}
    role_{{.}} -.->|can execute| t_{{$rule.TransitionID}}
{{- end}}
{{end}}
```
{{end}}

## API Endpoints

### Core Endpoints

| Method | Path | Description |
|--------|------|-------------|
| GET | `/health` | Health check |
| GET | `/ready` | Readiness check |
| POST | `/api/{{.ModelName | lower}}` | Create new instance |
| GET | `/api/{{.ModelName | lower}}/{id}` | Get instance state |
{{if .Navigation -}}
| GET | `/api/navigation` | Get navigation menu |
{{end -}}
{{if .Admin -}}
| GET | `/admin/stats` | Admin statistics |
| GET | `/admin/instances` | List all instances |
| GET | `/admin/instances/{id}` | Get instance detail |
| GET | `/admin/instances/{id}/events` | Get instance events |
{{end}}

### Transition Endpoints

| Method | Path | Transition | Description |
|--------|------|------------|-------------|
{{range .Transitions -}}
| POST | `/api/{{.ID}}` | `{{.ID}}` | {{if .Description}}{{.Description}}{{else}}-{{end}} |
{{end}}

### Request/Response Format

#### Create Instance
```bash
curl -X POST http://localhost:8080/api/{{.ModelName | lower}} \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <token>"
```

#### Execute Transition
```bash
curl -X POST http://localhost:8080/api/<transition> \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <token>" \
  -d '{
    "aggregate_id": "<instance-id>",
    "data": { ... }
  }'
```

#### Response Format
```json
{
  "success": true,
  "aggregate_id": "uuid",
  "version": 1,
  "state": { "place1": 1, "place2": 0 },
  "enabled_transitions": ["transition1", "transition2"]
}
```
{{if .Navigation}}

## Navigation

| Label | Path | Icon | Roles |
|-------|------|------|-------|
{{range .Navigation.Items -}}
| {{.Label}} | `{{.Path}}` | {{if .Icon}}{{.Icon}}{{else}}-{{end}} | {{if .Roles}}{{range $i, $r := .Roles}}{{if $i}}, {{end}}`{{$r}}`{{end}}{{else}}*{{end}} |
{{end}}
{{end}}
{{if .Indexes}}

## Indexes

| Name | Type | Fields |
|------|------|--------|
{{range .Indexes -}}
| `{{.ID}}` | {{.Type}} | {{range $i, $f := .Fields}}{{if $i}}, {{end}}`{{$f}}`{{end}} |
{{end}}
{{end}}

## Configuration

### Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `PORT` | `8080` | HTTP server port |
| `DB_PATH` | `./{{.ModelName | lower}}.db` | SQLite database path |
{{if .Debug -}}
| `DEBUG` | `false` | Enable debug endpoints |
{{end}}

## Development

### Project Structure

```
.
├── main.go           # Application entry point
├── workflow.go       # Petri net definition
├── aggregate.go      # Event-sourced aggregate
├── events.go         # Event type definitions
├── api.go            # HTTP handlers
{{if .AccessRules -}}
├── auth.go           # Authentication
├── middleware.go     # HTTP middleware
├── permissions.go    # Permission checks
{{end -}}
{{if .Navigation -}}
├── navigation.go     # Navigation menu
{{end -}}
{{if .Admin -}}
├── admin.go          # Admin handlers
{{end -}}
{{if .Debug -}}
├── debug.go          # Debug handlers
{{end -}}
├── frontend/         # Web UI (ES modules)
│   ├── index.html
│   └── src/
│       ├── main.js
│       ├── router.js
│       └── ...
└── go.mod
```

### Testing

```bash
# Run unit tests
go test ./...

# Run with test coverage
go test -cover ./...
```

---

Generated by [petri-pilot](https://github.com/pflow-xyz/petri-pilot)
