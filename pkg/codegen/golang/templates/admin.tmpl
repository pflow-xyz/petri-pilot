// Code generated by petri-pilot. DO NOT EDIT.
package main

import (
	"encoding/json"
	"net/http"
	"strconv"
	"time"
	
	"github.com/go-chi/chi/v5"
)

{{if .Admin}}
{{if .Admin.Enabled}}
// AdminInstance represents an aggregate instance summary for admin view.
type AdminInstance struct {
	ID        string                 `json:"id"`
	Version   int                    `json:"version"`
	State     map[string]int         `json:"state"`
	Metadata  map[string]interface{} `json:"metadata,omitempty"`
	UpdatedAt time.Time              `json:"updated_at"`
}

// AdminStats represents dashboard statistics.
type AdminStats struct {
	TotalInstances int            `json:"total_instances"`
	ByPlace        map[string]int `json:"by_place"`
}

// handleAdminListInstances lists all aggregate instances with pagination and filters.
// GET /admin/instances
func (s *Server) handleAdminListInstances(w http.ResponseWriter, r *http.Request) {
	// Check admin role
	if !s.hasAdminRole(r) {
		http.Error(w, "Forbidden", http.StatusForbidden)
		return
	}
	
	// Parse query parameters
	place := r.URL.Query().Get("place")
	from := r.URL.Query().Get("from")
	to := r.URL.Query().Get("to")
	page := getIntParam(r, "page", 1)
	perPage := getIntParam(r, "per_page", 50)
	
	// Query event store (requires AdminStore interface implementation)
	adminStore, ok := s.store.(interface {
		ListInstances(ctx context.Context, place, from, to string, page, perPage int) ([]eventstore.Instance, int, error)
	})
	if !ok {
		http.Error(w, "Admin operations not supported by event store", http.StatusInternalServerError)
		return
	}
	
	instances, total, err := adminStore.ListInstances(r.Context(), place, from, to, page, perPage)
	if err != nil {
		http.Error(w, err.Error(), http.StatusInternalServerError)
		return
	}
	
	response := map[string]interface{}{
		"instances": instances,
		"total":     total,
		"page":      page,
		"per_page":  perPage,
	}
	
	w.Header().Set("Content-Type", "application/json")
	json.NewEncoder(w).Encode(response)
}

// handleAdminGetInstance returns detailed information about a specific instance.
// GET /admin/instances/:id
func (s *Server) handleAdminGetInstance(w http.ResponseWriter, r *http.Request) {
	if !s.hasAdminRole(r) {
		http.Error(w, "Forbidden", http.StatusForbidden)
		return
	}
	
	id := chi.URLParam(r, "id")
	
	// Load events for this instance
	events, err := s.store.Read(r.Context(), id, 0)
	if err != nil {
		http.Error(w, err.Error(), http.StatusNotFound)
		return
	}
	
	if len(events) == 0 {
		http.Error(w, "Instance not found", http.StatusNotFound)
		return
	}
	
	// Rebuild aggregate state
	agg := &Aggregate{ID: id}
	for _, evt := range events {
		agg.applyEvent(evt)
	}
	
	response := map[string]interface{}{
		"id":       agg.ID,
		"version":  agg.Version,
		"state":    agg.State,
		"metadata": map[string]interface{}{},
	}
	
	w.Header().Set("Content-Type", "application/json")
	json.NewEncoder(w).Encode(response)
}

// handleAdminGetEvents returns the full event history for an instance.
// GET /admin/instances/:id/events
func (s *Server) handleAdminGetEvents(w http.ResponseWriter, r *http.Request) {
	if !s.hasAdminRole(r) {
		http.Error(w, "Forbidden", http.StatusForbidden)
		return
	}
	
	id := chi.URLParam(r, "id")
	from := getIntParam(r, "from", 0)
	
	events, err := s.store.Read(r.Context(), id, from)
	if err != nil {
		http.Error(w, err.Error(), http.StatusInternalServerError)
		return
	}
	
	response := map[string]interface{}{
		"events": events,
	}
	
	w.Header().Set("Content-Type", "application/json")
	json.NewEncoder(w).Encode(response)
}

// handleAdminStats returns dashboard statistics.
// GET /admin/stats
func (s *Server) handleAdminStats(w http.ResponseWriter, r *http.Request) {
	if !s.hasAdminRole(r) {
		http.Error(w, "Forbidden", http.StatusForbidden)
		return
	}
	
	adminStore, ok := s.store.(interface {
		GetStats(ctx context.Context) (*eventstore.Stats, error)
	})
	if !ok {
		http.Error(w, "Admin operations not supported by event store", http.StatusInternalServerError)
		return
	}
	
	stats, err := adminStore.GetStats(r.Context())
	if err != nil {
		http.Error(w, err.Error(), http.StatusInternalServerError)
		return
	}
	
	w.Header().Set("Content-Type", "application/json")
	json.NewEncoder(w).Encode(stats)
}

// hasAdminRole checks if the user has admin role.
func (s *Server) hasAdminRole(r *http.Request) bool {
	user, ok := r.Context().Value("user").(*User)
	if !ok || user == nil {
		return false
	}
	
	{{if .Admin.Roles}}
	adminRoles := map[string]bool{
		{{range .Admin.Roles}}"{{.}}": true,
		{{end}}
	}
	
	for _, role := range user.Roles {
		if adminRoles[role] {
			return true
		}
	}
	{{end}}
	
	return false
}

// getIntParam extracts an integer query parameter with a default value.
func getIntParam(r *http.Request, name string, defaultVal int) int {
	val := r.URL.Query().Get(name)
	if val == "" {
		return defaultVal
	}
	
	intVal, err := strconv.Atoi(val)
	if err != nil {
		return defaultVal
	}
	
	return intVal
}
{{end}}
{{end}}
