// Generated by petri-pilot. DO NOT EDIT.

/**
 * Navigation component for {{.ModelName}} application
 * Provides role-based navigation menu
 */

import { navigate, getCurrentRoute } from './router.js'

// Navigation items
const navItems = [
{{- range .Pages}}
  {{- if not .HideInNav}}
  {
    path: '{{.Path}}',
    title: '{{.Title}}',
    {{- if .Icon}}
    icon: '{{.Icon}}',
    {{- end}}
    {{- if .RequiredRoles}}
    roles: [{{range $i, $role := .RequiredRoles}}{{if $i}}, {{end}}'{{$role}}'{{end}}],
    {{- end}}
  },
  {{- end}}
{{- end}}
]

// Create navigation HTML
export function createNavigation() {
  const user = getCurrentUser()
  const currentPath = window.location.pathname
  
  // Filter nav items by role
  const visibleItems = navItems.filter(item => {
    if (!item.roles || item.roles.length === 0) {
      return true // Public
    }
    if (!user) {
      return false // Requires auth
    }
    return hasAnyRole(user, item.roles)
  })
  
  const html = `
    <nav class="navigation">
      <div class="nav-brand">
        <a href="/" onclick="handleNavClick(event, '/')">
          {{.ModelName}}
        </a>
      </div>
      <ul class="nav-menu">
        ${visibleItems.map(item => `
          <li class="${currentPath === item.path ? 'active' : ''}">
            <a href="${item.path}" onclick="handleNavClick(event, '${item.path}')">
              ${item.icon ? `<span class="icon">${item.icon}</span>` : ''}
              ${item.title}
            </a>
          </li>
        `).join('')}
      </ul>
      <div class="nav-user">
        ${user ? `
          <span class="user-name">${user.login || user.name}</span>
          <button onclick="handleLogout()" class="btn btn-link">Logout</button>
        ` : `
          <a href="/auth/login" class="btn btn-primary">Login</a>
        `}
      </div>
    </nav>
  `
  
  return html
}

// Handle navigation clicks
window.handleNavClick = function(event, path) {
  event.preventDefault()
  navigate(path)
}

// Handle logout
window.handleLogout = async function() {
  try {
    await fetch('/auth/logout', {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${getAuthToken()}` }
    })
  } catch (e) {
    console.error('Logout error:', e)
  }
  
  // Clear local auth
  localStorage.removeItem('auth')
  
  // Redirect to home
  navigate('/')
}

// Helper functions
function getCurrentUser() {
  const auth = localStorage.getItem('auth')
  if (auth) {
    try {
      return JSON.parse(auth).user
    } catch (e) {
      return null
    }
  }
  return null
}

function getAuthToken() {
  const auth = localStorage.getItem('auth')
  if (auth) {
    try {
      return JSON.parse(auth).token
    } catch (e) {
      return null
    }
  }
  return null
}

function hasAnyRole(user, roles) {
  if (!user.roles) {
    return false
  }
  return roles.some(role => user.roles.includes(role))
}

// Update navigation when auth changes
window.addEventListener('auth-change', () => {
  const navElement = document.querySelector('.navigation')
  if (navElement) {
    navElement.outerHTML = createNavigation()
  }
})

// Update active state when route changes
window.addEventListener('route-change', () => {
  const currentPath = window.location.pathname
  document.querySelectorAll('.nav-menu li').forEach(li => {
    li.classList.remove('active')
  })
  
  const activeLink = document.querySelector(`.nav-menu a[href="${currentPath}"]`)
  if (activeLink) {
    activeLink.parentElement.classList.add('active')
  }
})
