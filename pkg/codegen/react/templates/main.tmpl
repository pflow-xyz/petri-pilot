// Generated by petri-pilot. DO NOT EDIT.

// API client
const API_BASE = ''  // Uses Vite proxy in development

async function handleResponse(response) {
  if (!response.ok) {
    const error = await response.json().catch(() => ({}))
    throw new Error(error.message || response.statusText)
  }
  return response.json()
}

const api = {
  async create() {
    const response = await fetch(`${API_BASE}/api/{{.ProjectName}}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
    })
    return handleResponse(response)
  },

  async getState(id) {
    const response = await fetch(`${API_BASE}/api/{{.ProjectName}}/${id}`)
    return handleResponse(response)
  },

  async executeTransition(transitionId, aggregateId) {
    const response = await fetch(`${API_BASE}/api/{{.ProjectName}}/transitions/${transitionId}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ aggregate_id: aggregateId }),
    })
    return handleResponse(response)
  },
}

// UI state
let currentState = null
let aggregateId = null

// DOM elements
const errorEl = document.getElementById('error')
const aggregateInput = document.getElementById('aggregate-id')
const loadBtn = document.getElementById('load-btn')
const createBtn = document.getElementById('create-btn')
const stateSection = document.getElementById('state-section')
const actionsSection = document.getElementById('actions-section')
const displayId = document.getElementById('display-id')
const displayVersion = document.getElementById('display-version')
const placesGrid = document.getElementById('places-grid')
const enabledList = document.getElementById('enabled-list')
const transitionsGrid = document.getElementById('transitions-grid')

// Transitions metadata
const transitions = [
{{- range .Transitions}}
  { id: '{{.ID}}', name: '{{.DisplayName}}', description: '{{.Description}}' },
{{- end}}
]

// Show/hide error
function showError(message) {
  errorEl.textContent = message
  errorEl.style.display = 'block'
}

function hideError() {
  errorEl.style.display = 'none'
}

// Render current state
function renderState() {
  if (!currentState) {
    stateSection.style.display = 'none'
    actionsSection.style.display = 'none'
    return
  }

  stateSection.style.display = 'block'
  actionsSection.style.display = 'block'

  displayId.textContent = aggregateId
  displayVersion.textContent = currentState.version || 0

  // Render places
  placesGrid.innerHTML = ''
  const places = currentState.places || currentState.marking || {}
  for (const [placeId, tokens] of Object.entries(places)) {
    const placeEl = document.createElement('div')
    placeEl.className = `place ${tokens > 0 ? 'active' : 'inactive'}`
    placeEl.innerHTML = `
      <span class="token-count">${tokens}</span>
      <span>${placeId}</span>
    `
    placesGrid.appendChild(placeEl)
  }

  // Render enabled transitions
  enabledList.innerHTML = ''
  const enabled = currentState.enabled || []
  for (const transitionId of enabled) {
    const tag = document.createElement('span')
    tag.className = 'enabled-tag'
    tag.textContent = transitionId
    enabledList.appendChild(tag)
  }
  if (enabled.length === 0) {
    enabledList.innerHTML = '<span style="color: #666;">No transitions enabled</span>'
  }

  // Render transition cards
  transitionsGrid.innerHTML = ''
  for (const t of transitions) {
    const isEnabled = enabled.includes(t.id)
    const card = document.createElement('div')
    card.className = `transition-card ${isEnabled ? '' : 'disabled'}`
    card.innerHTML = `
      <div class="transition-title">${t.name}</div>
      ${t.description ? `<div class="transition-desc">${t.description}</div>` : ''}
      <button ${isEnabled ? '' : 'disabled'} data-transition="${t.id}">
        Execute
      </button>
    `
    transitionsGrid.appendChild(card)
  }
}

// Load state
async function loadState() {
  hideError()
  const id = aggregateInput.value.trim()
  if (!id) {
    showError('Please enter an aggregate ID')
    return
  }

  try {
    aggregateId = id
    currentState = await api.getState(id)
    renderState()
  } catch (err) {
    showError(`Failed to load: ${err.message}`)
    currentState = null
    renderState()
  }
}

// Create new instance
async function createNew() {
  hideError()
  try {
    const result = await api.create()
    aggregateId = result.aggregate_id || result.id
    aggregateInput.value = aggregateId
    currentState = result.state || result
    renderState()
  } catch (err) {
    showError(`Failed to create: ${err.message}`)
  }
}

// Execute transition
async function executeTransition(transitionId) {
  hideError()
  if (!aggregateId) {
    showError('No aggregate loaded')
    return
  }

  try {
    const result = await api.executeTransition(transitionId, aggregateId)
    currentState = result.state || result
    renderState()
  } catch (err) {
    showError(`Failed to execute ${transitionId}: ${err.message}`)
  }
}

// Event handlers
loadBtn.addEventListener('click', loadState)
createBtn.addEventListener('click', createNew)

aggregateInput.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') loadState()
})

transitionsGrid.addEventListener('click', (e) => {
  const btn = e.target.closest('button[data-transition]')
  if (btn && !btn.disabled) {
    executeTransition(btn.dataset.transition)
  }
})

// Initial render
renderState()
