// Generated by petri-pilot. DO NOT EDIT.

/**
 * View rendering components for {{.ModelName}} application
 * Dynamically renders forms, tables, and detail views from view definitions
 */

// View definitions will be fetched from the API
let viewDefinitions = []

/**
 * Fetch view definitions from the API
 */
export async function loadViews() {
  try {
    const response = await fetch('/api/views')
    if (!response.ok) {
      console.warn('Failed to load view definitions, using defaults')
      return []
    }
    viewDefinitions = await response.json()
    return viewDefinitions
  } catch (err) {
    console.error('Error loading views:', err)
    return []
  }
}

/**
 * Get a view definition by ID
 */
export function getView(viewId) {
  return viewDefinitions.find(v => v.id === viewId)
}

/**
 * Render a form field based on field type
 */
function renderFormField(field, value = '', onChange = null) {
  const fieldId = `field-${field.binding}`
  const fieldValue = value ?? (field.default || '')
  
  // Base attributes
  const attrs = {
    id: fieldId,
    name: field.binding,
    placeholder: field.placeholder || '',
    required: field.required || false,
    disabled: field.readonly || false,
  }

  // Handle different field types
  switch (field.type) {
    case 'textarea':
      return `
        <div class="form-field">
          <label for="${fieldId}">${field.label || field.binding}${field.required ? ' *' : ''}</label>
          ${field.description ? `<p class="field-help">${field.description}</p>` : ''}
          <textarea 
            id="${attrs.id}"
            name="${attrs.name}"
            placeholder="${attrs.placeholder}"
            ${attrs.required ? 'required' : ''}
            ${attrs.disabled ? 'disabled' : ''}
            rows="4"
          >${escapeHtml(fieldValue)}</textarea>
        </div>
      `

    case 'number':
    case 'amount':
      return `
        <div class="form-field">
          <label for="${fieldId}">${field.label || field.binding}${field.required ? ' *' : ''}</label>
          ${field.description ? `<p class="field-help">${field.description}</p>` : ''}
          <input 
            type="number"
            id="${attrs.id}"
            name="${attrs.name}"
            placeholder="${attrs.placeholder}"
            value="${escapeHtml(fieldValue)}"
            ${attrs.required ? 'required' : ''}
            ${attrs.disabled ? 'disabled' : ''}
            ${field.validation?.min !== undefined ? `min="${field.validation.min}"` : ''}
            ${field.validation?.max !== undefined ? `max="${field.validation.max}"` : ''}
          />
        </div>
      `

    case 'email':
      return `
        <div class="form-field">
          <label for="${fieldId}">${field.label || field.binding}${field.required ? ' *' : ''}</label>
          ${field.description ? `<p class="field-help">${field.description}</p>` : ''}
          <input 
            type="email"
            id="${attrs.id}"
            name="${attrs.name}"
            placeholder="${attrs.placeholder}"
            value="${escapeHtml(fieldValue)}"
            ${attrs.required ? 'required' : ''}
            ${attrs.disabled ? 'disabled' : ''}
          />
        </div>
      `

    case 'date':
      return `
        <div class="form-field">
          <label for="${fieldId}">${field.label || field.binding}${field.required ? ' *' : ''}</label>
          ${field.description ? `<p class="field-help">${field.description}</p>` : ''}
          <input 
            type="date"
            id="${attrs.id}"
            name="${attrs.name}"
            value="${escapeHtml(fieldValue)}"
            ${attrs.required ? 'required' : ''}
            ${attrs.disabled ? 'disabled' : ''}
          />
        </div>
      `

    case 'datetime':
      return `
        <div class="form-field">
          <label for="${fieldId}">${field.label || field.binding}${field.required ? ' *' : ''}</label>
          ${field.description ? `<p class="field-help">${field.description}</p>` : ''}
          <input 
            type="datetime-local"
            id="${attrs.id}"
            name="${attrs.name}"
            value="${escapeHtml(fieldValue)}"
            ${attrs.required ? 'required' : ''}
            ${attrs.disabled ? 'disabled' : ''}
          />
        </div>
      `

    case 'select':
      const options = field.options || []
      return `
        <div class="form-field">
          <label for="${fieldId}">${field.label || field.binding}${field.required ? ' *' : ''}</label>
          ${field.description ? `<p class="field-help">${field.description}</p>` : ''}
          <select 
            id="${attrs.id}"
            name="${attrs.name}"
            ${attrs.required ? 'required' : ''}
            ${attrs.disabled ? 'disabled' : ''}
          >
            <option value="">Select...</option>
            ${options.map(opt => `
              <option value="${escapeHtml(opt.value)}" ${opt.value === fieldValue ? 'selected' : ''} ${opt.disabled ? 'disabled' : ''}>
                ${escapeHtml(opt.label)}
              </option>
            `).join('')}
          </select>
        </div>
      `

    case 'checkbox':
      return `
        <div class="form-field form-field-checkbox">
          <label for="${fieldId}">
            <input 
              type="checkbox"
              id="${attrs.id}"
              name="${attrs.name}"
              ${fieldValue ? 'checked' : ''}
              ${attrs.disabled ? 'disabled' : ''}
            />
            ${field.label || field.binding}
          </label>
          ${field.description ? `<p class="field-help">${field.description}</p>` : ''}
        </div>
      `

    case 'password':
      return `
        <div class="form-field">
          <label for="${fieldId}">${field.label || field.binding}${field.required ? ' *' : ''}</label>
          ${field.description ? `<p class="field-help">${field.description}</p>` : ''}
          <input 
            type="password"
            id="${attrs.id}"
            name="${attrs.name}"
            placeholder="${attrs.placeholder}"
            ${attrs.required ? 'required' : ''}
            ${attrs.disabled ? 'disabled' : ''}
          />
        </div>
      `

    case 'text':
    case 'address':
    default:
      return `
        <div class="form-field">
          <label for="${fieldId}">${field.label || field.binding}${field.required ? ' *' : ''}</label>
          ${field.description ? `<p class="field-help">${field.description}</p>` : ''}
          <input 
            type="text"
            id="${attrs.id}"
            name="${attrs.name}"
            placeholder="${attrs.placeholder}"
            value="${escapeHtml(fieldValue)}"
            ${attrs.required ? 'required' : ''}
            ${attrs.disabled ? 'disabled' : ''}
            ${field.validation?.pattern ? `pattern="${escapeHtml(field.validation.pattern)}"` : ''}
          />
        </div>
      `
  }
}

/**
 * Render a view group (section of fields)
 */
function renderViewGroup(group, data = {}) {
  const fields = group.fields || []
  
  return `
    <div class="view-group" data-group-id="${group.id}">
      ${group.name ? `<h3 class="view-group-title">${escapeHtml(group.name)}</h3>` : ''}
      ${group.description ? `<p class="view-group-description">${escapeHtml(group.description)}</p>` : ''}
      <div class="view-group-fields">
        ${fields.map(field => {
          if (field.hidden) return ''
          const value = data[field.binding]
          return renderFormField(field, value)
        }).join('\n')}
      </div>
    </div>
  `
}

/**
 * Render a form view
 */
export function renderFormView(viewId, data = {}, onSubmit = null) {
  const view = getView(viewId)
  if (!view) {
    return `<p class="error">View "${viewId}" not found</p>`
  }

  const groups = view.groups || []
  
  return `
    <form class="view-form" data-view-id="${viewId}">
      ${view.name ? `<h2 class="view-title">${escapeHtml(view.name)}</h2>` : ''}
      ${view.description ? `<p class="view-description">${escapeHtml(view.description)}</p>` : ''}
      
      ${groups.map(group => renderViewGroup(group, data)).join('\n')}
      
      <div class="form-actions">
        <button type="submit" class="btn btn-primary">Submit</button>
        <button type="button" class="btn btn-secondary" onclick="window.history.back()">Cancel</button>
      </div>
    </form>
  `
}

/**
 * Render a detail field (read-only)
 */
function renderDetailField(field, value) {
  if (field.hidden) return ''
  
  let displayValue = value ?? ''
  
  // Format value based on type
  if (field.type === 'date' && displayValue) {
    displayValue = new Date(displayValue).toLocaleDateString()
  } else if (field.type === 'datetime' && displayValue) {
    displayValue = new Date(displayValue).toLocaleString()
  } else if (field.type === 'checkbox') {
    displayValue = displayValue ? 'Yes' : 'No'
  }

  return `
    <div class="detail-field">
      <dt>${escapeHtml(field.label || field.binding)}</dt>
      <dd>${escapeHtml(displayValue)}</dd>
    </div>
  `
}

/**
 * Render a detail view
 */
export function renderDetailView(viewId, data = {}) {
  const view = getView(viewId)
  if (!view) {
    return `<p class="error">View "${viewId}" not found</p>`
  }

  const groups = view.groups || []
  
  return `
    <div class="view-detail" data-view-id="${viewId}">
      ${view.name ? `<h2 class="view-title">${escapeHtml(view.name)}</h2>` : ''}
      ${view.description ? `<p class="view-description">${escapeHtml(view.description)}</p>` : ''}
      
      ${groups.map(group => `
        <div class="view-group">
          ${group.name ? `<h3 class="view-group-title">${escapeHtml(group.name)}</h3>` : ''}
          <dl class="detail-list">
            ${(group.fields || []).map(field => renderDetailField(field, data[field.binding])).join('')}
          </dl>
        </div>
      `).join('\n')}
    </div>
  `
}

/**
 * Render a table view
 */
export function renderTableView(viewId, items = []) {
  const view = getView(viewId)
  if (!view) {
    return `<p class="error">View "${viewId}" not found</p>`
  }

  // Collect all fields from all groups for table columns
  const allFields = []
  for (const group of (view.groups || [])) {
    for (const field of (group.fields || [])) {
      if (!field.hidden) {
        allFields.push(field)
      }
    }
  }

  return `
    <div class="view-table" data-view-id="${viewId}">
      ${view.name ? `<h2 class="view-title">${escapeHtml(view.name)}</h2>` : ''}
      
      <table class="table">
        <thead>
          <tr>
            ${allFields.map(field => `
              <th>${escapeHtml(field.label || field.binding)}</th>
            `).join('')}
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          ${items.length === 0 ? `
            <tr>
              <td colspan="${allFields.length + 1}" class="text-center">No items found</td>
            </tr>
          ` : items.map((item, idx) => `
            <tr data-item-index="${idx}">
              ${allFields.map(field => {
                let value = item[field.binding] ?? ''
                if (field.type === 'date' && value) {
                  value = new Date(value).toLocaleDateString()
                } else if (field.type === 'datetime' && value) {
                  value = new Date(value).toLocaleString()
                }
                return `<td>${escapeHtml(value)}</td>`
              }).join('')}
              <td>
                <button class="btn btn-sm btn-link" data-view-item-id="${escapeHtml(item.id || idx)}">View</button>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `
}

/**
 * Render action buttons for a view
 * @param {string} viewId - The view ID
 * @param {string} aggregateId - The aggregate/entity ID for the actions
 * @param {string[]} enabledTransitions - List of currently enabled transitions
 */
export function renderViewActions(viewId, aggregateId, enabledTransitions = []) {
  const view = getView(viewId)
  if (!view || !view.actions || view.actions.length === 0) {
    return ''
  }

  return `
    <div class="view-actions">
      ${view.actions.map(actionId => {
        const isEnabled = enabledTransitions.includes(actionId)
        return `
          <button 
            class="btn btn-action ${isEnabled ? 'btn-primary' : 'btn-secondary'}"
            data-action="${actionId}"
            data-aggregate-id="${aggregateId}"
            ${!isEnabled ? 'disabled' : ''}
          >
            ${capitalize(actionId.replace(/_/g, ' '))}
          </button>
        `
      }).join('\n')}
    </div>
  `
}

/**
 * Get form data from a rendered form
 */
export function getFormData(formElement) {
  const data = {}
  
  // Iterate over all form elements to handle unchecked checkboxes
  for (const element of formElement.elements) {
    if (!element.name) continue
    
    if (element.type === 'checkbox') {
      data[element.name] = element.checked
    } else if (element.type === 'number') {
      data[element.name] = element.value ? parseFloat(element.value) : null
    } else if (element.type === 'radio') {
      if (element.checked) {
        data[element.name] = element.value
      }
    } else {
      data[element.name] = element.value
    }
  }
  
  return data
}

/**
 * Execute an action (transition)
 * This needs to be called with the appropriate context (aggregateId, data)
 */
export async function executeAction(actionId, aggregateId, data = {}) {
  // Validate actionId to prevent path traversal (alphanumeric and underscore only)
  if (!actionId || typeof actionId !== 'string' || !/^[a-zA-Z0-9_]+$/.test(actionId)) {
    throw new Error('Invalid action ID')
  }
  
  try {
    const response = await fetch(`/api/${encodeURIComponent(actionId)}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        aggregate_id: aggregateId,
        data: data
      })
    })
    
    if (!response.ok) {
      const error = await response.json().catch(() => ({ message: 'Action failed' }))
      throw new Error(error.message || 'Action failed')
    }
    
    return await response.json()
  } catch (err) {
    console.error(`Failed to execute action ${actionId}:`, err)
    throw err
  }
}

// Helper functions
function escapeHtml(text) {
  if (text === null || text === undefined) return ''
  const str = String(text)
  const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  }
  return str.replace(/[&<>"']/g, m => map[m])
}

function capitalize(str) {
  return str.charAt(0).toUpperCase() + str.slice(1)
}
