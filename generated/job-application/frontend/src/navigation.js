// Generated by petri-pilot. DO NOT EDIT.

/**
 * Navigation component for job-application application
 * Provides role-based navigation menu fetched from backend
 */

import { navigate, getCurrentRoute } from './router.js'

// Navigation state
let navigationData = null
let isLoading = false

// Fetch navigation from backend
async function fetchNavigation() {
  if (isLoading) return
  
  isLoading = true
  try {
    const headers = {}
    const token = getAuthToken()
    if (token) {
      headers['Authorization'] = `Bearer ${token}`
    }
    
    const response = await fetch('/api/navigation', { headers })
    if (response.ok) {
      navigationData = await response.json()
    } else {
      console.error('Failed to fetch navigation:', response.statusText)
      // Use fallback empty navigation
      navigationData = { brand: 'job-application', items: [] }
    }
  } catch (error) {
    console.error('Error fetching navigation:', error)
    // Use fallback empty navigation
    navigationData = { brand: 'job-application', items: [] }
  } finally {
    isLoading = false
  }
}

// Create navigation HTML
export async function createNavigation() {
  // Fetch navigation if not already loaded
  if (!navigationData) {
    await fetchNavigation()
  }
  
  const currentPath = window.location.pathname
  const user = getCurrentUser()
  
  // Backend filters items by user roles
  const items = navigationData?.items || []
  
  const html = `
    <nav class="navigation">
      <div class="nav-brand">
        <a href="/" onclick="handleNavClick(event, '/')">
          ${navigationData?.brand || 'job-application'}
        </a>
      </div>
      <ul class="nav-menu">
        ${items.map(item => `
          <li class="${currentPath === item.path ? 'active' : ''}">
            <a href="${item.path}" onclick="handleNavClick(event, '${item.path}')">
              ${item.icon ? `<span class="icon">${item.icon}</span>` : ''}
              ${item.label}
            </a>
          </li>
        `).join('')}
      </ul>
      <div class="nav-user">
        ${user ? `
          <span class="user-name">${user.login || user.name}</span>
          <button onclick="handleLogout()" class="btn btn-link">Logout</button>
        ` : `
          <a href="/auth/login" class="btn btn-primary">Login</a>
        `}
      </div>
    </nav>
  `
  
  return html
}

// Handle navigation clicks
window.handleNavClick = function(event, path) {
  event.preventDefault()
  navigate(path)
}

// Handle logout
window.handleLogout = async function() {
  try {
    await fetch('/auth/logout', {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${getAuthToken()}` }
    })
  } catch (e) {
    console.error('Logout error:', e)
  }
  
  // Clear local auth
  localStorage.removeItem('auth')
  
  // Clear navigation cache to refetch with new user context
  navigationData = null
  
  // Redirect to home
  navigate('/')
}

// Helper functions
function getCurrentUser() {
  const auth = localStorage.getItem('auth')
  if (auth) {
    try {
      return JSON.parse(auth).user
    } catch (e) {
      return null
    }
  }
  return null
}

function getAuthToken() {
  const auth = localStorage.getItem('auth')
  if (auth) {
    try {
      return JSON.parse(auth).token
    } catch (e) {
      return null
    }
  }
  return null
}

function hasAnyRole(user, roles) {
  if (!user.roles) {
    return false
  }
  return roles.some(role => user.roles.includes(role))
}

// Refresh navigation (e.g., after login/logout)
export async function refreshNavigation() {
  navigationData = null
  await fetchNavigation()
  const navElement = document.querySelector('.navigation')
  if (navElement) {
    navElement.outerHTML = await createNavigation()
  }
}

// Update navigation when auth changes
window.addEventListener('auth-change', async () => {
  await refreshNavigation()
})

// Update active state when route changes
window.addEventListener('route-change', () => {
  const currentPath = window.location.pathname
  document.querySelectorAll('.nav-menu li').forEach(li => {
    li.classList.remove('active')
  })
  
  const activeLink = document.querySelector(`.nav-menu a[href="${currentPath}"]`)
  if (activeLink) {
    activeLink.parentElement.classList.add('active')
  }
})
