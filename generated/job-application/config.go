// Code generated by petri-pilot. DO NOT EDIT.

package main

import (
	"fmt"
	"os"
	"strconv"
	"time"
)

// Config holds application configuration loaded from environment variables.
type Config struct {
	// Server settings
	Port            string
	Host            string
	ReadTimeout     time.Duration
	WriteTimeout    time.Duration
	IdleTimeout     time.Duration
	ShutdownTimeout time.Duration

	// Database settings
	DatabaseURL  string
	DatabaseType string // "sqlite", "postgres"

	// GitHub OAuth settings
	GitHubClientID     string
	GitHubClientSecret string
	GitHubCallbackURL  string
	AuthEnabled        bool

	// Application settings
	Environment string // "development", "staging", "production"
	LogLevel    string // "debug", "info", "warn", "error"
	LogFormat   string // "text", "json"
	BaseURL     string // External URL for OAuth callbacks
}

// LoadConfig loads configuration from environment variables with defaults.
func LoadConfig() (*Config, error) {
	cfg := &Config{
		// Server defaults
		Port:            getEnv("PORT", "8080"),
		Host:            getEnv("HOST", "0.0.0.0"),
		ReadTimeout:     getDurationEnv("READ_TIMEOUT", 15*time.Second),
		WriteTimeout:    getDurationEnv("WRITE_TIMEOUT", 15*time.Second),
		IdleTimeout:     getDurationEnv("IDLE_TIMEOUT", 60*time.Second),
		ShutdownTimeout: getDurationEnv("SHUTDOWN_TIMEOUT", 30*time.Second),

		// Database defaults
		DatabaseURL:  getEnv("DATABASE_URL", "file:jobapplication.db?_journal=WAL"),
		DatabaseType: getEnv("DATABASE_TYPE", "sqlite"),

		// GitHub OAuth defaults
		GitHubClientID:     getEnv("GITHUB_CLIENT_ID", ""),
		GitHubClientSecret: getEnv("GITHUB_CLIENT_SECRET", ""),
		BaseURL:            getEnv("BASE_URL", "http://localhost:8080"),
		AuthEnabled:        getBoolEnv("AUTH_ENABLED", false),

		// Application defaults
		Environment: getEnv("ENVIRONMENT", "development"),
		LogLevel:    getEnv("LOG_LEVEL", "info"),
		LogFormat:   getEnv("LOG_FORMAT", "text"),
	}

	// Derive callback URL from base URL
	cfg.GitHubCallbackURL = cfg.BaseURL + "/auth/callback"

	if err := cfg.Validate(); err != nil {
		return nil, err
	}

	return cfg, nil
}

// Validate checks that the configuration is valid.
func (c *Config) Validate() error {
	if c.Port == "" {
		return fmt.Errorf("PORT is required")
	}

	if _, err := strconv.Atoi(c.Port); err != nil {
		return fmt.Errorf("PORT must be a valid integer: %w", err)
	}

	validEnvs := map[string]bool{"development": true, "staging": true, "production": true}
	if !validEnvs[c.Environment] {
		return fmt.Errorf("ENVIRONMENT must be one of: development, staging, production")
	}

	validLogLevels := map[string]bool{"debug": true, "info": true, "warn": true, "error": true}
	if !validLogLevels[c.LogLevel] {
		return fmt.Errorf("LOG_LEVEL must be one of: debug, info, warn, error")
	}

	validLogFormats := map[string]bool{"text": true, "json": true}
	if !validLogFormats[c.LogFormat] {
		return fmt.Errorf("LOG_FORMAT must be one of: text, json")
	}

	validDBTypes := map[string]bool{"sqlite": true, "postgres": true, "memory": true}
	if !validDBTypes[c.DatabaseType] {
		return fmt.Errorf("DATABASE_TYPE must be one of: sqlite, postgres, memory")
	}

	// Validate GitHub OAuth when enabled
	if c.AuthEnabled {
		if c.GitHubClientID == "" {
			return fmt.Errorf("GITHUB_CLIENT_ID is required when AUTH_ENABLED=true")
		}
		if c.GitHubClientSecret == "" {
			return fmt.Errorf("GITHUB_CLIENT_SECRET is required when AUTH_ENABLED=true")
		}
	}

	return nil
}

// Addr returns the server address in host:port format.
func (c *Config) Addr() string {
	return c.Host + ":" + c.Port
}

// IsDevelopment returns true if running in development mode.
func (c *Config) IsDevelopment() bool {
	return c.Environment == "development"
}

// IsProduction returns true if running in production mode.
func (c *Config) IsProduction() bool {
	return c.Environment == "production"
}

// getEnv returns the value of an environment variable or a default.
func getEnv(key, defaultValue string) string {
	if value := os.Getenv(key); value != "" {
		return value
	}
	return defaultValue
}

// getDurationEnv returns a duration from an environment variable or a default.
func getDurationEnv(key string, defaultValue time.Duration) time.Duration {
	if value := os.Getenv(key); value != "" {
		if d, err := time.ParseDuration(value); err == nil {
			return d
		}
	}
	return defaultValue
}

// getBoolEnv returns a boolean from an environment variable or a default.
func getBoolEnv(key string, defaultValue bool) bool {
	if value := os.Getenv(key); value != "" {
		if b, err := strconv.ParseBool(value); err == nil {
			return b
		}
	}
	return defaultValue
}

// getIntEnv returns an integer from an environment variable or a default.
func getIntEnv(key string, defaultValue int) int {
	if value := os.Getenv(key); value != "" {
		if i, err := strconv.Atoi(value); err == nil {
			return i
		}
	}
	return defaultValue
}
