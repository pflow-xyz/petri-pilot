// Generated by petri-pilot. DO NOT EDIT.

/**
 * Router configuration for blog-post application
 * Provides client-side routing with dynamic route matching
 */

// Route definitions
export const routes = [
  {
    path: '/blog-post',
    component: 'BlogPostList',
    title: 'Blog-Post List',
  },
  {
    path: '/blog-post/:id',
    component: 'BlogPostDetail',
    title: 'Blog-Post Detail',
  },
  {
    path: '/blog-post/new',
    component: 'BlogPostForm',
    title: 'New Blog-Post',
  },
  // Admin routes
  {
    path: '/admin',
    component: 'AdminDashboard',
    title: 'Admin Dashboard',
    roles: ['admin'],
  },
  {
    path: '/admin/instances',
    component: 'AdminInstances',
    title: 'Instances',
    roles: ['admin'],
  },
  {
    path: '/admin/instances/:id',
    component: 'AdminInstance',
    title: 'Instance Detail',
    roles: ['admin'],
  },
]

// Current route state
let currentRoute = null
let currentParams = {}

// Route matcher
function matchRoute(path) {
  for (const route of routes) {
    const params = {}
    const pattern = route.path.replace(/:[^/]+/g, '([^/]+)')
    const regex = new RegExp(`^${pattern}$`)
    const match = path.match(regex)
    
    if (match) {
      // Extract params from dynamic segments
      const paramNames = (route.path.match(/:[^/]+/g) || []).map(p => p.slice(1))
      paramNames.forEach((name, i) => {
        params[name] = match[i + 1]
      })
      
      return { route, params }
    }
  }
  return null
}

// Navigate to a path
export function navigate(path, state = {}) {
  const match = matchRoute(path)
  
  if (!match) {
    console.error(`No route found for path: ${path}`)
    return
  }
  
  // Check role requirements
  if (match.route.roles && match.route.roles.length > 0) {
    const user = getCurrentUser()
    if (!user || !hasAnyRole(user, match.route.roles)) {
      console.warn('Access denied:', path)
      navigate('/') // Redirect to home
      return
    }
  }
  
  currentRoute = match.route
  currentParams = match.params
  
  // Update browser history
  window.history.pushState(state, '', path)
  
  // Trigger render
  renderCurrentRoute()
}

// Handle browser back/forward
window.addEventListener('popstate', () => {
  const path = window.location.pathname
  const match = matchRoute(path)
  if (match) {
    currentRoute = match.route
    currentParams = match.params
    renderCurrentRoute()
  }
})

// Get current user from auth
function getCurrentUser() {
  const auth = localStorage.getItem('auth')
  if (auth) {
    try {
      return JSON.parse(auth).user
    } catch (e) {
      return null
    }
  }
  return null
}

// Check if user has any of the required roles
function hasAnyRole(user, roles) {
  if (!user.roles) {
    return false
  }
  return roles.some(role => user.roles.includes(role))
}

// Render the current route
function renderCurrentRoute() {
  const app = document.getElementById('app')
  if (!app) return
  
  if (!currentRoute) {
    app.innerHTML = '<div class="error">Page not found</div>'
    return
  }
  
  // Dispatch custom event for page changes
  window.dispatchEvent(new CustomEvent('route-change', {
    detail: {
      route: currentRoute,
      params: currentParams
    }
  }))
}

// Get current route params
export function getRouteParams() {
  return currentParams
}

// Get current route
export function getCurrentRoute() {
  return currentRoute
}

// Initialize router
export function initRouter() {
  const path = window.location.pathname
  const match = matchRoute(path)
  
  if (match) {
    currentRoute = match.route
    currentParams = match.params
  } else {
    // Default to first route
    if (routes.length > 0) {
      navigate(routes[0].path)
    }
  }
}
