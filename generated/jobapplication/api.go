// Code generated by petri-pilot. DO NOT EDIT.

package jobapplication

import (
	"encoding/base64"
	"encoding/json"
	"io/fs"
	"net/http"
	"os"
	"path/filepath"
	"strconv"
	"strings"

	"github.com/pflow-xyz/petri-pilot/pkg/runtime/api"
)

// BuildRouter creates an HTTP router for the job-application workflow.
func BuildRouter(app *Application, middleware *Middleware, sessions SessionStore, debugBroker *DebugBroker) http.Handler {
	r := api.NewRouter()

	// Apply auth middleware to extract user from token (optional, doesn't require auth)
	r.Use(OptionalAuthMiddleware(sessions))

	// Health check - always returns ok if server is running
	r.GET("/health", "Health check", func(w http.ResponseWriter, r *http.Request) {
		api.JSON(w, http.StatusOK, map[string]string{"status": "ok"})
	})

	// Readiness check - verifies dependencies (database, etc.)
	r.GET("/ready", "Readiness check", HandleReady(app))

	// Create new aggregate
	r.POST("/api/jobapplication", "Create new job-application", HandleCreate(app))

	// Get aggregate state
	r.GET("/api/jobapplication/{id}", "Get job-application state", HandleGetState(app))

	// View definitions
	r.GET("/api/views", "Get view definitions", HandleGetViews())


	// Schema viewer endpoint
	r.GET("/api/schema", "Get model schema", HandleGetSchema())



	// Event replay endpoints
	r.GET("/api/jobapplication/{id}/events", "Get event history", HandleGetEvents(app))
	r.GET("/api/jobapplication/{id}/at/{version}", "Get state at version", HandleGetStateAtVersion(app))
	r.POST("/api/jobapplication/{id}/truncate", "Truncate event history to version", HandleTruncate(app))






	// Debug WebSocket and eval endpoints
	r.GET("/ws", "Debug WebSocket connection", HandleDebugWebSocket(debugBroker))
	r.GET("/api/debug/sessions", "List debug sessions", HandleListSessions(debugBroker))
	r.POST("/api/debug/sessions/{id}/eval", "Evaluate code in browser session", HandleSessionEval(debugBroker))
	// Test login endpoint (only available in debug mode)
	r.POST("/api/debug/login", "Create test session with roles", HandleTestLogin(sessions))

















	// Transition endpoints
	r.Transition("start_screening", "/api/start_screening", "Begin candidate screening", middleware.RequirePermission("start_screening")(HandleStartScreening(app)))
	r.Transition("begin_checks", "/api/begin_checks", "Start parallel phone screen and background check processes", middleware.RequirePermission("begin_checks")(HandleBeginChecks(app)))
	r.Transition("schedule_phone_screen", "/api/schedule_phone_screen", "Schedule phone screen", middleware.RequirePermission("schedule_phone_screen")(HandleSchedulePhoneScreen(app)))
	r.Transition("start_background_check", "/api/start_background_check", "Initiate background check", middleware.RequirePermission("start_background_check")(HandleStartBackgroundCheck(app)))
	r.Transition("complete_phone_screen", "/api/complete_phone_screen", "Complete phone screen", middleware.RequirePermission("complete_phone_screen")(HandleCompletePhoneScreen(app)))
	r.Transition("complete_background_check", "/api/complete_background_check", "Complete background check", middleware.RequirePermission("complete_background_check")(HandleCompleteBackgroundCheck(app)))
	r.Transition("advance_to_interview", "/api/advance_to_interview", "Both checks passed, advance to interview", middleware.RequirePermission("advance_to_interview")(HandleAdvanceToInterview(app)))
	r.Transition("conduct_interview", "/api/conduct_interview", "Conduct interview", middleware.RequirePermission("conduct_interview")(HandleConductInterview(app)))
	r.Transition("extend_offer", "/api/extend_offer", "Extend job offer", middleware.RequirePermission("extend_offer")(HandleExtendOffer(app)))
	r.Transition("accept_offer", "/api/accept_offer", "Candidate accepts offer", middleware.RequirePermission("accept_offer")(HandleAcceptOffer(app)))
	r.Transition("reject_after_screen", "/api/reject_after_screen", "Reject after screening", middleware.RequirePermission("reject_after_screen")(HandleRejectAfterScreen(app)))
	r.Transition("reject_after_interview", "/api/reject_after_interview", "Reject after interview", middleware.RequirePermission("reject_after_interview")(HandleRejectAfterInterview(app)))
	r.Transition("decline_offer", "/api/decline_offer", "Candidate declines offer", middleware.RequirePermission("decline_offer")(HandleDeclineOffer(app)))

	// Serve frontend static files
	r.StaticFiles("/", StaticFileHandler())

	return r.Build()
}

// StaticFileHandler returns an http.Handler that serves static files from frontend/.
// It supports SPA routing by returning index.html for paths that don't match static files.
func StaticFileHandler() http.HandlerFunc {
	// Find frontend directory - try custom frontends first, then generated
	frontendPath := ""
	candidates := []string{
		"frontends/job-application",                    // Custom frontend (top priority)
		"frontend",                                    // Running from service directory
		"generated/jobapplication/frontend",         // Generated frontend from repo root
		filepath.Join("generated", "jobapplication", "frontend"), // Platform-safe
	}

	// Also try relative to executable
	if exe, err := os.Executable(); err == nil {
		exeDir := filepath.Dir(exe)
		candidates = append(candidates,
			filepath.Join(exeDir, "frontends", "job-application"),
			filepath.Join(exeDir, "frontend"),
			filepath.Join(exeDir, "generated", "jobapplication", "frontend"),
		)
	}

	for _, candidate := range candidates {
		if _, err := os.Stat(candidate); err == nil {
			frontendPath = candidate
			break
		}
	}

	return func(w http.ResponseWriter, r *http.Request) {
		// No frontend found
		if frontendPath == "" {
			http.Error(w, "Frontend not found", http.StatusNotFound)
			return
		}

		// Clean the path
		path := strings.TrimPrefix(r.URL.Path, "/")
		if path == "" {
			path = "index.html"
		}

		// Try to serve the file
		fullPath := filepath.Join(frontendPath, path)

		// Check if file exists
		info, err := os.Stat(fullPath)
		if err != nil || info.IsDir() {
			// File doesn't exist, serve index.html for SPA routing
			http.ServeFile(w, r, filepath.Join(frontendPath, "index.html"))
			return
		}

		http.ServeFile(w, r, fullPath)
	}
}

// StaticFS is a helper interface for embedding static files (optional).
type StaticFS interface {
	fs.FS
}

// HandleCreate creates a new aggregate instance.
func HandleCreate(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		id, err := app.Create(ctx)
		if err != nil {
			api.Error(w, http.StatusInternalServerError, "CREATE_FAILED", err.Error())
			return
		}

		// Load the new aggregate to get initial state
		agg, err := app.Load(ctx, id)
		if err != nil {
			api.Error(w, http.StatusInternalServerError, "LOAD_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusCreated, api.StateResponse{
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.State(),
			Places:             agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}

// HandleGetState returns the current state of an aggregate.
func HandleGetState(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()
		id := r.PathValue("id")
		if id == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate ID is required")
			return
		}

		agg, err := app.GetState(ctx, id)
		if err != nil {
			api.Error(w, http.StatusNotFound, "NOT_FOUND", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.StateResponse{
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.State(),
			Places:             agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}

// HandleReady checks if the application is ready to serve requests.
// Returns 200 if all dependencies are available, 503 otherwise.
func HandleReady(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		checks := make(map[string]string)
		ready := true

		// Check event store connectivity
		if err := app.HealthCheck(r.Context()); err != nil {
			checks["eventstore"] = err.Error()
			ready = false
		} else {
			checks["eventstore"] = "ok"
		}

		status := http.StatusOK
		statusText := "ready"
		if !ready {
			status = http.StatusServiceUnavailable
			statusText = "not ready"
		}

		api.JSON(w, status, map[string]any{
			"status": statusText,
			"checks": checks,
		})
	}
}


// HandleStartScreening handles the start_screening transition.
func HandleStartScreening(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionStartScreening, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleBeginChecks handles the begin_checks transition.
func HandleBeginChecks(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionBeginChecks, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleSchedulePhoneScreen handles the schedule_phone_screen transition.
func HandleSchedulePhoneScreen(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionSchedulePhoneScreen, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleStartBackgroundCheck handles the start_background_check transition.
func HandleStartBackgroundCheck(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionStartBackgroundCheck, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleCompletePhoneScreen handles the complete_phone_screen transition.
func HandleCompletePhoneScreen(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionCompletePhoneScreen, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleCompleteBackgroundCheck handles the complete_background_check transition.
func HandleCompleteBackgroundCheck(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionCompleteBackgroundCheck, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleAdvanceToInterview handles the advance_to_interview transition.
func HandleAdvanceToInterview(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionAdvanceToInterview, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleConductInterview handles the conduct_interview transition.
func HandleConductInterview(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionConductInterview, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleExtendOffer handles the extend_offer transition.
func HandleExtendOffer(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionExtendOffer, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleAcceptOffer handles the accept_offer transition.
func HandleAcceptOffer(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionAcceptOffer, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleRejectAfterScreen handles the reject_after_screen transition.
func HandleRejectAfterScreen(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionRejectAfterScreen, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleRejectAfterInterview handles the reject_after_interview transition.
func HandleRejectAfterInterview(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionRejectAfterInterview, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleDeclineOffer handles the decline_offer transition.
func HandleDeclineOffer(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionDeclineOffer, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleGetViews returns the view definitions for the workflow.
func HandleGetViews() http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		data, err := ViewsJSON()
		if err != nil {
			api.Error(w, http.StatusInternalServerError, "VIEWS_ERROR", err.Error())
			return
		}
		w.Header().Set("Content-Type", "application/json")
		w.WriteHeader(http.StatusOK)
		w.Write(data)
	}
}






// HandleGetEvents returns the event history for an aggregate.
func HandleGetEvents(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()
		id := r.PathValue("id")
		from := getIntQueryParam(r, "from", 0)

		events, err := app.store.Read(ctx, id, from)
		if err != nil {
			api.Error(w, http.StatusInternalServerError, "READ_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, map[string]interface{}{
			"events": events,
		})
	}
}

// HandleGetStateAtVersion returns the aggregate state at a specific version.
func HandleGetStateAtVersion(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()
		id := r.PathValue("id")
		versionStr := r.PathValue("version")

		version := getInt(versionStr, 0)
		if version <= 0 {
			api.Error(w, http.StatusBadRequest, "INVALID_VERSION", "version must be a positive integer")
			return
		}

		events, err := app.store.Read(ctx, id, 0)
		if err != nil {
			api.Error(w, http.StatusInternalServerError, "READ_FAILED", err.Error())
			return
		}

		// Create temporary aggregate and replay up to version
		agg := NewAggregate(id)
		for _, evt := range events {
			if evt.Version > version {
				break
			}
			if err := agg.Apply(evt); err != nil {
				api.Error(w, http.StatusInternalServerError, "APPLY_FAILED", err.Error())
				return
			}
		}

		api.JSON(w, http.StatusOK, map[string]interface{}{
			"id":      agg.ID(),
			"version": version,
			"state":   agg.State(),
		})
	}
}

// HandleTruncate truncates the event stream to a specific version.
// This enables "undo and redo differently" workflows by discarding events after the target version.
func HandleTruncate(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()
		id := r.PathValue("id")

		var req struct {
			Version int `json:"version"`
		}
		if err := json.NewDecoder(r.Body).Decode(&req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", "request body must contain version field")
			return
		}

		if req.Version < 0 {
			api.Error(w, http.StatusBadRequest, "INVALID_VERSION", "version must be non-negative")
			return
		}

		agg, err := app.TruncateTo(ctx, id, req.Version)
		if err != nil {
			api.Error(w, http.StatusInternalServerError, "TRUNCATE_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, map[string]interface{}{
			"id":                    agg.ID(),
			"version":               agg.Version(),
			"state":                 agg.State(),
			"enabled_transitions":   agg.EnabledTransitions(),
		})
	}
}





// Helper functions

func getIntQueryParam(r *http.Request, name string, defaultVal int) int {
	val := r.URL.Query().Get(name)
	return getInt(val, defaultVal)
}

func getInt(s string, defaultVal int) int {
	if s == "" {
		return defaultVal
	}

	intVal, err := strconv.Atoi(s)
	if err != nil {
		return defaultVal
	}

	return intVal
}


// HandleGetSchema returns the model schema JSON for the schema viewer.
func HandleGetSchema() http.HandlerFunc {
	// Schema JSON is embedded at generation time (base64 encoded)
	schemaBase64 := "ewogICJuYW1lIjogImpvYi1hcHBsaWNhdGlvbiIsCiAgImRlc2NyaXB0aW9uIjogIkEgam9iIGFwcGxpY2F0aW9uIHdvcmtmbG93OiBhcHBsaWVkIOKGkiBwaG9uZSBzY3JlZW4gQU5EIGJhY2tncm91bmQgY2hlY2sgKHBhcmFsbGVsKSDihpIgaW50ZXJ2aWV3IOKGkiBvZmZlciDihpIgaGlyZWQvcmVqZWN0ZWQiLAogICJwbGFjZXMiOiBbCiAgICB7CiAgICAgICJpZCI6ICJhcHBsaWVkIiwKICAgICAgImRlc2NyaXB0aW9uIjogIkFwcGxpY2F0aW9uIHN1Ym1pdHRlZCIsCiAgICAgICJpbml0aWFsIjogMSwKICAgICAgImtpbmQiOiAidG9rZW4iCiAgICB9LAogICAgewogICAgICAiaWQiOiAic2NyZWVuaW5nIiwKICAgICAgImRlc2NyaXB0aW9uIjogIkluaXRpYWwgc2NyZWVuaW5nIGluIHByb2dyZXNzIiwKICAgICAgImluaXRpYWwiOiAwLAogICAgICAia2luZCI6ICJ0b2tlbiIKICAgIH0sCiAgICB7CiAgICAgICJpZCI6ICJyZWFkeV9mb3JfcGhvbmVfc2NyZWVuIiwKICAgICAgImRlc2NyaXB0aW9uIjogIlJlYWR5IHRvIHNjaGVkdWxlIHBob25lIHNjcmVlbiIsCiAgICAgICJpbml0aWFsIjogMCwKICAgICAgImtpbmQiOiAidG9rZW4iCiAgICB9LAogICAgewogICAgICAiaWQiOiAicmVhZHlfZm9yX2JhY2tncm91bmRfY2hlY2siLAogICAgICAiZGVzY3JpcHRpb24iOiAiUmVhZHkgdG8gc3RhcnQgYmFja2dyb3VuZCBjaGVjayIsCiAgICAgICJpbml0aWFsIjogMCwKICAgICAgImtpbmQiOiAidG9rZW4iCiAgICB9LAogICAgewogICAgICAiaWQiOiAicGhvbmVfc2NyZWVuX3BlbmRpbmciLAogICAgICAiZGVzY3JpcHRpb24iOiAiUGhvbmUgc2NyZWVuIHNjaGVkdWxlZCIsCiAgICAgICJpbml0aWFsIjogMCwKICAgICAgImtpbmQiOiAidG9rZW4iCiAgICB9LAogICAgewogICAgICAiaWQiOiAicGhvbmVfc2NyZWVuX2NvbXBsZXRlIiwKICAgICAgImRlc2NyaXB0aW9uIjogIlBob25lIHNjcmVlbiBjb21wbGV0ZWQiLAogICAgICAiaW5pdGlhbCI6IDAsCiAgICAgICJraW5kIjogInRva2VuIgogICAgfSwKICAgIHsKICAgICAgImlkIjogImJhY2tncm91bmRfY2hlY2tfcGVuZGluZyIsCiAgICAgICJkZXNjcmlwdGlvbiI6ICJCYWNrZ3JvdW5kIGNoZWNrIGluIHByb2dyZXNzIiwKICAgICAgImluaXRpYWwiOiAwLAogICAgICAia2luZCI6ICJ0b2tlbiIKICAgIH0sCiAgICB7CiAgICAgICJpZCI6ICJiYWNrZ3JvdW5kX2NoZWNrX2NvbXBsZXRlIiwKICAgICAgImRlc2NyaXB0aW9uIjogIkJhY2tncm91bmQgY2hlY2sgY29tcGxldGVkIiwKICAgICAgImluaXRpYWwiOiAwLAogICAgICAia2luZCI6ICJ0b2tlbiIKICAgIH0sCiAgICB7CiAgICAgICJpZCI6ICJyZWFkeV9mb3JfaW50ZXJ2aWV3IiwKICAgICAgImRlc2NyaXB0aW9uIjogIkJvdGggc2NyZWVucyBwYXNzZWQsIHJlYWR5IGZvciBpbnRlcnZpZXciLAogICAgICAiaW5pdGlhbCI6IDAsCiAgICAgICJraW5kIjogInRva2VuIgogICAgfSwKICAgIHsKICAgICAgImlkIjogImludGVydmlld2luZyIsCiAgICAgICJkZXNjcmlwdGlvbiI6ICJJbnRlcnZpZXcgcHJvY2VzcyBvbmdvaW5nIiwKICAgICAgImluaXRpYWwiOiAwLAogICAgICAia2luZCI6ICJ0b2tlbiIKICAgIH0sCiAgICB7CiAgICAgICJpZCI6ICJvZmZlcl9leHRlbmRlZCIsCiAgICAgICJkZXNjcmlwdGlvbiI6ICJKb2Igb2ZmZXIgaGFzIGJlZW4gZXh0ZW5kZWQiLAogICAgICAiaW5pdGlhbCI6IDAsCiAgICAgICJraW5kIjogInRva2VuIgogICAgfSwKICAgIHsKICAgICAgImlkIjogImhpcmVkIiwKICAgICAgImRlc2NyaXB0aW9uIjogIkNhbmRpZGF0ZSBoYXMgYmVlbiBoaXJlZCIsCiAgICAgICJpbml0aWFsIjogMCwKICAgICAgImtpbmQiOiAidG9rZW4iCiAgICB9LAogICAgewogICAgICAiaWQiOiAicmVqZWN0ZWQiLAogICAgICAiZGVzY3JpcHRpb24iOiAiQXBwbGljYXRpb24gcmVqZWN0ZWQiLAogICAgICAiaW5pdGlhbCI6IDAsCiAgICAgICJraW5kIjogInRva2VuIgogICAgfQogIF0sCiAgInRyYW5zaXRpb25zIjogWwogICAgewogICAgICAiaWQiOiAic3RhcnRfc2NyZWVuaW5nIiwKICAgICAgImRlc2NyaXB0aW9uIjogIkJlZ2luIGNhbmRpZGF0ZSBzY3JlZW5pbmciLAogICAgICAiaHR0cF9tZXRob2QiOiAiUE9TVCIsCiAgICAgICJodHRwX3BhdGgiOiAiL2FwaS9zdGFydF9zY3JlZW5pbmciLAogICAgICAiZXZlbnRfdHlwZSI6ICJTdGFydFNjcmVlbmluZ2VkIgogICAgfSwKICAgIHsKICAgICAgImlkIjogImJlZ2luX2NoZWNrcyIsCiAgICAgICJkZXNjcmlwdGlvbiI6ICJTdGFydCBwYXJhbGxlbCBwaG9uZSBzY3JlZW4gYW5kIGJhY2tncm91bmQgY2hlY2sgcHJvY2Vzc2VzIiwKICAgICAgImh0dHBfbWV0aG9kIjogIlBPU1QiLAogICAgICAiaHR0cF9wYXRoIjogIi9hcGkvYmVnaW5fY2hlY2tzIiwKICAgICAgImV2ZW50X3R5cGUiOiAiQmVnaW5DaGVja3NlZCIKICAgIH0sCiAgICB7CiAgICAgICJpZCI6ICJzY2hlZHVsZV9waG9uZV9zY3JlZW4iLAogICAgICAiZGVzY3JpcHRpb24iOiAiU2NoZWR1bGUgcGhvbmUgc2NyZWVuIiwKICAgICAgImh0dHBfbWV0aG9kIjogIlBPU1QiLAogICAgICAiaHR0cF9wYXRoIjogIi9hcGkvc2NoZWR1bGVfcGhvbmVfc2NyZWVuIiwKICAgICAgImV2ZW50X3R5cGUiOiAiU2NoZWR1bGVQaG9uZVNjcmVlbmVkIgogICAgfSwKICAgIHsKICAgICAgImlkIjogInN0YXJ0X2JhY2tncm91bmRfY2hlY2siLAogICAgICAiZGVzY3JpcHRpb24iOiAiSW5pdGlhdGUgYmFja2dyb3VuZCBjaGVjayIsCiAgICAgICJodHRwX21ldGhvZCI6ICJQT1NUIiwKICAgICAgImh0dHBfcGF0aCI6ICIvYXBpL3N0YXJ0X2JhY2tncm91bmRfY2hlY2siLAogICAgICAiZXZlbnRfdHlwZSI6ICJTdGFydEJhY2tncm91bmRDaGVja2VkIgogICAgfSwKICAgIHsKICAgICAgImlkIjogImNvbXBsZXRlX3Bob25lX3NjcmVlbiIsCiAgICAgICJkZXNjcmlwdGlvbiI6ICJDb21wbGV0ZSBwaG9uZSBzY3JlZW4iLAogICAgICAiaHR0cF9tZXRob2QiOiAiUE9TVCIsCiAgICAgICJodHRwX3BhdGgiOiAiL2FwaS9jb21wbGV0ZV9waG9uZV9zY3JlZW4iLAogICAgICAiZXZlbnRfdHlwZSI6ICJDb21wbGV0ZVBob25lU2NyZWVuZWQiCiAgICB9LAogICAgewogICAgICAiaWQiOiAiY29tcGxldGVfYmFja2dyb3VuZF9jaGVjayIsCiAgICAgICJkZXNjcmlwdGlvbiI6ICJDb21wbGV0ZSBiYWNrZ3JvdW5kIGNoZWNrIiwKICAgICAgImh0dHBfbWV0aG9kIjogIlBPU1QiLAogICAgICAiaHR0cF9wYXRoIjogIi9hcGkvY29tcGxldGVfYmFja2dyb3VuZF9jaGVjayIsCiAgICAgICJldmVudF90eXBlIjogIkNvbXBsZXRlQmFja2dyb3VuZENoZWNrZWQiCiAgICB9LAogICAgewogICAgICAiaWQiOiAiYWR2YW5jZV90b19pbnRlcnZpZXciLAogICAgICAiZGVzY3JpcHRpb24iOiAiQm90aCBjaGVja3MgcGFzc2VkLCBhZHZhbmNlIHRvIGludGVydmlldyIsCiAgICAgICJodHRwX21ldGhvZCI6ICJQT1NUIiwKICAgICAgImh0dHBfcGF0aCI6ICIvYXBpL2FkdmFuY2VfdG9faW50ZXJ2aWV3IiwKICAgICAgImV2ZW50X3R5cGUiOiAiQWR2YW5jZVRvSW50ZXJ2aWV3ZWQiCiAgICB9LAogICAgewogICAgICAiaWQiOiAiY29uZHVjdF9pbnRlcnZpZXciLAogICAgICAiZGVzY3JpcHRpb24iOiAiQ29uZHVjdCBpbnRlcnZpZXciLAogICAgICAiaHR0cF9tZXRob2QiOiAiUE9TVCIsCiAgICAgICJodHRwX3BhdGgiOiAiL2FwaS9jb25kdWN0X2ludGVydmlldyIsCiAgICAgICJldmVudF90eXBlIjogIkNvbmR1Y3RJbnRlcnZpZXdlZCIKICAgIH0sCiAgICB7CiAgICAgICJpZCI6ICJleHRlbmRfb2ZmZXIiLAogICAgICAiZGVzY3JpcHRpb24iOiAiRXh0ZW5kIGpvYiBvZmZlciIsCiAgICAgICJodHRwX21ldGhvZCI6ICJQT1NUIiwKICAgICAgImh0dHBfcGF0aCI6ICIvYXBpL2V4dGVuZF9vZmZlciIsCiAgICAgICJldmVudF90eXBlIjogIkV4dGVuZE9mZmVyZWQiCiAgICB9LAogICAgewogICAgICAiaWQiOiAiYWNjZXB0X29mZmVyIiwKICAgICAgImRlc2NyaXB0aW9uIjogIkNhbmRpZGF0ZSBhY2NlcHRzIG9mZmVyIiwKICAgICAgImh0dHBfbWV0aG9kIjogIlBPU1QiLAogICAgICAiaHR0cF9wYXRoIjogIi9hcGkvYWNjZXB0X29mZmVyIiwKICAgICAgImV2ZW50X3R5cGUiOiAiQWNjZXB0T2ZmZXJlZCIKICAgIH0sCiAgICB7CiAgICAgICJpZCI6ICJyZWplY3RfYWZ0ZXJfc2NyZWVuIiwKICAgICAgImRlc2NyaXB0aW9uIjogIlJlamVjdCBhZnRlciBzY3JlZW5pbmciLAogICAgICAiaHR0cF9tZXRob2QiOiAiUE9TVCIsCiAgICAgICJodHRwX3BhdGgiOiAiL2FwaS9yZWplY3RfYWZ0ZXJfc2NyZWVuIiwKICAgICAgImV2ZW50X3R5cGUiOiAiUmVqZWN0QWZ0ZXJTY3JlZW5lZCIKICAgIH0sCiAgICB7CiAgICAgICJpZCI6ICJyZWplY3RfYWZ0ZXJfaW50ZXJ2aWV3IiwKICAgICAgImRlc2NyaXB0aW9uIjogIlJlamVjdCBhZnRlciBpbnRlcnZpZXciLAogICAgICAiaHR0cF9tZXRob2QiOiAiUE9TVCIsCiAgICAgICJodHRwX3BhdGgiOiAiL2FwaS9yZWplY3RfYWZ0ZXJfaW50ZXJ2aWV3IiwKICAgICAgImV2ZW50X3R5cGUiOiAiUmVqZWN0QWZ0ZXJJbnRlcnZpZXdlZCIKICAgIH0sCiAgICB7CiAgICAgICJpZCI6ICJkZWNsaW5lX29mZmVyIiwKICAgICAgImRlc2NyaXB0aW9uIjogIkNhbmRpZGF0ZSBkZWNsaW5lcyBvZmZlciIsCiAgICAgICJodHRwX21ldGhvZCI6ICJQT1NUIiwKICAgICAgImh0dHBfcGF0aCI6ICIvYXBpL2RlY2xpbmVfb2ZmZXIiLAogICAgICAiZXZlbnRfdHlwZSI6ICJEZWNsaW5lT2ZmZXJlZCIKICAgIH0KICBdLAogICJhcmNzIjogWwogICAgewogICAgICAiZnJvbSI6ICJhcHBsaWVkIiwKICAgICAgInRvIjogInN0YXJ0X3NjcmVlbmluZyIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogInN0YXJ0X3NjcmVlbmluZyIsCiAgICAgICJ0byI6ICJzY3JlZW5pbmciCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJzY3JlZW5pbmciLAogICAgICAidG8iOiAiYmVnaW5fY2hlY2tzIgogICAgfSwKICAgIHsKICAgICAgImZyb20iOiAiYmVnaW5fY2hlY2tzIiwKICAgICAgInRvIjogInJlYWR5X2Zvcl9waG9uZV9zY3JlZW4iCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJiZWdpbl9jaGVja3MiLAogICAgICAidG8iOiAicmVhZHlfZm9yX2JhY2tncm91bmRfY2hlY2siCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJyZWFkeV9mb3JfcGhvbmVfc2NyZWVuIiwKICAgICAgInRvIjogInNjaGVkdWxlX3Bob25lX3NjcmVlbiIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogInNjaGVkdWxlX3Bob25lX3NjcmVlbiIsCiAgICAgICJ0byI6ICJwaG9uZV9zY3JlZW5fcGVuZGluZyIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogInJlYWR5X2Zvcl9iYWNrZ3JvdW5kX2NoZWNrIiwKICAgICAgInRvIjogInN0YXJ0X2JhY2tncm91bmRfY2hlY2siCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJzdGFydF9iYWNrZ3JvdW5kX2NoZWNrIiwKICAgICAgInRvIjogImJhY2tncm91bmRfY2hlY2tfcGVuZGluZyIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogInBob25lX3NjcmVlbl9wZW5kaW5nIiwKICAgICAgInRvIjogImNvbXBsZXRlX3Bob25lX3NjcmVlbiIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogImNvbXBsZXRlX3Bob25lX3NjcmVlbiIsCiAgICAgICJ0byI6ICJwaG9uZV9zY3JlZW5fY29tcGxldGUiCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJiYWNrZ3JvdW5kX2NoZWNrX3BlbmRpbmciLAogICAgICAidG8iOiAiY29tcGxldGVfYmFja2dyb3VuZF9jaGVjayIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogImNvbXBsZXRlX2JhY2tncm91bmRfY2hlY2siLAogICAgICAidG8iOiAiYmFja2dyb3VuZF9jaGVja19jb21wbGV0ZSIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogInBob25lX3NjcmVlbl9jb21wbGV0ZSIsCiAgICAgICJ0byI6ICJhZHZhbmNlX3RvX2ludGVydmlldyIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogImJhY2tncm91bmRfY2hlY2tfY29tcGxldGUiLAogICAgICAidG8iOiAiYWR2YW5jZV90b19pbnRlcnZpZXciCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJhZHZhbmNlX3RvX2ludGVydmlldyIsCiAgICAgICJ0byI6ICJyZWFkeV9mb3JfaW50ZXJ2aWV3IgogICAgfSwKICAgIHsKICAgICAgImZyb20iOiAicmVhZHlfZm9yX2ludGVydmlldyIsCiAgICAgICJ0byI6ICJjb25kdWN0X2ludGVydmlldyIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogImNvbmR1Y3RfaW50ZXJ2aWV3IiwKICAgICAgInRvIjogImludGVydmlld2luZyIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogImludGVydmlld2luZyIsCiAgICAgICJ0byI6ICJleHRlbmRfb2ZmZXIiCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJleHRlbmRfb2ZmZXIiLAogICAgICAidG8iOiAib2ZmZXJfZXh0ZW5kZWQiCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJvZmZlcl9leHRlbmRlZCIsCiAgICAgICJ0byI6ICJhY2NlcHRfb2ZmZXIiCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJhY2NlcHRfb2ZmZXIiLAogICAgICAidG8iOiAiaGlyZWQiCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJzY3JlZW5pbmciLAogICAgICAidG8iOiAicmVqZWN0X2FmdGVyX3NjcmVlbiIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogInJlamVjdF9hZnRlcl9zY3JlZW4iLAogICAgICAidG8iOiAicmVqZWN0ZWQiCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJpbnRlcnZpZXdpbmciLAogICAgICAidG8iOiAicmVqZWN0X2FmdGVyX2ludGVydmlldyIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogInJlamVjdF9hZnRlcl9pbnRlcnZpZXciLAogICAgICAidG8iOiAicmVqZWN0ZWQiCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJvZmZlcl9leHRlbmRlZCIsCiAgICAgICJ0byI6ICJkZWNsaW5lX29mZmVyIgogICAgfSwKICAgIHsKICAgICAgImZyb20iOiAiZGVjbGluZV9vZmZlciIsCiAgICAgICJ0byI6ICJyZWplY3RlZCIKICAgIH0KICBdLAogICJhY2Nlc3MiOiBbCiAgICB7CiAgICAgICJ0cmFuc2l0aW9uIjogInN0YXJ0X3NjcmVlbmluZyIsCiAgICAgICJyb2xlcyI6IFsKICAgICAgICAicmVjcnVpdGVyIgogICAgICBdCiAgICB9LAogICAgewogICAgICAidHJhbnNpdGlvbiI6ICJiZWdpbl9jaGVja3MiLAogICAgICAicm9sZXMiOiBbCiAgICAgICAgInJlY3J1aXRlciIKICAgICAgXQogICAgfSwKICAgIHsKICAgICAgInRyYW5zaXRpb24iOiAic2NoZWR1bGVfcGhvbmVfc2NyZWVuIiwKICAgICAgInJvbGVzIjogWwogICAgICAgICJyZWNydWl0ZXIiCiAgICAgIF0KICAgIH0sCiAgICB7CiAgICAgICJ0cmFuc2l0aW9uIjogInN0YXJ0X2JhY2tncm91bmRfY2hlY2siLAogICAgICAicm9sZXMiOiBbCiAgICAgICAgInJlY3J1aXRlciIKICAgICAgXQogICAgfSwKICAgIHsKICAgICAgInRyYW5zaXRpb24iOiAiY29tcGxldGVfcGhvbmVfc2NyZWVuIiwKICAgICAgInJvbGVzIjogWwogICAgICAgICJyZWNydWl0ZXIiCiAgICAgIF0KICAgIH0sCiAgICB7CiAgICAgICJ0cmFuc2l0aW9uIjogImNvbXBsZXRlX2JhY2tncm91bmRfY2hlY2siLAogICAgICAicm9sZXMiOiBbCiAgICAgICAgInJlY3J1aXRlciIKICAgICAgXQogICAgfSwKICAgIHsKICAgICAgInRyYW5zaXRpb24iOiAiYWR2YW5jZV90b19pbnRlcnZpZXciLAogICAgICAicm9sZXMiOiBbCiAgICAgICAgInJlY3J1aXRlciIKICAgICAgXQogICAgfSwKICAgIHsKICAgICAgInRyYW5zaXRpb24iOiAiY29uZHVjdF9pbnRlcnZpZXciLAogICAgICAicm9sZXMiOiBbCiAgICAgICAgImhpcmluZ19tYW5hZ2VyIgogICAgICBdCiAgICB9LAogICAgewogICAgICAidHJhbnNpdGlvbiI6ICJleHRlbmRfb2ZmZXIiLAogICAgICAicm9sZXMiOiBbCiAgICAgICAgImhpcmluZ19tYW5hZ2VyIgogICAgICBdCiAgICB9LAogICAgewogICAgICAidHJhbnNpdGlvbiI6ICJhY2NlcHRfb2ZmZXIiLAogICAgICAicm9sZXMiOiBbCiAgICAgICAgImNhbmRpZGF0ZSIKICAgICAgXQogICAgfSwKICAgIHsKICAgICAgInRyYW5zaXRpb24iOiAicmVqZWN0X2FmdGVyX3NjcmVlbiIsCiAgICAgICJyb2xlcyI6IFsKICAgICAgICAicmVjcnVpdGVyIgogICAgICBdCiAgICB9LAogICAgewogICAgICAidHJhbnNpdGlvbiI6ICJyZWplY3RfYWZ0ZXJfaW50ZXJ2aWV3IiwKICAgICAgInJvbGVzIjogWwogICAgICAgICJoaXJpbmdfbWFuYWdlciIKICAgICAgXQogICAgfSwKICAgIHsKICAgICAgInRyYW5zaXRpb24iOiAiZGVjbGluZV9vZmZlciIsCiAgICAgICJyb2xlcyI6IFsKICAgICAgICAiY2FuZGlkYXRlIgogICAgICBdCiAgICB9CiAgXSwKICAiZGVidWciOiB7CiAgICAiZW5hYmxlZCI6IHRydWUsCiAgICAiZXZhbCI6IHRydWUKICB9Cn0="

	return func(w http.ResponseWriter, r *http.Request) {
		schemaJSON, err := base64.StdEncoding.DecodeString(schemaBase64)
		if err != nil {
			api.Error(w, http.StatusInternalServerError, "schema_decode_error", "Failed to decode schema")
			return
		}
		w.Header().Set("Content-Type", "application/json")
		w.WriteHeader(http.StatusOK)
		w.Write(schemaJSON)
	}
}

