-- Migration: 001_init_jobapplication
-- Generated by petri-pilot. DO NOT EDIT.
--
-- Event store schema for job-application workflow

-- Events table: append-only event log
CREATE TABLE IF NOT EXISTS events (
    id TEXT PRIMARY KEY,
    stream_id TEXT NOT NULL,
    type TEXT NOT NULL,
    version INTEGER NOT NULL,
    data TEXT NOT NULL,  -- JSON
    metadata TEXT,       -- JSON, optional
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(stream_id, version)
);

-- Indexes for common query patterns
CREATE INDEX IF NOT EXISTS idx_events_stream_id ON events(stream_id);
CREATE INDEX IF NOT EXISTS idx_events_stream_version ON events(stream_id, version);
CREATE INDEX IF NOT EXISTS idx_events_type ON events(type);
CREATE INDEX IF NOT EXISTS idx_events_timestamp ON events(timestamp);

-- Snapshots table: periodic aggregate state snapshots for faster replay
CREATE TABLE IF NOT EXISTS snapshots (
    stream_id TEXT PRIMARY KEY,
    version INTEGER NOT NULL,
    state TEXT NOT NULL,  -- JSON
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- Projection: job-application aggregate state
-- Denormalized view for fast reads
CREATE TABLE IF NOT EXISTS "jobapplication_state" (
    id TEXT PRIMARY KEY,
    version INTEGER NOT NULL DEFAULT 0,
    "applied" INTEGER DEFAULT 0,
    "screening" INTEGER DEFAULT 0,
    "phone_screen_pending" INTEGER DEFAULT 0,
    "phone_screen_complete" INTEGER DEFAULT 0,
    "background_check_pending" INTEGER DEFAULT 0,
    "background_check_complete" INTEGER DEFAULT 0,
    "ready_for_interview" INTEGER DEFAULT 0,
    "interviewing" INTEGER DEFAULT 0,
    "offer_extended" INTEGER DEFAULT 0,
    "hired" INTEGER DEFAULT 0,
    "rejected" INTEGER DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX IF NOT EXISTS "idx_jobapplication_state_updated" ON "jobapplication_state"(updated_at);

-- Place tokens tracking (Petri net state)
CREATE TABLE IF NOT EXISTS "jobapplication_places" (
    aggregate_id TEXT NOT NULL,
    place_id TEXT NOT NULL,
    tokens INTEGER NOT NULL DEFAULT 0,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (aggregate_id, place_id)
);

-- Event type constants for reference:
-- StartScreeninged
-- SchedulePhoneScreened
-- StartBackgroundChecked
-- CompletePhoneScreened
-- CompleteBackgroundChecked
-- AdvanceToInterviewed
-- ConductInterviewed
-- ExtendOffered
-- AcceptOffered
-- RejectAfterScreened
-- RejectAfterInterviewed
-- DeclineOffered

-- Place constants for reference:
-- applied: Application submitted
-- screening: Initial screening in progress
-- phone_screen_pending: Phone screen scheduled
-- phone_screen_complete: Phone screen completed
-- background_check_pending: Background check in progress
-- background_check_complete: Background check completed
-- ready_for_interview: Both screens passed, ready for interview
-- interviewing: Interview process ongoing
-- offer_extended: Job offer has been extended
-- hired: Candidate has been hired
-- rejected: Application rejected

-- Transition constants for reference:
-- start_screening: Begin candidate screening
-- schedule_phone_screen: Schedule phone screen
-- start_background_check: Initiate background check
-- complete_phone_screen: Complete phone screen
-- complete_background_check: Complete background check
-- advance_to_interview: Both checks passed, advance to interview
-- conduct_interview: Conduct interview
-- extend_offer: Extend job offer
-- accept_offer: Candidate accepts offer
-- reject_after_screen: Reject after screening
-- reject_after_interview: Reject after interview
-- decline_offer: Candidate declines offer
