// Generated by petri-pilot. DO NOT EDIT.

/**
 * Debug Wallet Module for erc20-token
 * Provides MetaMask-like behavior for testing without actual blockchain
 */

// ============================================================================
// Wallet Configuration
// ============================================================================

const WALLET_ACCOUNTS = [
  {
    address: '0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266',
    name: 'Alice (Admin)',
    roles: ["admin", "holder"],
    initialBalance: '10000',
  },
  {
    address: '0x70997970C51812dc3A010C7d01b50e0d17dc79C8',
    name: 'Bob (Holder)',
    roles: ["holder"],
    initialBalance: '1000',
  },
  {
    address: '0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC',
    name: 'Charlie (Holder)',
    roles: ["holder"],
    initialBalance: '500',
  },
  {
    address: '0x90F79bf6EB2c4f870365E785982E1f101E93b906',
    name: 'Dave (Observer)',
    roles: [],
    initialBalance: '0',
  },
]

const BALANCE_FIELD = 'balances'
const AUTO_CONNECT = true
const SHOW_IN_NAV = true

// ============================================================================
// Wallet State
// ============================================================================

let connectedAccount = null
let accountIndex = -1
const listeners = {
  connect: [],
  disconnect: [],
  accountChanged: [],
}

// ============================================================================
// Event System
// ============================================================================

function emit(event, data) {
  if (listeners[event]) {
    listeners[event].forEach(cb => cb(data))
  }
}

export function on(event, callback) {
  if (listeners[event]) {
    listeners[event].push(callback)
  }
}

export function off(event, callback) {
  if (listeners[event]) {
    listeners[event] = listeners[event].filter(cb => cb !== callback)
  }
}

// ============================================================================
// Connection Functions
// ============================================================================

/**
 * Connect to a wallet account by index
 */
export async function connect(index = 0) {
  if (index < 0 || index >= WALLET_ACCOUNTS.length) {
    throw new Error(`Invalid account index: ${index}`)
  }

  const account = WALLET_ACCOUNTS[index]
  connectedAccount = account
  accountIndex = index

  // Login with the account's roles via debug endpoint
  try {
    const response = await fetch('/api/debug/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        user_id: account.address,
        login: account.name || account.address,
        roles: account.roles,
      }),
    })

    if (!response.ok) {
      throw new Error('Failed to authenticate wallet')
    }

    const authData = await response.json()

    // Store auth in localStorage
    localStorage.setItem('auth', JSON.stringify(authData))

    // Store wallet connection
    localStorage.setItem('wallet', JSON.stringify({
      accountIndex: index,
      address: account.address,
    }))

    emit('connect', { account, index, authData })

    return { account, index, authData }
  } catch (err) {
    connectedAccount = null
    accountIndex = -1
    throw err
  }
}

/**
 * Disconnect the current wallet
 */
export async function disconnect() {
  const wasConnected = connectedAccount

  connectedAccount = null
  accountIndex = -1

  // Clear auth
  localStorage.removeItem('auth')
  localStorage.removeItem('wallet')

  // Logout from server
  try {
    await fetch('/auth/logout', { method: 'POST' })
  } catch (e) {
    // Ignore logout errors
  }

  if (wasConnected) {
    emit('disconnect', { account: wasConnected })
  }
}

/**
 * Switch to a different account
 */
export async function switchAccount(index) {
  if (index === accountIndex) return getAccount()

  await disconnect()
  return connect(index)
}

/**
 * Restore wallet connection from localStorage
 */
export async function restore() {
  const stored = localStorage.getItem('wallet')
  if (stored) {
    try {
      const { accountIndex: idx } = JSON.parse(stored)
      if (idx >= 0 && idx < WALLET_ACCOUNTS.length) {
        return connect(idx)
      }
    } catch (e) {
      localStorage.removeItem('wallet')
    }
  }
  return null
}

// ============================================================================
// Getters
// ============================================================================

export function isConnected() {
  return connectedAccount !== null
}

export function getAccount() {
  return connectedAccount
}

export function getAddress() {
  return connectedAccount?.address || null
}

export function getAccountIndex() {
  return accountIndex
}

export function getAccounts() {
  return WALLET_ACCOUNTS
}

export function getAccountRoles() {
  return connectedAccount?.roles || []
}

/**
 * Get balance for an address from the current instance state
 */
export function getBalance(address, state) {
  if (!state || !BALANCE_FIELD) return null

  const balances = state[BALANCE_FIELD]
  if (!balances || typeof balances !== 'object') return null

  return balances[address] || 0
}

/**
 * Get the connected account's balance
 */
export function getMyBalance(state) {
  if (!connectedAccount) return null
  return getBalance(connectedAccount.address, state)
}

// ============================================================================
// Wallet UI Components
// ============================================================================

/**
 * Create wallet status HTML for navigation bar
 */
export function createWalletStatus(state) {
  if (!SHOW_IN_NAV) return ''

  if (!connectedAccount) {
    return `
      <div class="wallet-status disconnected">
        <span class="wallet-dot"></span>
        <span class="wallet-text">Not Connected</span>
        <button onclick="window.showWalletModal()" class="btn btn-primary btn-sm">Connect</button>
      </div>
    `
  }

  const balance = getMyBalance(state)
  const displayBalance = balance !== null ? formatBalance(balance) : '...'

  return `
    <div class="wallet-status connected">
      <span class="wallet-dot connected"></span>
      <span class="wallet-address" title="${connectedAccount.address}">
        ${formatAddress(connectedAccount.address)}
      </span>
      <span class="wallet-balance">${displayBalance} ETH</span>
      <button onclick="window.showWalletModal()" class="btn btn-link btn-sm">Switch</button>
      <button onclick="window.disconnectWallet()" class="btn btn-link btn-sm">Disconnect</button>
    </div>
  `
}

/**
 * Create wallet selector modal HTML
 */
export function createWalletModal() {
  const accountButtons = WALLET_ACCOUNTS.map((acc, idx) => {
    const isActive = idx === accountIndex
    return `
      <button
        onclick="window.connectWalletAccount(${idx})"
        class="wallet-account-btn ${isActive ? 'active' : ''}"
      >
        <div class="wallet-account-info">
          <span class="wallet-account-name">${acc.name || 'Account ' + idx}</span>
          <span class="wallet-account-address">${formatAddress(acc.address)}</span>
        </div>
        <div class="wallet-account-roles">
          ${acc.roles.map(r => `<span class="role-badge">${r}</span>`).join('')}
        </div>
        ${isActive ? '<span class="wallet-account-active">Connected</span>' : ''}
      </button>
    `
  }).join('')

  return `
    <div id="wallet-modal" class="modal" style="display: none;">
      <div class="modal-backdrop" onclick="window.hideWalletModal()"></div>
      <div class="modal-content">
        <div class="modal-header">
          <h3>Select Account</h3>
          <button onclick="window.hideWalletModal()" class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <p>Choose an account to connect:</p>
          <div class="wallet-account-list">
            ${accountButtons}
          </div>
        </div>
      </div>
    </div>
    <style>
      .wallet-status {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      .wallet-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #f59e0b;
      }
      .wallet-dot.connected {
        background: #10b981;
      }
      .wallet-address {
        font-family: monospace;
        font-size: 0.85rem;
        color: rgba(255,255,255,0.9);
      }
      .wallet-balance {
        font-weight: 600;
        color: #10b981;
      }
      .wallet-account-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }
      .wallet-account-btn {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1rem;
        border: 1px solid #ddd;
        border-radius: 6px;
        background: #f9f9f9;
        cursor: pointer;
        transition: all 0.2s;
        text-align: left;
        width: 100%;
      }
      .wallet-account-btn:hover {
        background: #e5e5e5;
        border-color: #007bff;
      }
      .wallet-account-btn.active {
        background: #e3f2fd;
        border-color: #007bff;
      }
      .wallet-account-info {
        display: flex;
        flex-direction: column;
      }
      .wallet-account-name {
        font-weight: 600;
      }
      .wallet-account-address {
        font-family: monospace;
        font-size: 0.8rem;
        color: #666;
      }
      .wallet-account-roles {
        display: flex;
        gap: 0.25rem;
      }
      .role-badge {
        padding: 0.125rem 0.5rem;
        background: #e5e5e5;
        border-radius: 4px;
        font-size: 0.75rem;
      }
      .wallet-account-active {
        color: #10b981;
        font-size: 0.8rem;
      }
    </style>
  `
}

// ============================================================================
// Utility Functions
// ============================================================================

function formatAddress(address) {
  if (!address) return ''
  if (address.length <= 12) return address
  return address.slice(0, 6) + '...' + address.slice(-4)
}

function formatBalance(amount) {
  if (amount === null || amount === undefined) return '0'
  const num = typeof amount === 'string' ? parseFloat(amount) : amount
  if (num === 0) return '0'
  if (num < 0.0001) return '<0.0001'
  if (num < 1) return num.toFixed(4)
  if (num < 1000) return num.toFixed(2)
  return num.toLocaleString(undefined, { maximumFractionDigits: 2 })
}

// ============================================================================
// Global Window Functions (for onclick handlers)
// ============================================================================

window.showWalletModal = function() {
  const modal = document.getElementById('wallet-modal')
  if (modal) modal.style.display = 'flex'
}

window.hideWalletModal = function() {
  const modal = document.getElementById('wallet-modal')
  if (modal) modal.style.display = 'none'
}

window.connectWalletAccount = async function(index) {
  try {
    await connect(index)
    window.hideWalletModal()
    // Dispatch auth change event to refresh UI
    window.dispatchEvent(new CustomEvent('auth-change'))
  } catch (err) {
    console.error('Wallet connection failed:', err)
    alert('Failed to connect wallet: ' + err.message)
  }
}

window.disconnectWallet = async function() {
  await disconnect()
  window.dispatchEvent(new CustomEvent('auth-change'))
}

// ============================================================================
// Auto-initialization
// ============================================================================

// Try to restore wallet connection on load
if (typeof window !== 'undefined') {
  window.addEventListener('DOMContentLoaded', async () => {
    // First try to restore
    const restored = await restore()

    // If not restored and auto-connect is enabled, connect to first account
    if (!restored && AUTO_CONNECT && WALLET_ACCOUNTS.length > 0) {
      try {
        await connect(0)
        window.dispatchEvent(new CustomEvent('auth-change'))
      } catch (err) {
        console.error('Auto-connect failed:', err)
      }
    }
  })
}

// Export for global access
export default {
  connect,
  disconnect,
  switchAccount,
  restore,
  isConnected,
  getAccount,
  getAddress,
  getAccountIndex,
  getAccounts,
  getAccountRoles,
  getBalance,
  getMyBalance,
  createWalletStatus,
  createWalletModal,
  on,
  off,
}
