-- Migration: 001_init_orderprocessing
-- Generated by petri-pilot. DO NOT EDIT.
--
-- Event store schema for order-processing workflow

-- Events table: append-only event log
CREATE TABLE IF NOT EXISTS events (
    id TEXT PRIMARY KEY,
    stream_id TEXT NOT NULL,
    type TEXT NOT NULL,
    version INTEGER NOT NULL,
    data TEXT NOT NULL,  -- JSON
    metadata TEXT,       -- JSON, optional
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(stream_id, version)
);

-- Indexes for common query patterns
CREATE INDEX IF NOT EXISTS idx_events_stream_id ON events(stream_id);
CREATE INDEX IF NOT EXISTS idx_events_stream_version ON events(stream_id, version);
CREATE INDEX IF NOT EXISTS idx_events_type ON events(type);
CREATE INDEX IF NOT EXISTS idx_events_timestamp ON events(timestamp);

-- Snapshots table: periodic aggregate state snapshots for faster replay
CREATE TABLE IF NOT EXISTS snapshots (
    stream_id TEXT PRIMARY KEY,
    version INTEGER NOT NULL,
    state TEXT NOT NULL,  -- JSON
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- Projection: order-processing aggregate state
-- Denormalized view for fast reads
CREATE TABLE IF NOT EXISTS "orderprocessing_state" (
    id TEXT PRIMARY KEY,
    version INTEGER NOT NULL DEFAULT 0,
    "received" INTEGER DEFAULT 0,
    "validated" INTEGER DEFAULT 0,
    "rejected" INTEGER DEFAULT 0,
    "paid" INTEGER DEFAULT 0,
    "shipped" INTEGER DEFAULT 0,
    "completed" INTEGER DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX IF NOT EXISTS "idx_orderprocessing_state_updated" ON "orderprocessing_state"(updated_at);

-- Place tokens tracking (Petri net state)
CREATE TABLE IF NOT EXISTS "orderprocessing_places" (
    aggregate_id TEXT NOT NULL,
    place_id TEXT NOT NULL,
    tokens INTEGER NOT NULL DEFAULT 0,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (aggregate_id, place_id)
);

-- Event type constants for reference:
-- Validateed
-- Rejected
-- ProcessPaymented
-- Shiped
-- Confirmed

-- Place constants for reference:
-- received: Order received and awaiting processing
-- validated: Order passed validation
-- rejected: Order failed validation
-- paid: Payment completed
-- shipped: Order shipped to customer
-- completed: Order fulfilled

-- Transition constants for reference:
-- validate: Check order validity
-- reject: Mark order as invalid
-- process_payment: Charge customer payment
-- ship: Send order to shipping
-- confirm: Mark order as complete
