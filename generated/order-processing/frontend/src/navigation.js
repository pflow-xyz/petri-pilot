// Generated by petri-pilot. DO NOT EDIT.

/**
 * Navigation component for order-processing application
 * Provides navigation menu with fallback defaults
 */

import { navigate } from './router.js'

// Default navigation when backend is unavailable
const defaultNavigation = {
  brand: 'order-processing',
  items: [
    { label: 'order-processing', path: '/order-processing', icon: '' },
    { label: 'New', path: '/order-processing/new', icon: '+' },
    { label: 'Admin', path: '/admin', icon: '' },
  ]
}

// Navigation state
let navigationData = null
let isLoading = false

// Fetch navigation from backend
async function fetchNavigation() {
  if (isLoading) return

  isLoading = true
  try {
    const headers = {}
    const token = getAuthToken()
    if (token) {
      headers['Authorization'] = `Bearer ${token}`
    }

    const response = await fetch('/api/navigation', { headers })
    if (response.ok) {
      navigationData = await response.json()
    } else {
      // Use fallback navigation
      navigationData = defaultNavigation
    }
  } catch (error) {
    // Use fallback navigation
    navigationData = defaultNavigation
  } finally {
    isLoading = false
  }
}

// Create navigation HTML
export async function createNavigation() {
  // Fetch navigation if not already loaded
  if (!navigationData) {
    await fetchNavigation()
  }

  const currentPath = window.location.pathname
  const user = getCurrentUser()

  // Use fetched items or defaults
  const items = navigationData?.items || defaultNavigation.items
  const brand = navigationData?.brand || defaultNavigation.brand

  const html = `
    <nav class="navigation">
      <div class="nav-brand">
        <a href="/order-processing" onclick="handleNavClick(event, '/order-processing')">
          ${brand}
        </a>
      </div>
      <ul class="nav-menu">
        ${items.map(item => {
          const isActive = currentPath === item.path ||
            (item.path !== '/' && currentPath.startsWith(item.path))
          return `
            <li class="${isActive ? 'active' : ''}">
              <a href="${item.path}" onclick="handleNavClick(event, '${item.path}')">
                ${item.icon ? `<span class="icon">${item.icon}</span>` : ''}
                ${item.label}
              </a>
            </li>
          `
        }).join('')}
      </ul>
      <div class="nav-user">
        ${user ? `
          <span class="user-name">${user.login || user.name || 'User'}</span>
          <button onclick="handleLogout()" class="btn btn-link" style="color: rgba(255,255,255,0.8);">Logout</button>
        ` : `
          <a href="/auth/login" class="btn btn-primary btn-sm">Login</a>
        `}
      </div>
    </nav>
  `

  return html
}

// Handle navigation clicks
window.handleNavClick = function(event, path) {
  event.preventDefault()
  navigate(path)
}

// Handle logout
window.handleLogout = async function() {
  try {
    const token = getAuthToken()
    if (token) {
      await fetch('/auth/logout', {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}` }
      })
    }
  } catch (e) {
    console.error('Logout error:', e)
  }

  // Clear local auth
  localStorage.removeItem('auth')

  // Clear navigation cache to refetch with new user context
  navigationData = null

  // Dispatch auth change event
  window.dispatchEvent(new CustomEvent('auth-change'))

  // Refresh navigation and redirect
  await refreshNavigation()
  navigate('/order-processing')
}

// Helper functions
function getCurrentUser() {
  const auth = localStorage.getItem('auth')
  if (auth) {
    try {
      return JSON.parse(auth).user
    } catch (e) {
      return null
    }
  }
  return null
}

function getAuthToken() {
  const auth = localStorage.getItem('auth')
  if (auth) {
    try {
      return JSON.parse(auth).token
    } catch (e) {
      return null
    }
  }
  return null
}

// Refresh navigation (e.g., after login/logout)
export async function refreshNavigation() {
  navigationData = null
  await fetchNavigation()
  const navElement = document.getElementById('nav')
  if (navElement) {
    navElement.innerHTML = await createNavigation()
  }
}

// Update navigation when auth changes
window.addEventListener('auth-change', async () => {
  await refreshNavigation()
})

// Update active state when route changes
window.addEventListener('route-change', () => {
  const currentPath = window.location.pathname
  document.querySelectorAll('.nav-menu li').forEach(li => {
    li.classList.remove('active')
  })

  // Find and highlight active link
  document.querySelectorAll('.nav-menu a').forEach(a => {
    const href = a.getAttribute('href')
    if (href === currentPath || (href !== '/' && currentPath.startsWith(href))) {
      a.parentElement.classList.add('active')
    }
  })
})
