// Code generated by petri-pilot. DO NOT EDIT.

package loanapplication

import (
	"encoding/base64"
	"encoding/json"
	"io/fs"
	"net/http"
	"os"
	"path/filepath"
	"strconv"
	"strings"

	"github.com/pflow-xyz/petri-pilot/pkg/runtime/api"
)

// BuildRouter creates an HTTP router for the loan-application workflow.
func BuildRouter(app *Application, middleware *Middleware, sessions SessionStore, debugBroker *DebugBroker, blobStore *BlobStore, commentStore *CommentStore, tagStore *TagStore, activityStore *ActivityStore, softDeleteStore *SoftDeleteStore) http.Handler {
	r := api.NewRouter()

	// Apply auth middleware to extract user from token (optional, doesn't require auth)
	r.Use(OptionalAuthMiddleware(sessions))

	// Health check - always returns ok if server is running
	r.GET("/health", "Health check", func(w http.ResponseWriter, r *http.Request) {
		api.JSON(w, http.StatusOK, map[string]string{"status": "ok"})
	})

	// Readiness check - verifies dependencies (database, etc.)
	r.GET("/ready", "Readiness check", HandleReady(app))

	// Create new aggregate
	r.POST("/api/loanapplication", "Create new loan-application", HandleCreate(app))

	// Get aggregate state
	r.GET("/api/loanapplication/{id}", "Get loan-application state", HandleGetState(app))

	// View definitions
	r.GET("/api/views", "Get view definitions", HandleGetViews())


	// Schema viewer endpoint
	r.GET("/api/schema", "Get model schema", HandleGetSchema())



	// Event replay endpoints
	r.GET("/api/loanapplication/{id}/events", "Get event history", HandleGetEvents(app))
	r.GET("/api/loanapplication/{id}/at/{version}", "Get state at version", HandleGetStateAtVersion(app))
	r.POST("/api/loanapplication/{id}/truncate", "Truncate event history to version", HandleTruncate(app))






	// Debug WebSocket and eval endpoints
	r.GET("/ws", "Debug WebSocket connection", HandleDebugWebSocket(debugBroker))
	r.GET("/api/debug/sessions", "List debug sessions", HandleListSessions(debugBroker))
	r.POST("/api/debug/sessions/{id}/eval", "Evaluate code in browser session", HandleSessionEval(debugBroker))
	// Test login endpoint (only available in debug mode)
	r.POST("/api/debug/login", "Create test session with roles", HandleTestLogin(sessions))


	// Blob storage endpoints
	r.POST("/api/blobs", "Upload a new blob", blobStore.HandleUpload)
	r.GET("/api/blobs", "List user's blobs", blobStore.HandleList)
	r.GET("/api/blobs/{id}", "Get blob data", blobStore.HandleGet)
	r.GET("/api/blobs/{id}/meta", "Get blob metadata", blobStore.HandleGetMeta)
	r.Handle("PATCH", "/api/blobs/{id}", "Transfer blob ownership", blobStore.HandleTransfer)
	r.Handle("DELETE", "/api/blobs/{id}", "Delete a blob", blobStore.HandleDelete)




	// Comment endpoints
	r.GET("/api/loanapplication/{id}/comments", "List comments", commentStore.HandleListComments)
	r.POST("/api/loanapplication/{id}/comments", "Add comment", commentStore.HandleAddComment)
	r.Handle("DELETE", "/api/comments/{commentId}", "Delete comment", commentStore.HandleDeleteComment)


	// Tag endpoints
	r.GET("/api/loanapplication/{id}/tags", "List entity tags", tagStore.HandleListTags)
	r.POST("/api/loanapplication/{id}/tags", "Add tag", tagStore.HandleAddTag)
	r.Handle("DELETE", "/api/loanapplication/{id}/tags/{name}", "Remove tag", tagStore.HandleRemoveTag)



	// Activity feed endpoints
	r.GET("/api/loanapplication/{id}/activity", "Get entity activity", activityStore.HandleGetActivity)










	// Soft delete endpoints
	r.Handle("DELETE", "/api/loanapplication/{id}", "Soft delete entity", softDeleteStore.HandleSoftDelete)
	r.POST("/api/loanapplication/{id}/restore", "Restore deleted entity", softDeleteStore.HandleRestore)

	// Transition endpoints
	r.Transition("run_credit_check", "/api/run_credit_check", "Initiate automated credit check", middleware.RequirePermission("run_credit_check")(HandleRunCreditCheck(app)))
	r.Transition("auto_approve", "/api/auto_approve", "Automatic approval based on credit score", middleware.RequirePermission("auto_approve")(HandleAutoApprove(app)))
	r.Transition("flag_for_review", "/api/flag_for_review", "Flag application for manual review", middleware.RequirePermission("flag_for_review")(HandleFlagForReview(app)))
	r.Transition("underwriter_approve", "/api/underwriter_approve", "Underwriter approves the application", middleware.RequirePermission("underwriter_approve")(HandleUnderwriterApprove(app)))
	r.Transition("underwriter_deny", "/api/underwriter_deny", "Underwriter denies the application", middleware.RequirePermission("underwriter_deny")(HandleUnderwriterDeny(app)))
	r.Transition("auto_deny", "/api/auto_deny", "Automatic denial based on credit score", middleware.RequirePermission("auto_deny")(HandleAutoDeny(app)))
	r.Transition("finalize_approval", "/api/finalize_approval", "Finalize loan approval", middleware.RequirePermission("finalize_approval")(HandleFinalizeApproval(app)))
	r.Transition("disburse", "/api/disburse", "Disburse loan funds to customer", middleware.RequirePermission("disburse")(HandleDisburse(app)))
	r.Transition("start_repayment", "/api/start_repayment", "Begin repayment period", middleware.RequirePermission("start_repayment")(HandleStartRepayment(app)))
	r.Transition("make_payment", "/api/make_payment", "Customer makes a payment", middleware.RequirePermission("make_payment")(HandleMakePayment(app)))
	r.Transition("complete", "/api/complete", "Final payment received, loan complete", middleware.RequirePermission("complete")(HandleComplete(app)))
	r.Transition("mark_default", "/api/mark_default", "Mark loan as defaulted", middleware.RequirePermission("mark_default")(HandleMarkDefault(app)))

	// Serve frontend static files
	r.StaticFiles("/", StaticFileHandler())

	return r.Build()
}

// StaticFileHandler returns an http.Handler that serves static files from frontend/.
// It supports SPA routing by returning index.html for paths that don't match static files.
func StaticFileHandler() http.HandlerFunc {
	// Find frontend directory - try custom frontends first, then generated
	frontendPath := ""
	candidates := []string{
		"frontends/loan-application",                    // Custom frontend (top priority)
		"frontend",                                    // Running from service directory
		"generated/loanapplication/frontend",         // Generated frontend from repo root
		filepath.Join("generated", "loanapplication", "frontend"), // Platform-safe
	}

	// Also try relative to executable
	if exe, err := os.Executable(); err == nil {
		exeDir := filepath.Dir(exe)
		candidates = append(candidates,
			filepath.Join(exeDir, "frontends", "loan-application"),
			filepath.Join(exeDir, "frontend"),
			filepath.Join(exeDir, "generated", "loanapplication", "frontend"),
		)
	}

	for _, candidate := range candidates {
		if _, err := os.Stat(candidate); err == nil {
			frontendPath = candidate
			break
		}
	}

	return func(w http.ResponseWriter, r *http.Request) {
		// No frontend found
		if frontendPath == "" {
			http.Error(w, "Frontend not found", http.StatusNotFound)
			return
		}

		// Clean the path
		path := strings.TrimPrefix(r.URL.Path, "/")
		if path == "" {
			path = "index.html"
		}

		// Try to serve the file
		fullPath := filepath.Join(frontendPath, path)

		// Check if file exists
		info, err := os.Stat(fullPath)
		if err != nil || info.IsDir() {
			// File doesn't exist, serve index.html for SPA routing
			http.ServeFile(w, r, filepath.Join(frontendPath, "index.html"))
			return
		}

		http.ServeFile(w, r, fullPath)
	}
}

// StaticFS is a helper interface for embedding static files (optional).
type StaticFS interface {
	fs.FS
}

// HandleCreate creates a new aggregate instance.
func HandleCreate(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		id, err := app.Create(ctx)
		if err != nil {
			api.Error(w, http.StatusInternalServerError, "CREATE_FAILED", err.Error())
			return
		}

		// Load the new aggregate to get initial state
		agg, err := app.Load(ctx, id)
		if err != nil {
			api.Error(w, http.StatusInternalServerError, "LOAD_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusCreated, api.StateResponse{
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.State(),
			Places:             agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}

// HandleGetState returns the current state of an aggregate.
func HandleGetState(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()
		id := r.PathValue("id")
		if id == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate ID is required")
			return
		}

		agg, err := app.GetState(ctx, id)
		if err != nil {
			api.Error(w, http.StatusNotFound, "NOT_FOUND", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.StateResponse{
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.State(),
			Places:             agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}

// HandleReady checks if the application is ready to serve requests.
// Returns 200 if all dependencies are available, 503 otherwise.
func HandleReady(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		checks := make(map[string]string)
		ready := true

		// Check event store connectivity
		if err := app.HealthCheck(r.Context()); err != nil {
			checks["eventstore"] = err.Error()
			ready = false
		} else {
			checks["eventstore"] = "ok"
		}

		status := http.StatusOK
		statusText := "ready"
		if !ready {
			status = http.StatusServiceUnavailable
			statusText = "not ready"
		}

		api.JSON(w, status, map[string]any{
			"status": statusText,
			"checks": checks,
		})
	}
}


// HandleRunCreditCheck handles the run_credit_check transition.
func HandleRunCreditCheck(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionRunCreditCheck, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleAutoApprove handles the auto_approve transition.
func HandleAutoApprove(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionAutoApprove, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleFlagForReview handles the flag_for_review transition.
func HandleFlagForReview(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionFlagForReview, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleUnderwriterApprove handles the underwriter_approve transition.
func HandleUnderwriterApprove(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionUnderwriterApprove, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleUnderwriterDeny handles the underwriter_deny transition.
func HandleUnderwriterDeny(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionUnderwriterDeny, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleAutoDeny handles the auto_deny transition.
func HandleAutoDeny(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionAutoDeny, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleFinalizeApproval handles the finalize_approval transition.
func HandleFinalizeApproval(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionFinalizeApproval, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleDisburse handles the disburse transition.
func HandleDisburse(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionDisburse, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleStartRepayment handles the start_repayment transition.
func HandleStartRepayment(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionStartRepayment, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleMakePayment handles the make_payment transition.
func HandleMakePayment(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionMakePayment, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleComplete handles the complete transition.
func HandleComplete(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionComplete, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleMarkDefault handles the mark_default transition.
func HandleMarkDefault(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionMarkDefault, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleGetViews returns the view definitions for the workflow.
func HandleGetViews() http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		data, err := ViewsJSON()
		if err != nil {
			api.Error(w, http.StatusInternalServerError, "VIEWS_ERROR", err.Error())
			return
		}
		w.Header().Set("Content-Type", "application/json")
		w.WriteHeader(http.StatusOK)
		w.Write(data)
	}
}






// HandleGetEvents returns the event history for an aggregate.
func HandleGetEvents(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()
		id := r.PathValue("id")
		from := getIntQueryParam(r, "from", 0)

		events, err := app.store.Read(ctx, id, from)
		if err != nil {
			api.Error(w, http.StatusInternalServerError, "READ_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, map[string]interface{}{
			"events": events,
		})
	}
}

// HandleGetStateAtVersion returns the aggregate state at a specific version.
func HandleGetStateAtVersion(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()
		id := r.PathValue("id")
		versionStr := r.PathValue("version")

		version := getInt(versionStr, 0)
		if version <= 0 {
			api.Error(w, http.StatusBadRequest, "INVALID_VERSION", "version must be a positive integer")
			return
		}

		events, err := app.store.Read(ctx, id, 0)
		if err != nil {
			api.Error(w, http.StatusInternalServerError, "READ_FAILED", err.Error())
			return
		}

		// Create temporary aggregate and replay up to version
		agg := NewAggregate(id)
		for _, evt := range events {
			if evt.Version > version {
				break
			}
			if err := agg.Apply(evt); err != nil {
				api.Error(w, http.StatusInternalServerError, "APPLY_FAILED", err.Error())
				return
			}
		}

		api.JSON(w, http.StatusOK, map[string]interface{}{
			"id":      agg.ID(),
			"version": version,
			"state":   agg.State(),
		})
	}
}

// HandleTruncate truncates the event stream to a specific version.
// This enables "undo and redo differently" workflows by discarding events after the target version.
func HandleTruncate(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()
		id := r.PathValue("id")

		var req struct {
			Version int `json:"version"`
		}
		if err := json.NewDecoder(r.Body).Decode(&req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", "request body must contain version field")
			return
		}

		if req.Version < 0 {
			api.Error(w, http.StatusBadRequest, "INVALID_VERSION", "version must be non-negative")
			return
		}

		agg, err := app.TruncateTo(ctx, id, req.Version)
		if err != nil {
			api.Error(w, http.StatusInternalServerError, "TRUNCATE_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, map[string]interface{}{
			"id":                    agg.ID(),
			"version":               agg.Version(),
			"state":                 agg.State(),
			"enabled_transitions":   agg.EnabledTransitions(),
		})
	}
}





// Helper functions

func getIntQueryParam(r *http.Request, name string, defaultVal int) int {
	val := r.URL.Query().Get(name)
	return getInt(val, defaultVal)
}

func getInt(s string, defaultVal int) int {
	if s == "" {
		return defaultVal
	}

	intVal, err := strconv.Atoi(s)
	if err != nil {
		return defaultVal
	}

	return intVal
}


// HandleGetSchema returns the model schema JSON for the schema viewer.
func HandleGetSchema() http.HandlerFunc {
	// Schema JSON is embedded at generation time (base64 encoded)
	schemaBase64 := "ewogICJuYW1lIjogImxvYW4tYXBwbGljYXRpb24iLAogICJkZXNjcmlwdGlvbiI6ICJBIGxvYW4gYXBwbGljYXRpb24gd29ya2Zsb3c6IHN1Ym1pdCDihpIgY3JlZGl0IGNoZWNrIOKGkiBtYW51YWwgcmV2aWV3IChpZiBuZWVkZWQpIOKGkiBhcHByb3ZlL2Rlbnkg4oaSIGRpc2J1cnNlbWVudCDihpIgcmVwYXltZW50IHRyYWNraW5nIOKGkiBjb21wbGV0aW9uIG9yIGRlZmF1bHQiLAogICJwbGFjZXMiOiBbCiAgICB7CiAgICAgICJpZCI6ICJzdWJtaXR0ZWQiLAogICAgICAiZGVzY3JpcHRpb24iOiAiQXBwbGljYXRpb24gc3VibWl0dGVkIGJ5IGN1c3RvbWVyIiwKICAgICAgImluaXRpYWwiOiAxLAogICAgICAia2luZCI6ICJ0b2tlbiIKICAgIH0sCiAgICB7CiAgICAgICJpZCI6ICJjcmVkaXRfY2hlY2siLAogICAgICAiZGVzY3JpcHRpb24iOiAiQXV0b21hdGVkIGNyZWRpdCBjaGVjayBpbiBwcm9ncmVzcyIsCiAgICAgICJpbml0aWFsIjogMCwKICAgICAgImtpbmQiOiAidG9rZW4iCiAgICB9LAogICAgewogICAgICAiaWQiOiAiYXV0b19hcHByb3ZlZCIsCiAgICAgICJkZXNjcmlwdGlvbiI6ICJQYXNzZWQgYXV0b21hdGljIGFwcHJvdmFsIGNyaXRlcmlhIiwKICAgICAgImluaXRpYWwiOiAwLAogICAgICAia2luZCI6ICJ0b2tlbiIKICAgIH0sCiAgICB7CiAgICAgICJpZCI6ICJtYW51YWxfcmV2aWV3IiwKICAgICAgImRlc2NyaXB0aW9uIjogIlJlcXVpcmVzIG1hbnVhbCB1bmRlcndyaXRlciByZXZpZXciLAogICAgICAiaW5pdGlhbCI6IDAsCiAgICAgICJraW5kIjogInRva2VuIgogICAgfSwKICAgIHsKICAgICAgImlkIjogImFwcHJvdmVkIiwKICAgICAgImRlc2NyaXB0aW9uIjogIkxvYW4gaGFzIGJlZW4gYXBwcm92ZWQiLAogICAgICAiaW5pdGlhbCI6IDAsCiAgICAgICJraW5kIjogInRva2VuIgogICAgfSwKICAgIHsKICAgICAgImlkIjogImRlbmllZCIsCiAgICAgICJkZXNjcmlwdGlvbiI6ICJMb2FuIGFwcGxpY2F0aW9uIGRlbmllZCIsCiAgICAgICJpbml0aWFsIjogMCwKICAgICAgImtpbmQiOiAidG9rZW4iCiAgICB9LAogICAgewogICAgICAiaWQiOiAiZGlzYnVyc2VkIiwKICAgICAgImRlc2NyaXB0aW9uIjogIkZ1bmRzIGhhdmUgYmVlbiBkaXNidXJzZWQiLAogICAgICAiaW5pdGlhbCI6IDAsCiAgICAgICJraW5kIjogInRva2VuIgogICAgfSwKICAgIHsKICAgICAgImlkIjogInJlcGF5aW5nIiwKICAgICAgImRlc2NyaXB0aW9uIjogIkxvYW4gaXMgYmVpbmcgcmVwYWlkIiwKICAgICAgImluaXRpYWwiOiAwLAogICAgICAia2luZCI6ICJ0b2tlbiIKICAgIH0sCiAgICB7CiAgICAgICJpZCI6ICJwYWlkX29mZiIsCiAgICAgICJkZXNjcmlwdGlvbiI6ICJMb2FuIGZ1bGx5IHJlcGFpZCIsCiAgICAgICJpbml0aWFsIjogMCwKICAgICAgImtpbmQiOiAidG9rZW4iCiAgICB9LAogICAgewogICAgICAiaWQiOiAiZGVmYXVsdGVkIiwKICAgICAgImRlc2NyaXB0aW9uIjogIkxvYW4gaGFzIGRlZmF1bHRlZCIsCiAgICAgICJpbml0aWFsIjogMCwKICAgICAgImtpbmQiOiAidG9rZW4iCiAgICB9CiAgXSwKICAidHJhbnNpdGlvbnMiOiBbCiAgICB7CiAgICAgICJpZCI6ICJydW5fY3JlZGl0X2NoZWNrIiwKICAgICAgImRlc2NyaXB0aW9uIjogIkluaXRpYXRlIGF1dG9tYXRlZCBjcmVkaXQgY2hlY2siLAogICAgICAiaHR0cF9tZXRob2QiOiAiUE9TVCIsCiAgICAgICJodHRwX3BhdGgiOiAiL2FwaS9ydW5fY3JlZGl0X2NoZWNrIiwKICAgICAgImV2ZW50X3R5cGUiOiAiUnVuQ3JlZGl0Q2hlY2tlZCIKICAgIH0sCiAgICB7CiAgICAgICJpZCI6ICJhdXRvX2FwcHJvdmUiLAogICAgICAiZGVzY3JpcHRpb24iOiAiQXV0b21hdGljIGFwcHJvdmFsIGJhc2VkIG9uIGNyZWRpdCBzY29yZSIsCiAgICAgICJodHRwX21ldGhvZCI6ICJQT1NUIiwKICAgICAgImh0dHBfcGF0aCI6ICIvYXBpL2F1dG9fYXBwcm92ZSIsCiAgICAgICJldmVudF90eXBlIjogIkF1dG9BcHByb3ZlZWQiCiAgICB9LAogICAgewogICAgICAiaWQiOiAiZmxhZ19mb3JfcmV2aWV3IiwKICAgICAgImRlc2NyaXB0aW9uIjogIkZsYWcgYXBwbGljYXRpb24gZm9yIG1hbnVhbCByZXZpZXciLAogICAgICAiaHR0cF9tZXRob2QiOiAiUE9TVCIsCiAgICAgICJodHRwX3BhdGgiOiAiL2FwaS9mbGFnX2Zvcl9yZXZpZXciLAogICAgICAiZXZlbnRfdHlwZSI6ICJGbGFnRm9yUmV2aWV3ZWQiCiAgICB9LAogICAgewogICAgICAiaWQiOiAidW5kZXJ3cml0ZXJfYXBwcm92ZSIsCiAgICAgICJkZXNjcmlwdGlvbiI6ICJVbmRlcndyaXRlciBhcHByb3ZlcyB0aGUgYXBwbGljYXRpb24iLAogICAgICAiaHR0cF9tZXRob2QiOiAiUE9TVCIsCiAgICAgICJodHRwX3BhdGgiOiAiL2FwaS91bmRlcndyaXRlcl9hcHByb3ZlIiwKICAgICAgImV2ZW50X3R5cGUiOiAiVW5kZXJ3cml0ZXJBcHByb3ZlZWQiCiAgICB9LAogICAgewogICAgICAiaWQiOiAidW5kZXJ3cml0ZXJfZGVueSIsCiAgICAgICJkZXNjcmlwdGlvbiI6ICJVbmRlcndyaXRlciBkZW5pZXMgdGhlIGFwcGxpY2F0aW9uIiwKICAgICAgImh0dHBfbWV0aG9kIjogIlBPU1QiLAogICAgICAiaHR0cF9wYXRoIjogIi9hcGkvdW5kZXJ3cml0ZXJfZGVueSIsCiAgICAgICJldmVudF90eXBlIjogIlVuZGVyd3JpdGVyRGVueWVkIgogICAgfSwKICAgIHsKICAgICAgImlkIjogImF1dG9fZGVueSIsCiAgICAgICJkZXNjcmlwdGlvbiI6ICJBdXRvbWF0aWMgZGVuaWFsIGJhc2VkIG9uIGNyZWRpdCBzY29yZSIsCiAgICAgICJodHRwX21ldGhvZCI6ICJQT1NUIiwKICAgICAgImh0dHBfcGF0aCI6ICIvYXBpL2F1dG9fZGVueSIsCiAgICAgICJldmVudF90eXBlIjogIkF1dG9EZW55ZWQiCiAgICB9LAogICAgewogICAgICAiaWQiOiAiZmluYWxpemVfYXBwcm92YWwiLAogICAgICAiZGVzY3JpcHRpb24iOiAiRmluYWxpemUgbG9hbiBhcHByb3ZhbCIsCiAgICAgICJodHRwX21ldGhvZCI6ICJQT1NUIiwKICAgICAgImh0dHBfcGF0aCI6ICIvYXBpL2ZpbmFsaXplX2FwcHJvdmFsIiwKICAgICAgImV2ZW50X3R5cGUiOiAiRmluYWxpemVBcHByb3ZhbGVkIgogICAgfSwKICAgIHsKICAgICAgImlkIjogImRpc2J1cnNlIiwKICAgICAgImRlc2NyaXB0aW9uIjogIkRpc2J1cnNlIGxvYW4gZnVuZHMgdG8gY3VzdG9tZXIiLAogICAgICAiaHR0cF9tZXRob2QiOiAiUE9TVCIsCiAgICAgICJodHRwX3BhdGgiOiAiL2FwaS9kaXNidXJzZSIsCiAgICAgICJldmVudF90eXBlIjogIkRpc2J1cnNlZWQiCiAgICB9LAogICAgewogICAgICAiaWQiOiAic3RhcnRfcmVwYXltZW50IiwKICAgICAgImRlc2NyaXB0aW9uIjogIkJlZ2luIHJlcGF5bWVudCBwZXJpb2QiLAogICAgICAiaHR0cF9tZXRob2QiOiAiUE9TVCIsCiAgICAgICJodHRwX3BhdGgiOiAiL2FwaS9zdGFydF9yZXBheW1lbnQiLAogICAgICAiZXZlbnRfdHlwZSI6ICJTdGFydFJlcGF5bWVudGVkIgogICAgfSwKICAgIHsKICAgICAgImlkIjogIm1ha2VfcGF5bWVudCIsCiAgICAgICJkZXNjcmlwdGlvbiI6ICJDdXN0b21lciBtYWtlcyBhIHBheW1lbnQiLAogICAgICAiaHR0cF9tZXRob2QiOiAiUE9TVCIsCiAgICAgICJodHRwX3BhdGgiOiAiL2FwaS9tYWtlX3BheW1lbnQiLAogICAgICAiZXZlbnRfdHlwZSI6ICJNYWtlUGF5bWVudGVkIgogICAgfSwKICAgIHsKICAgICAgImlkIjogImNvbXBsZXRlIiwKICAgICAgImRlc2NyaXB0aW9uIjogIkZpbmFsIHBheW1lbnQgcmVjZWl2ZWQsIGxvYW4gY29tcGxldGUiLAogICAgICAiaHR0cF9tZXRob2QiOiAiUE9TVCIsCiAgICAgICJodHRwX3BhdGgiOiAiL2FwaS9jb21wbGV0ZSIsCiAgICAgICJldmVudF90eXBlIjogIkNvbXBsZXRlZWQiCiAgICB9LAogICAgewogICAgICAiaWQiOiAibWFya19kZWZhdWx0IiwKICAgICAgImRlc2NyaXB0aW9uIjogIk1hcmsgbG9hbiBhcyBkZWZhdWx0ZWQiLAogICAgICAiaHR0cF9tZXRob2QiOiAiUE9TVCIsCiAgICAgICJodHRwX3BhdGgiOiAiL2FwaS9tYXJrX2RlZmF1bHQiLAogICAgICAiZXZlbnRfdHlwZSI6ICJNYXJrRGVmYXVsdGVkIgogICAgfQogIF0sCiAgImFyY3MiOiBbCiAgICB7CiAgICAgICJmcm9tIjogInN1Ym1pdHRlZCIsCiAgICAgICJ0byI6ICJydW5fY3JlZGl0X2NoZWNrIgogICAgfSwKICAgIHsKICAgICAgImZyb20iOiAicnVuX2NyZWRpdF9jaGVjayIsCiAgICAgICJ0byI6ICJjcmVkaXRfY2hlY2siCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJjcmVkaXRfY2hlY2siLAogICAgICAidG8iOiAiYXV0b19hcHByb3ZlIgogICAgfSwKICAgIHsKICAgICAgImZyb20iOiAiYXV0b19hcHByb3ZlIiwKICAgICAgInRvIjogImF1dG9fYXBwcm92ZWQiCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJjcmVkaXRfY2hlY2siLAogICAgICAidG8iOiAiZmxhZ19mb3JfcmV2aWV3IgogICAgfSwKICAgIHsKICAgICAgImZyb20iOiAiZmxhZ19mb3JfcmV2aWV3IiwKICAgICAgInRvIjogIm1hbnVhbF9yZXZpZXciCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJjcmVkaXRfY2hlY2siLAogICAgICAidG8iOiAiYXV0b19kZW55IgogICAgfSwKICAgIHsKICAgICAgImZyb20iOiAiYXV0b19kZW55IiwKICAgICAgInRvIjogImRlbmllZCIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogIm1hbnVhbF9yZXZpZXciLAogICAgICAidG8iOiAidW5kZXJ3cml0ZXJfYXBwcm92ZSIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogInVuZGVyd3JpdGVyX2FwcHJvdmUiLAogICAgICAidG8iOiAiYXBwcm92ZWQiCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJtYW51YWxfcmV2aWV3IiwKICAgICAgInRvIjogInVuZGVyd3JpdGVyX2RlbnkiCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJ1bmRlcndyaXRlcl9kZW55IiwKICAgICAgInRvIjogImRlbmllZCIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogImF1dG9fYXBwcm92ZWQiLAogICAgICAidG8iOiAiZmluYWxpemVfYXBwcm92YWwiCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJmaW5hbGl6ZV9hcHByb3ZhbCIsCiAgICAgICJ0byI6ICJhcHByb3ZlZCIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogImFwcHJvdmVkIiwKICAgICAgInRvIjogImRpc2J1cnNlIgogICAgfSwKICAgIHsKICAgICAgImZyb20iOiAiZGlzYnVyc2UiLAogICAgICAidG8iOiAiZGlzYnVyc2VkIgogICAgfSwKICAgIHsKICAgICAgImZyb20iOiAiZGlzYnVyc2VkIiwKICAgICAgInRvIjogInN0YXJ0X3JlcGF5bWVudCIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogInN0YXJ0X3JlcGF5bWVudCIsCiAgICAgICJ0byI6ICJyZXBheWluZyIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogInJlcGF5aW5nIiwKICAgICAgInRvIjogIm1ha2VfcGF5bWVudCIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogIm1ha2VfcGF5bWVudCIsCiAgICAgICJ0byI6ICJyZXBheWluZyIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogInJlcGF5aW5nIiwKICAgICAgInRvIjogImNvbXBsZXRlIgogICAgfSwKICAgIHsKICAgICAgImZyb20iOiAiY29tcGxldGUiLAogICAgICAidG8iOiAicGFpZF9vZmYiCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJyZXBheWluZyIsCiAgICAgICJ0byI6ICJtYXJrX2RlZmF1bHQiCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJtYXJrX2RlZmF1bHQiLAogICAgICAidG8iOiAiZGVmYXVsdGVkIgogICAgfQogIF0sCiAgInJvbGVzIjogWwogICAgewogICAgICAiaWQiOiAiYXBwbGljYW50IiwKICAgICAgIm5hbWUiOiAiQXBwbGljYW50IiwKICAgICAgImRlc2NyaXB0aW9uIjogIkN1c3RvbWVyIGFwcGx5aW5nIGZvciBhIGxvYW4iCiAgICB9LAogICAgewogICAgICAiaWQiOiAic3lzdGVtIiwKICAgICAgIm5hbWUiOiAiU3lzdGVtIiwKICAgICAgImRlc2NyaXB0aW9uIjogIkF1dG9tYXRlZCBjcmVkaXQgY2hlY2sgYW5kIHByb2Nlc3Npbmcgc3lzdGVtIgogICAgfSwKICAgIHsKICAgICAgImlkIjogInVuZGVyd3JpdGVyIiwKICAgICAgIm5hbWUiOiAiVW5kZXJ3cml0ZXIiLAogICAgICAiZGVzY3JpcHRpb24iOiAiTG9hbiB1bmRlcndyaXRlciB3aG8gcmV2aWV3cyBhcHBsaWNhdGlvbnMiCiAgICB9LAogICAgewogICAgICAiaWQiOiAiYWRtaW4iLAogICAgICAibmFtZSI6ICJBZG1pbmlzdHJhdG9yIiwKICAgICAgImRlc2NyaXB0aW9uIjogIkZ1bGwgYWNjZXNzIHRvIGFsbCBvcGVyYXRpb25zIiwKICAgICAgImluaGVyaXRzIjogWwogICAgICAgICJ1bmRlcndyaXRlciIKICAgICAgXQogICAgfQogIF0sCiAgImFjY2VzcyI6IFsKICAgIHsKICAgICAgInRyYW5zaXRpb24iOiAicnVuX2NyZWRpdF9jaGVjayIsCiAgICAgICJyb2xlcyI6IFsKICAgICAgICAic3lzdGVtIgogICAgICBdCiAgICB9LAogICAgewogICAgICAidHJhbnNpdGlvbiI6ICJhdXRvX2FwcHJvdmUiLAogICAgICAicm9sZXMiOiBbCiAgICAgICAgInN5c3RlbSIKICAgICAgXQogICAgfSwKICAgIHsKICAgICAgInRyYW5zaXRpb24iOiAiZmxhZ19mb3JfcmV2aWV3IiwKICAgICAgInJvbGVzIjogWwogICAgICAgICJzeXN0ZW0iCiAgICAgIF0KICAgIH0sCiAgICB7CiAgICAgICJ0cmFuc2l0aW9uIjogImF1dG9fZGVueSIsCiAgICAgICJyb2xlcyI6IFsKICAgICAgICAic3lzdGVtIgogICAgICBdCiAgICB9LAogICAgewogICAgICAidHJhbnNpdGlvbiI6ICJ1bmRlcndyaXRlcl9hcHByb3ZlIiwKICAgICAgInJvbGVzIjogWwogICAgICAgICJ1bmRlcndyaXRlciIKICAgICAgXQogICAgfSwKICAgIHsKICAgICAgInRyYW5zaXRpb24iOiAidW5kZXJ3cml0ZXJfZGVueSIsCiAgICAgICJyb2xlcyI6IFsKICAgICAgICAidW5kZXJ3cml0ZXIiCiAgICAgIF0KICAgIH0sCiAgICB7CiAgICAgICJ0cmFuc2l0aW9uIjogImZpbmFsaXplX2FwcHJvdmFsIiwKICAgICAgInJvbGVzIjogWwogICAgICAgICJzeXN0ZW0iCiAgICAgIF0KICAgIH0sCiAgICB7CiAgICAgICJ0cmFuc2l0aW9uIjogImRpc2J1cnNlIiwKICAgICAgInJvbGVzIjogWwogICAgICAgICJhZG1pbiIKICAgICAgXQogICAgfSwKICAgIHsKICAgICAgInRyYW5zaXRpb24iOiAic3RhcnRfcmVwYXltZW50IiwKICAgICAgInJvbGVzIjogWwogICAgICAgICJzeXN0ZW0iCiAgICAgIF0KICAgIH0sCiAgICB7CiAgICAgICJ0cmFuc2l0aW9uIjogIm1ha2VfcGF5bWVudCIsCiAgICAgICJyb2xlcyI6IFsKICAgICAgICAiYXBwbGljYW50IgogICAgICBdCiAgICB9LAogICAgewogICAgICAidHJhbnNpdGlvbiI6ICJjb21wbGV0ZSIsCiAgICAgICJyb2xlcyI6IFsKICAgICAgICAic3lzdGVtIgogICAgICBdCiAgICB9LAogICAgewogICAgICAidHJhbnNpdGlvbiI6ICJtYXJrX2RlZmF1bHQiLAogICAgICAicm9sZXMiOiBbCiAgICAgICAgImFkbWluIgogICAgICBdCiAgICB9CiAgXSwKICAidmlld3MiOiBbCiAgICB7CiAgICAgICJpZCI6ICJsb2FuLXRhYmxlIiwKICAgICAgIm5hbWUiOiAiTG9hbnMgTGlzdCIsCiAgICAgICJraW5kIjogInRhYmxlIiwKICAgICAgImRlc2NyaXB0aW9uIjogIkxpc3QgdmlldyBvZiBhbGwgbG9hbiBhcHBsaWNhdGlvbnMiLAogICAgICAiZ3JvdXBzIjogWwogICAgICAgIHsKICAgICAgICAgICJpZCI6ICJjb2x1bW5zIiwKICAgICAgICAgICJmaWVsZHMiOiBbCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAiYmluZGluZyI6ICJhcHBsaWNhdGlvbl9pZCIsCiAgICAgICAgICAgICAgImxhYmVsIjogIkFwcGxpY2F0aW9uIElEIiwKICAgICAgICAgICAgICAidHlwZSI6ICJ0ZXh0IiwKICAgICAgICAgICAgICAicmVhZG9ubHkiOiB0cnVlCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAiYmluZGluZyI6ICJhcHBsaWNhbnRfbmFtZSIsCiAgICAgICAgICAgICAgImxhYmVsIjogIkFwcGxpY2FudCIsCiAgICAgICAgICAgICAgInR5cGUiOiAidGV4dCIsCiAgICAgICAgICAgICAgInJlYWRvbmx5IjogdHJ1ZQogICAgICAgICAgICB9LAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgImJpbmRpbmciOiAiYW1vdW50IiwKICAgICAgICAgICAgICAibGFiZWwiOiAiQW1vdW50IiwKICAgICAgICAgICAgICAidHlwZSI6ICJudW1iZXIiLAogICAgICAgICAgICAgICJyZWFkb25seSI6IHRydWUKICAgICAgICAgICAgfSwKICAgICAgICAgICAgewogICAgICAgICAgICAgICJiaW5kaW5nIjogInN0YXR1cyIsCiAgICAgICAgICAgICAgImxhYmVsIjogIlN0YXR1cyIsCiAgICAgICAgICAgICAgInR5cGUiOiAidGV4dCIsCiAgICAgICAgICAgICAgInJlYWRvbmx5IjogdHJ1ZQogICAgICAgICAgICB9LAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgImJpbmRpbmciOiAic3VibWl0dGVkX2F0IiwKICAgICAgICAgICAgICAibGFiZWwiOiAiU3VibWl0dGVkIiwKICAgICAgICAgICAgICAidHlwZSI6ICJkYXRlIiwKICAgICAgICAgICAgICAicmVhZG9ubHkiOiB0cnVlCiAgICAgICAgICAgIH0KICAgICAgICAgIF0KICAgICAgICB9CiAgICAgIF0sCiAgICAgICJhY3Rpb25zIjogWwogICAgICAgICJ1bmRlcndyaXRlcl9hcHByb3ZlIiwKICAgICAgICAidW5kZXJ3cml0ZXJfZGVueSIsCiAgICAgICAgImRpc2J1cnNlIgogICAgICBdCiAgICB9LAogICAgewogICAgICAiaWQiOiAibG9hbi1kZXRhaWwiLAogICAgICAibmFtZSI6ICJMb2FuIERldGFpbCIsCiAgICAgICJraW5kIjogImRldGFpbCIsCiAgICAgICJkZXNjcmlwdGlvbiI6ICJGdWxsIGxvYW4gYXBwbGljYXRpb24gZGV0YWlscyIsCiAgICAgICJncm91cHMiOiBbCiAgICAgICAgewogICAgICAgICAgImlkIjogImFwcGxpY2FudCIsCiAgICAgICAgICAibmFtZSI6ICJBcHBsaWNhbnQgSW5mb3JtYXRpb24iLAogICAgICAgICAgImZpZWxkcyI6IFsKICAgICAgICAgICAgewogICAgICAgICAgICAgICJiaW5kaW5nIjogImFwcGxpY2FudF9uYW1lIiwKICAgICAgICAgICAgICAibGFiZWwiOiAiTmFtZSIsCiAgICAgICAgICAgICAgInR5cGUiOiAidGV4dCIsCiAgICAgICAgICAgICAgInJlYWRvbmx5IjogdHJ1ZQogICAgICAgICAgICB9LAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgImJpbmRpbmciOiAiYXBwbGljYW50X2VtYWlsIiwKICAgICAgICAgICAgICAibGFiZWwiOiAiRW1haWwiLAogICAgICAgICAgICAgICJ0eXBlIjogImVtYWlsIiwKICAgICAgICAgICAgICAicmVhZG9ubHkiOiB0cnVlCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAiYmluZGluZyI6ICJhcHBsaWNhbnRfcGhvbmUiLAogICAgICAgICAgICAgICJsYWJlbCI6ICJQaG9uZSIsCiAgICAgICAgICAgICAgInR5cGUiOiAidGV4dCIsCiAgICAgICAgICAgICAgInJlYWRvbmx5IjogdHJ1ZQogICAgICAgICAgICB9LAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgImJpbmRpbmciOiAiYW5udWFsX2luY29tZSIsCiAgICAgICAgICAgICAgImxhYmVsIjogIkFubnVhbCBJbmNvbWUiLAogICAgICAgICAgICAgICJ0eXBlIjogIm51bWJlciIsCiAgICAgICAgICAgICAgInJlYWRvbmx5IjogdHJ1ZQogICAgICAgICAgICB9CiAgICAgICAgICBdCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAiaWQiOiAibG9hbiIsCiAgICAgICAgICAibmFtZSI6ICJMb2FuIERldGFpbHMiLAogICAgICAgICAgImZpZWxkcyI6IFsKICAgICAgICAgICAgewogICAgICAgICAgICAgICJiaW5kaW5nIjogImFtb3VudCIsCiAgICAgICAgICAgICAgImxhYmVsIjogIkxvYW4gQW1vdW50IiwKICAgICAgICAgICAgICAidHlwZSI6ICJudW1iZXIiLAogICAgICAgICAgICAgICJyZWFkb25seSI6IHRydWUKICAgICAgICAgICAgfSwKICAgICAgICAgICAgewogICAgICAgICAgICAgICJiaW5kaW5nIjogInRlcm1fbW9udGhzIiwKICAgICAgICAgICAgICAibGFiZWwiOiAiVGVybSAoTW9udGhzKSIsCiAgICAgICAgICAgICAgInR5cGUiOiAibnVtYmVyIiwKICAgICAgICAgICAgICAicmVhZG9ubHkiOiB0cnVlCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAiYmluZGluZyI6ICJpbnRlcmVzdF9yYXRlIiwKICAgICAgICAgICAgICAibGFiZWwiOiAiSW50ZXJlc3QgUmF0ZSIsCiAgICAgICAgICAgICAgInR5cGUiOiAibnVtYmVyIiwKICAgICAgICAgICAgICAicmVhZG9ubHkiOiB0cnVlCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAiYmluZGluZyI6ICJwdXJwb3NlIiwKICAgICAgICAgICAgICAibGFiZWwiOiAiUHVycG9zZSIsCiAgICAgICAgICAgICAgInR5cGUiOiAidGV4dCIsCiAgICAgICAgICAgICAgInJlYWRvbmx5IjogdHJ1ZQogICAgICAgICAgICB9CiAgICAgICAgICBdCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAiaWQiOiAiY3JlZGl0IiwKICAgICAgICAgICJuYW1lIjogIkNyZWRpdCBJbmZvcm1hdGlvbiIsCiAgICAgICAgICAiZmllbGRzIjogWwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgImJpbmRpbmciOiAiY3JlZGl0X3Njb3JlIiwKICAgICAgICAgICAgICAibGFiZWwiOiAiQ3JlZGl0IFNjb3JlIiwKICAgICAgICAgICAgICAidHlwZSI6ICJudW1iZXIiLAogICAgICAgICAgICAgICJyZWFkb25seSI6IHRydWUKICAgICAgICAgICAgfSwKICAgICAgICAgICAgewogICAgICAgICAgICAgICJiaW5kaW5nIjogImRlYnRfdG9faW5jb21lIiwKICAgICAgICAgICAgICAibGFiZWwiOiAiRGVidC10by1JbmNvbWUgUmF0aW8iLAogICAgICAgICAgICAgICJ0eXBlIjogIm51bWJlciIsCiAgICAgICAgICAgICAgInJlYWRvbmx5IjogdHJ1ZQogICAgICAgICAgICB9CiAgICAgICAgICBdCiAgICAgICAgfQogICAgICBdLAogICAgICAiYWN0aW9ucyI6IFsKICAgICAgICAidW5kZXJ3cml0ZXJfYXBwcm92ZSIsCiAgICAgICAgInVuZGVyd3JpdGVyX2RlbnkiLAogICAgICAgICJkaXNidXJzZSIsCiAgICAgICAgIm1ha2VfcGF5bWVudCIsCiAgICAgICAgIm1hcmtfZGVmYXVsdCIKICAgICAgXQogICAgfSwKICAgIHsKICAgICAgImlkIjogImxvYW4tYXBwbGljYXRpb24tZm9ybSIsCiAgICAgICJuYW1lIjogIkxvYW4gQXBwbGljYXRpb24iLAogICAgICAia2luZCI6ICJmb3JtIiwKICAgICAgImRlc2NyaXB0aW9uIjogIkZvcm0gZm9yIHN1Ym1pdHRpbmcgYSBsb2FuIGFwcGxpY2F0aW9uIiwKICAgICAgImdyb3VwcyI6IFsKICAgICAgICB7CiAgICAgICAgICAiaWQiOiAicGVyc29uYWwiLAogICAgICAgICAgIm5hbWUiOiAiUGVyc29uYWwgSW5mb3JtYXRpb24iLAogICAgICAgICAgImZpZWxkcyI6IFsKICAgICAgICAgICAgewogICAgICAgICAgICAgICJiaW5kaW5nIjogImFwcGxpY2FudF9uYW1lIiwKICAgICAgICAgICAgICAibGFiZWwiOiAiRnVsbCBOYW1lIiwKICAgICAgICAgICAgICAidHlwZSI6ICJ0ZXh0IiwKICAgICAgICAgICAgICAicmVxdWlyZWQiOiB0cnVlCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAiYmluZGluZyI6ICJhcHBsaWNhbnRfZW1haWwiLAogICAgICAgICAgICAgICJsYWJlbCI6ICJFbWFpbCIsCiAgICAgICAgICAgICAgInR5cGUiOiAiZW1haWwiLAogICAgICAgICAgICAgICJyZXF1aXJlZCI6IHRydWUKICAgICAgICAgICAgfSwKICAgICAgICAgICAgewogICAgICAgICAgICAgICJiaW5kaW5nIjogImFwcGxpY2FudF9waG9uZSIsCiAgICAgICAgICAgICAgImxhYmVsIjogIlBob25lIiwKICAgICAgICAgICAgICAidHlwZSI6ICJ0ZXh0IiwKICAgICAgICAgICAgICAicmVxdWlyZWQiOiB0cnVlCiAgICAgICAgICAgIH0KICAgICAgICAgIF0KICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICJpZCI6ICJsb2FuIiwKICAgICAgICAgICJuYW1lIjogIkxvYW4gUmVxdWVzdCIsCiAgICAgICAgICAiZmllbGRzIjogWwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgImJpbmRpbmciOiAiYW1vdW50IiwKICAgICAgICAgICAgICAibGFiZWwiOiAiUmVxdWVzdGVkIEFtb3VudCIsCiAgICAgICAgICAgICAgInR5cGUiOiAibnVtYmVyIiwKICAgICAgICAgICAgICAicmVxdWlyZWQiOiB0cnVlLAogICAgICAgICAgICAgICJwbGFjZWhvbGRlciI6ICIxMDAwMCIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgewogICAgICAgICAgICAgICJiaW5kaW5nIjogInRlcm1fbW9udGhzIiwKICAgICAgICAgICAgICAibGFiZWwiOiAiTG9hbiBUZXJtIChNb250aHMpIiwKICAgICAgICAgICAgICAidHlwZSI6ICJudW1iZXIiLAogICAgICAgICAgICAgICJyZXF1aXJlZCI6IHRydWUKICAgICAgICAgICAgfSwKICAgICAgICAgICAgewogICAgICAgICAgICAgICJiaW5kaW5nIjogInB1cnBvc2UiLAogICAgICAgICAgICAgICJsYWJlbCI6ICJQdXJwb3NlIiwKICAgICAgICAgICAgICAidHlwZSI6ICJ0ZXh0IiwKICAgICAgICAgICAgICAicmVxdWlyZWQiOiB0cnVlCiAgICAgICAgICAgIH0KICAgICAgICAgIF0KICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICJpZCI6ICJpbmNvbWUiLAogICAgICAgICAgIm5hbWUiOiAiSW5jb21lIEluZm9ybWF0aW9uIiwKICAgICAgICAgICJmaWVsZHMiOiBbCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAiYmluZGluZyI6ICJhbm51YWxfaW5jb21lIiwKICAgICAgICAgICAgICAibGFiZWwiOiAiQW5udWFsIEluY29tZSIsCiAgICAgICAgICAgICAgInR5cGUiOiAibnVtYmVyIiwKICAgICAgICAgICAgICAicmVxdWlyZWQiOiB0cnVlCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAiYmluZGluZyI6ICJlbXBsb3llciIsCiAgICAgICAgICAgICAgImxhYmVsIjogIkVtcGxveWVyIiwKICAgICAgICAgICAgICAidHlwZSI6ICJ0ZXh0IiwKICAgICAgICAgICAgICAicmVxdWlyZWQiOiB0cnVlCiAgICAgICAgICAgIH0KICAgICAgICAgIF0KICAgICAgICB9CiAgICAgIF0sCiAgICAgICJhY3Rpb25zIjogWwogICAgICAgICJydW5fY3JlZGl0X2NoZWNrIgogICAgICBdCiAgICB9CiAgXSwKICAiZGVidWciOiB7CiAgICAiZW5hYmxlZCI6IHRydWUsCiAgICAiZXZhbCI6IHRydWUKICB9LAogICJibG9ic3RvcmUiOiB7CiAgICAiZW5hYmxlZCI6IHRydWUsCiAgICAibWF4U2l6ZSI6IDUyNDI4ODAwLAogICAgImFsbG93ZWRUeXBlcyI6IFsKICAgICAgImFwcGxpY2F0aW9uL2pzb24iLAogICAgICAiYXBwbGljYXRpb24vcGRmIiwKICAgICAgImltYWdlLyoiCiAgICBdCiAgfSwKICAiY29tbWVudHMiOiB7CiAgICAiZW5hYmxlZCI6IHRydWUsCiAgICAibWF4TGVuZ3RoIjogMjAwMAogIH0sCiAgInRhZ3MiOiB7CiAgICAiZW5hYmxlZCI6IHRydWUsCiAgICAicHJlZGVmaW5lZCI6IFsKICAgICAgInVyZ2VudCIsCiAgICAgICJoaWdoLXZhbHVlIiwKICAgICAgImZpcnN0LXRpbWUiLAogICAgICAicmV0dXJuaW5nIiwKICAgICAgImZsYWdnZWQiCiAgICBdLAogICAgIm1heFRhZ3MiOiAxMAogIH0sCiAgImFjdGl2aXR5IjogewogICAgImVuYWJsZWQiOiB0cnVlCiAgfSwKICAic29mdERlbGV0ZSI6IHsKICAgICJlbmFibGVkIjogdHJ1ZQogIH0KfQ=="

	return func(w http.ResponseWriter, r *http.Request) {
		schemaJSON, err := base64.StdEncoding.DecodeString(schemaBase64)
		if err != nil {
			api.Error(w, http.StatusInternalServerError, "schema_decode_error", "Failed to decode schema")
			return
		}
		w.Header().Set("Content-Type", "application/json")
		w.WriteHeader(http.StatusOK)
		w.Write(schemaJSON)
	}
}

