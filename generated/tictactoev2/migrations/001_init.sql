-- Migration: 001_init_tictactoev2
-- Generated by petri-pilot. DO NOT EDIT.
--
-- Event store schema for tic-tac-toe workflow

-- Events table: append-only event log
CREATE TABLE IF NOT EXISTS events (
    id TEXT PRIMARY KEY,
    stream_id TEXT NOT NULL,
    type TEXT NOT NULL,
    version INTEGER NOT NULL,
    data TEXT NOT NULL,  -- JSON
    metadata TEXT,       -- JSON, optional
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(stream_id, version)
);

-- Indexes for common query patterns
CREATE INDEX IF NOT EXISTS idx_events_stream_id ON events(stream_id);
CREATE INDEX IF NOT EXISTS idx_events_stream_version ON events(stream_id, version);
CREATE INDEX IF NOT EXISTS idx_events_type ON events(type);
CREATE INDEX IF NOT EXISTS idx_events_timestamp ON events(timestamp);

-- Snapshots table: periodic aggregate state snapshots for faster replay
CREATE TABLE IF NOT EXISTS snapshots (
    stream_id TEXT PRIMARY KEY,
    version INTEGER NOT NULL,
    state TEXT NOT NULL,  -- JSON
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- Projection: tic-tac-toe aggregate state
-- Denormalized view for fast reads
CREATE TABLE IF NOT EXISTS "tictactoev2_state" (
    id TEXT PRIMARY KEY,
    version INTEGER NOT NULL DEFAULT 0,
    "p00" INTEGER DEFAULT 0,
    "p01" INTEGER DEFAULT 0,
    "p02" INTEGER DEFAULT 0,
    "p10" INTEGER DEFAULT 0,
    "p11" INTEGER DEFAULT 0,
    "p12" INTEGER DEFAULT 0,
    "p20" INTEGER DEFAULT 0,
    "p21" INTEGER DEFAULT 0,
    "p22" INTEGER DEFAULT 0,
    "x00" INTEGER DEFAULT 0,
    "x01" INTEGER DEFAULT 0,
    "x02" INTEGER DEFAULT 0,
    "x10" INTEGER DEFAULT 0,
    "x11" INTEGER DEFAULT 0,
    "x12" INTEGER DEFAULT 0,
    "x20" INTEGER DEFAULT 0,
    "x21" INTEGER DEFAULT 0,
    "x22" INTEGER DEFAULT 0,
    "o00" INTEGER DEFAULT 0,
    "o01" INTEGER DEFAULT 0,
    "o02" INTEGER DEFAULT 0,
    "o10" INTEGER DEFAULT 0,
    "o11" INTEGER DEFAULT 0,
    "o12" INTEGER DEFAULT 0,
    "o20" INTEGER DEFAULT 0,
    "o21" INTEGER DEFAULT 0,
    "o22" INTEGER DEFAULT 0,
    "x_turn" INTEGER DEFAULT 0,
    "o_turn" INTEGER DEFAULT 0,
    "win_x" INTEGER DEFAULT 0,
    "win_o" INTEGER DEFAULT 0,
    "can_reset" INTEGER DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX IF NOT EXISTS "idx_tictactoev2_state_updated" ON "tictactoev2_state"(updated_at);

-- Place tokens tracking (Petri net state)
CREATE TABLE IF NOT EXISTS "tictactoev2_places" (
    aggregate_id TEXT NOT NULL,
    place_id TEXT NOT NULL,
    tokens INTEGER NOT NULL DEFAULT 0,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (aggregate_id, place_id)
);

-- Event type constants for reference:
-- XPlayed
-- OPlayed
-- GameReset
-- XWinRow0ed
-- XWinRow1ed
-- XWinRow2ed
-- XWinCol0ed
-- XWinCol1ed
-- XWinCol2ed
-- XWinDiaged
-- XWinAntied
-- OWinRow0ed
-- OWinRow1ed
-- OWinRow2ed
-- OWinCol0ed
-- OWinCol1ed
-- OWinCol2ed
-- OWinDiaged
-- OWinAntied

-- Place constants for reference:
-- p00: Cell (0,0) empty
-- p01: Cell (0,1) empty
-- p02: Cell (0,2) empty
-- p10: Cell (1,0) empty
-- p11: Cell (1,1) empty - center
-- p12: Cell (1,2) empty
-- p20: Cell (2,0) empty
-- p21: Cell (2,1) empty
-- p22: Cell (2,2) empty
-- x00: X piece at (0,0)
-- x01: X piece at (0,1)
-- x02: X piece at (0,2)
-- x10: X piece at (1,0)
-- x11: X piece at (1,1)
-- x12: X piece at (1,2)
-- x20: X piece at (2,0)
-- x21: X piece at (2,1)
-- x22: X piece at (2,2)
-- o00: O piece at (0,0)
-- o01: O piece at (0,1)
-- o02: O piece at (0,2)
-- o10: O piece at (1,0)
-- o11: O piece at (1,1)
-- o12: O piece at (1,2)
-- o20: O piece at (2,0)
-- o21: O piece at (2,1)
-- o22: O piece at (2,2)
-- x_turn: X's turn to play
-- o_turn: O's turn to play
-- win_x: X has won
-- win_o: O has won
-- can_reset: Token enabling reset action

-- Transition constants for reference:
-- x_play_00: X plays at (0,0)
-- x_play_01: X plays at (0,1)
-- x_play_02: X plays at (0,2)
-- x_play_10: X plays at (1,0)
-- x_play_11: X plays at (1,1) - center
-- x_play_12: X plays at (1,2)
-- x_play_20: X plays at (2,0)
-- x_play_21: X plays at (2,1)
-- x_play_22: X plays at (2,2)
-- o_play_00: O plays at (0,0)
-- o_play_01: O plays at (0,1)
-- o_play_02: O plays at (0,2)
-- o_play_10: O plays at (1,0)
-- o_play_11: O plays at (1,1) - center
-- o_play_12: O plays at (1,2)
-- o_play_20: O plays at (2,0)
-- o_play_21: O plays at (2,1)
-- o_play_22: O plays at (2,2)
-- reset: Reset game to initial state
-- x_win_row0: X wins top row (0,0)-(0,1)-(0,2)
-- x_win_row1: X wins middle row (1,0)-(1,1)-(1,2)
-- x_win_row2: X wins bottom row (2,0)-(2,1)-(2,2)
-- x_win_col0: X wins left column (0,0)-(1,0)-(2,0)
-- x_win_col1: X wins center column (0,1)-(1,1)-(2,1)
-- x_win_col2: X wins right column (0,2)-(1,2)-(2,2)
-- x_win_diag: X wins main diagonal (0,0)-(1,1)-(2,2)
-- x_win_anti: X wins anti-diagonal (0,2)-(1,1)-(2,0)
-- o_win_row0: O wins top row (0,0)-(0,1)-(0,2)
-- o_win_row1: O wins middle row (1,0)-(1,1)-(1,2)
-- o_win_row2: O wins bottom row (2,0)-(2,1)-(2,2)
-- o_win_col0: O wins left column (0,0)-(1,0)-(2,0)
-- o_win_col1: O wins center column (0,1)-(1,1)-(2,1)
-- o_win_col2: O wins right column (0,2)-(1,2)-(2,2)
-- o_win_diag: O wins main diagonal (0,0)-(1,1)-(2,2)
-- o_win_anti: O wins anti-diagonal (0,2)-(1,1)-(2,0)
