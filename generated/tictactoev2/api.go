// Code generated by petri-pilot. DO NOT EDIT.

package tictactoev2

import (
	"context"
	"encoding/base64"
	"io/fs"
	"net/http"
	"os"
	"path/filepath"
	"strconv"
	"strings"

	"github.com/pflow-xyz/petri-pilot/pkg/runtime/api"
	"github.com/pflow-xyz/go-pflow/eventsource"
)

// BuildRouter creates an HTTP router for the tic-tac-toe workflow.
func BuildRouter(app *Application, debugBroker *DebugBroker, softDeleteStore *SoftDeleteStore) http.Handler {
	r := api.NewRouter()

	// Health check - always returns ok if server is running
	r.GET("/health", "Health check", func(w http.ResponseWriter, r *http.Request) {
		api.JSON(w, http.StatusOK, map[string]string{"status": "ok"})
	})

	// Readiness check - verifies dependencies (database, etc.)
	r.GET("/ready", "Readiness check", HandleReady(app))

	// Create new aggregate
	r.POST("/api/tictactoe", "Create new tic-tac-toe", HandleCreate(app))

	// Get aggregate state
	r.GET("/api/tictactoe/{id}", "Get tic-tac-toe state", HandleGetState(app))


	// Schema viewer endpoint
	r.GET("/api/schema", "Get model schema", HandleGetSchema())


	// Admin endpoints
	r.GET("/admin/stats", "Admin statistics", HandleAdminStats(app))
	r.GET("/admin/instances", "List instances", HandleAdminListInstances(app, softDeleteStore))
	r.GET("/admin/instances/{id}", "Get instance detail", HandleAdminGetInstance(app))
	r.GET("/admin/instances/{id}/events", "Get instance events", HandleAdminGetEvents(app))
	r.DELETE("/admin/instances/{id}", "Delete instance permanently", HandleAdminDeleteInstance(app))
	r.POST("/admin/instances/{id}/archive", "Archive instance (soft delete)", HandleAdminArchiveInstance(softDeleteStore))
	r.POST("/admin/instances/{id}/restore", "Restore archived instance", HandleAdminRestoreInstance(softDeleteStore))


	// Event replay endpoints
	r.GET("/api/tictactoe/{id}/events", "Get event history", HandleGetEvents(app))
	r.GET("/api/tictactoe/{id}/at/{version}", "Get state at version", HandleGetStateAtVersion(app))






	// Debug WebSocket and eval endpoints
	r.GET("/ws", "Debug WebSocket connection", HandleDebugWebSocket(debugBroker))
	r.GET("/api/debug/sessions", "List debug sessions", HandleListSessions(debugBroker))
	r.POST("/api/debug/sessions/{id}/eval", "Evaluate code in browser session", HandleSessionEval(debugBroker))

















	// Soft delete endpoints
	r.Handle("DELETE", "/api/tictactoe/{id}", "Soft delete entity", softDeleteStore.HandleSoftDelete)
	r.POST("/api/tictactoe/{id}/restore", "Restore deleted entity", softDeleteStore.HandleRestore)

	// Transition endpoints
	r.Transition("x_play_00", "/api/x_play_00", "X plays at (0,0)", HandleXPlay00(app))
	r.Transition("x_play_01", "/api/x_play_01", "X plays at (0,1)", HandleXPlay01(app))
	r.Transition("x_play_02", "/api/x_play_02", "X plays at (0,2)", HandleXPlay02(app))
	r.Transition("x_play_10", "/api/x_play_10", "X plays at (1,0)", HandleXPlay10(app))
	r.Transition("x_play_11", "/api/x_play_11", "X plays at (1,1) - center", HandleXPlay11(app))
	r.Transition("x_play_12", "/api/x_play_12", "X plays at (1,2)", HandleXPlay12(app))
	r.Transition("x_play_20", "/api/x_play_20", "X plays at (2,0)", HandleXPlay20(app))
	r.Transition("x_play_21", "/api/x_play_21", "X plays at (2,1)", HandleXPlay21(app))
	r.Transition("x_play_22", "/api/x_play_22", "X plays at (2,2)", HandleXPlay22(app))
	r.Transition("o_play_00", "/api/o_play_00", "O plays at (0,0)", HandleOPlay00(app))
	r.Transition("o_play_01", "/api/o_play_01", "O plays at (0,1)", HandleOPlay01(app))
	r.Transition("o_play_02", "/api/o_play_02", "O plays at (0,2)", HandleOPlay02(app))
	r.Transition("o_play_10", "/api/o_play_10", "O plays at (1,0)", HandleOPlay10(app))
	r.Transition("o_play_11", "/api/o_play_11", "O plays at (1,1) - center", HandleOPlay11(app))
	r.Transition("o_play_12", "/api/o_play_12", "O plays at (1,2)", HandleOPlay12(app))
	r.Transition("o_play_20", "/api/o_play_20", "O plays at (2,0)", HandleOPlay20(app))
	r.Transition("o_play_21", "/api/o_play_21", "O plays at (2,1)", HandleOPlay21(app))
	r.Transition("o_play_22", "/api/o_play_22", "O plays at (2,2)", HandleOPlay22(app))
	r.Transition("reset", "/api/reset", "Reset game to initial state", HandleReset(app))
	r.Transition("x_win_row0", "/api/x_win_row0", "X wins top row (0,0)-(0,1)-(0,2)", HandleXWinRow0(app))
	r.Transition("x_win_row1", "/api/x_win_row1", "X wins middle row (1,0)-(1,1)-(1,2)", HandleXWinRow1(app))
	r.Transition("x_win_row2", "/api/x_win_row2", "X wins bottom row (2,0)-(2,1)-(2,2)", HandleXWinRow2(app))
	r.Transition("x_win_col0", "/api/x_win_col0", "X wins left column (0,0)-(1,0)-(2,0)", HandleXWinCol0(app))
	r.Transition("x_win_col1", "/api/x_win_col1", "X wins center column (0,1)-(1,1)-(2,1)", HandleXWinCol1(app))
	r.Transition("x_win_col2", "/api/x_win_col2", "X wins right column (0,2)-(1,2)-(2,2)", HandleXWinCol2(app))
	r.Transition("x_win_diag", "/api/x_win_diag", "X wins main diagonal (0,0)-(1,1)-(2,2)", HandleXWinDiag(app))
	r.Transition("x_win_anti", "/api/x_win_anti", "X wins anti-diagonal (0,2)-(1,1)-(2,0)", HandleXWinAnti(app))
	r.Transition("o_win_row0", "/api/o_win_row0", "O wins top row (0,0)-(0,1)-(0,2)", HandleOWinRow0(app))
	r.Transition("o_win_row1", "/api/o_win_row1", "O wins middle row (1,0)-(1,1)-(1,2)", HandleOWinRow1(app))
	r.Transition("o_win_row2", "/api/o_win_row2", "O wins bottom row (2,0)-(2,1)-(2,2)", HandleOWinRow2(app))
	r.Transition("o_win_col0", "/api/o_win_col0", "O wins left column (0,0)-(1,0)-(2,0)", HandleOWinCol0(app))
	r.Transition("o_win_col1", "/api/o_win_col1", "O wins center column (0,1)-(1,1)-(2,1)", HandleOWinCol1(app))
	r.Transition("o_win_col2", "/api/o_win_col2", "O wins right column (0,2)-(1,2)-(2,2)", HandleOWinCol2(app))
	r.Transition("o_win_diag", "/api/o_win_diag", "O wins main diagonal (0,0)-(1,1)-(2,2)", HandleOWinDiag(app))
	r.Transition("o_win_anti", "/api/o_win_anti", "O wins anti-diagonal (0,2)-(1,1)-(2,0)", HandleOWinAnti(app))

	// Serve frontend static files
	r.StaticFiles("/", StaticFileHandler())

	return r.Build()
}

// StaticFileHandler returns an http.Handler that serves static files from frontend/.
// It supports SPA routing by returning index.html for paths that don't match static files.
func StaticFileHandler() http.HandlerFunc {
	// Find frontend directory
	frontendPath := "frontend"
	if _, err := os.Stat(frontendPath); os.IsNotExist(err) {
		// Try relative to executable
		exe, _ := os.Executable()
		frontendPath = filepath.Join(filepath.Dir(exe), "frontend")
	}

	return func(w http.ResponseWriter, r *http.Request) {
		// Clean the path
		path := strings.TrimPrefix(r.URL.Path, "/")
		if path == "" {
			path = "index.html"
		}

		// Try to serve the file
		fullPath := filepath.Join(frontendPath, path)

		// Check if file exists
		info, err := os.Stat(fullPath)
		if err != nil || info.IsDir() {
			// File doesn't exist, serve index.html for SPA routing
			http.ServeFile(w, r, filepath.Join(frontendPath, "index.html"))
			return
		}

		http.ServeFile(w, r, fullPath)
	}
}

// StaticFS is a helper interface for embedding static files (optional).
type StaticFS interface {
	fs.FS
}

// HandleCreate creates a new aggregate instance.
func HandleCreate(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		id, err := app.Create(ctx)
		if err != nil {
			api.Error(w, http.StatusInternalServerError, "CREATE_FAILED", err.Error())
			return
		}

		// Load the new aggregate to get initial state
		agg, err := app.Load(ctx, id)
		if err != nil {
			api.Error(w, http.StatusInternalServerError, "LOAD_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusCreated, api.StateResponse{
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.State(),
			Places:             agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}

// HandleGetState returns the current state of an aggregate.
func HandleGetState(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()
		id := r.PathValue("id")
		if id == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate ID is required")
			return
		}

		agg, err := app.GetState(ctx, id)
		if err != nil {
			api.Error(w, http.StatusNotFound, "NOT_FOUND", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.StateResponse{
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.State(),
			Places:             agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}

// HandleReady checks if the application is ready to serve requests.
// Returns 200 if all dependencies are available, 503 otherwise.
func HandleReady(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		checks := make(map[string]string)
		ready := true

		// Check event store connectivity
		if err := app.HealthCheck(r.Context()); err != nil {
			checks["eventstore"] = err.Error()
			ready = false
		} else {
			checks["eventstore"] = "ok"
		}

		status := http.StatusOK
		statusText := "ready"
		if !ready {
			status = http.StatusServiceUnavailable
			statusText = "not ready"
		}

		api.JSON(w, status, map[string]any{
			"status": statusText,
			"checks": checks,
		})
	}
}


// HandleXPlay00 handles the x_play_00 transition.
func HandleXPlay00(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionXPlay00, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleXPlay01 handles the x_play_01 transition.
func HandleXPlay01(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionXPlay01, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleXPlay02 handles the x_play_02 transition.
func HandleXPlay02(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionXPlay02, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleXPlay10 handles the x_play_10 transition.
func HandleXPlay10(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionXPlay10, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleXPlay11 handles the x_play_11 transition.
func HandleXPlay11(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionXPlay11, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleXPlay12 handles the x_play_12 transition.
func HandleXPlay12(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionXPlay12, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleXPlay20 handles the x_play_20 transition.
func HandleXPlay20(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionXPlay20, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleXPlay21 handles the x_play_21 transition.
func HandleXPlay21(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionXPlay21, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleXPlay22 handles the x_play_22 transition.
func HandleXPlay22(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionXPlay22, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleOPlay00 handles the o_play_00 transition.
func HandleOPlay00(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionOPlay00, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleOPlay01 handles the o_play_01 transition.
func HandleOPlay01(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionOPlay01, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleOPlay02 handles the o_play_02 transition.
func HandleOPlay02(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionOPlay02, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleOPlay10 handles the o_play_10 transition.
func HandleOPlay10(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionOPlay10, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleOPlay11 handles the o_play_11 transition.
func HandleOPlay11(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionOPlay11, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleOPlay12 handles the o_play_12 transition.
func HandleOPlay12(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionOPlay12, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleOPlay20 handles the o_play_20 transition.
func HandleOPlay20(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionOPlay20, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleOPlay21 handles the o_play_21 transition.
func HandleOPlay21(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionOPlay21, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleOPlay22 handles the o_play_22 transition.
func HandleOPlay22(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionOPlay22, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleReset handles the reset transition.
func HandleReset(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		// This transition clears event history, resetting to initial state
		agg, err := app.ResetStream(ctx, req.AggregateID)
		if err != nil {
			api.Error(w, http.StatusConflict, "RESET_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleXWinRow0 handles the x_win_row0 transition.
func HandleXWinRow0(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionXWinRow0, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleXWinRow1 handles the x_win_row1 transition.
func HandleXWinRow1(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionXWinRow1, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleXWinRow2 handles the x_win_row2 transition.
func HandleXWinRow2(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionXWinRow2, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleXWinCol0 handles the x_win_col0 transition.
func HandleXWinCol0(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionXWinCol0, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleXWinCol1 handles the x_win_col1 transition.
func HandleXWinCol1(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionXWinCol1, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleXWinCol2 handles the x_win_col2 transition.
func HandleXWinCol2(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionXWinCol2, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleXWinDiag handles the x_win_diag transition.
func HandleXWinDiag(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionXWinDiag, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleXWinAnti handles the x_win_anti transition.
func HandleXWinAnti(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionXWinAnti, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleOWinRow0 handles the o_win_row0 transition.
func HandleOWinRow0(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionOWinRow0, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleOWinRow1 handles the o_win_row1 transition.
func HandleOWinRow1(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionOWinRow1, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleOWinRow2 handles the o_win_row2 transition.
func HandleOWinRow2(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionOWinRow2, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleOWinCol0 handles the o_win_col0 transition.
func HandleOWinCol0(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionOWinCol0, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleOWinCol1 handles the o_win_col1 transition.
func HandleOWinCol1(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionOWinCol1, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleOWinCol2 handles the o_win_col2 transition.
func HandleOWinCol2(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionOWinCol2, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleOWinDiag handles the o_win_diag transition.
func HandleOWinDiag(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionOWinDiag, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}


// HandleOWinAnti handles the o_win_anti transition.
func HandleOWinAnti(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()

		var req api.TransitionRequest
		if err := api.DecodeJSON(r, &req); err != nil {
			api.Error(w, http.StatusBadRequest, "INVALID_REQUEST", err.Error())
			return
		}

		if req.AggregateID == "" {
			api.Error(w, http.StatusBadRequest, "MISSING_ID", "aggregate_id is required")
			return
		}

		agg, err := app.Execute(ctx, req.AggregateID, TransitionOWinAnti, req.Data)
		if err != nil {
			api.Error(w, http.StatusConflict, "TRANSITION_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, api.TransitionResult{
			Success:            true,
			AggregateID:        agg.ID(),
			Version:            agg.Version(),
			State:              agg.Places(),
			EnabledTransitions: agg.EnabledTransitions(),
		})
	}
}






// HandleAdminStats wraps the admin stats handler.
func HandleAdminStats(app *Application) http.HandlerFunc {
return func(w http.ResponseWriter, r *http.Request) {
ctx := r.Context()

adminStore, ok := app.store.(interface {
GetStats(ctx context.Context) (*eventsource.Stats, error)
})
if !ok {
api.Error(w, http.StatusInternalServerError, "UNSUPPORTED", "Admin operations not supported")
return
}

stats, err := adminStore.GetStats(ctx)
if err != nil {
api.Error(w, http.StatusInternalServerError, "STATS_FAILED", err.Error())
return
}

api.JSON(w, http.StatusOK, stats)
}
}

// HandleAdminListInstances wraps the admin list instances handler.
func HandleAdminListInstances(app *Application, softDeleteStore *SoftDeleteStore) http.HandlerFunc {
return func(w http.ResponseWriter, r *http.Request) {
ctx := r.Context()

place := r.URL.Query().Get("place")
from := r.URL.Query().Get("from")
to := r.URL.Query().Get("to")
page := getIntQueryParam(r, "page", 1)
perPage := getIntQueryParam(r, "per_page", 50)
showArchived := r.URL.Query().Get("archived") == "true"

adminStore, ok := app.store.(interface {
ListInstances(ctx context.Context, place, from, to string, page, perPage int) ([]eventsource.Instance, int, error)
})
if !ok {
api.Error(w, http.StatusInternalServerError, "UNSUPPORTED", "Admin operations not supported")
return
}

instances, total, err := adminStore.ListInstances(ctx, place, from, to, page, perPage)
if err != nil {
api.Error(w, http.StatusInternalServerError, "LIST_FAILED", err.Error())
return
}
// Filter out archived instances unless explicitly requested
var filteredInstances []eventsource.Instance
var archivedInstances []eventsource.Instance
for _, inst := range instances {
if softDeleteStore.IsDeleted(inst.ID) {
archivedInstances = append(archivedInstances, inst)
} else {
filteredInstances = append(filteredInstances, inst)
}
}
if showArchived {
instances = archivedInstances
} else {
instances = filteredInstances
}

// Load state for each instance by replaying events
// Note: This loads aggregates individually which may be slow for large lists.
// The perPage parameter limits the number of instances processed.
for i := range instances {
agg, err := app.Load(ctx, instances[i].ID)
if err != nil {
// Log error but continue processing other instances
// The state will remain as initialized by ListInstances
continue
}
// Get the Petri net places (token distribution)
instances[i].State = agg.Places()
}

api.JSON(w, http.StatusOK, map[string]interface{}{
"instances": instances,
"total":     total,
"page":      page,
"per_page":  perPage,
"has_soft_delete": true,
})
}
}

// HandleAdminGetInstance wraps the admin get instance handler.
func HandleAdminGetInstance(app *Application) http.HandlerFunc {
return func(w http.ResponseWriter, r *http.Request) {
ctx := r.Context()
id := r.PathValue("id")

agg, err := app.Load(ctx, id)
if err != nil {
api.Error(w, http.StatusNotFound, "NOT_FOUND", err.Error())
return
}

api.JSON(w, http.StatusOK, map[string]interface{}{
"id":      agg.ID(),
"version": agg.Version(),
"state":   agg.State(),
})
}
}

// HandleAdminGetEvents wraps the admin get events handler.
func HandleAdminGetEvents(app *Application) http.HandlerFunc {
return func(w http.ResponseWriter, r *http.Request) {
ctx := r.Context()
id := r.PathValue("id")
from := getIntQueryParam(r, "from", 0)

events, err := app.store.Read(ctx, id, from)
if err != nil {
api.Error(w, http.StatusInternalServerError, "READ_FAILED", err.Error())
return
}

api.JSON(w, http.StatusOK, map[string]interface{}{
"events": events,
})
}
}

// HandleAdminDeleteInstance deletes an instance and all its events.
func HandleAdminDeleteInstance(app *Application) http.HandlerFunc {
return func(w http.ResponseWriter, r *http.Request) {
ctx := r.Context()
id := r.PathValue("id")

if err := app.store.DeleteStream(ctx, id); err != nil {
api.Error(w, http.StatusInternalServerError, "DELETE_FAILED", err.Error())
return
}

api.JSON(w, http.StatusOK, map[string]interface{}{
"deleted": true,
"id":      id,
})
}
}
// HandleAdminArchiveInstance soft-deletes an instance (marks as archived).
func HandleAdminArchiveInstance(softDeleteStore *SoftDeleteStore) http.HandlerFunc {
return func(w http.ResponseWriter, r *http.Request) {
id := r.PathValue("id")
userID := getSoftDeleteUserID(r)

if err := softDeleteStore.SoftDelete(id, userID); err != nil {
api.Error(w, http.StatusInternalServerError, "ARCHIVE_FAILED", err.Error())
return
}

api.JSON(w, http.StatusOK, map[string]interface{}{
"archived": true,
"id":       id,
})
}
}

// HandleAdminRestoreInstance restores a soft-deleted instance.
func HandleAdminRestoreInstance(softDeleteStore *SoftDeleteStore) http.HandlerFunc {
return func(w http.ResponseWriter, r *http.Request) {
id := r.PathValue("id")

if err := softDeleteStore.Restore(id); err != nil {
api.Error(w, http.StatusInternalServerError, "RESTORE_FAILED", err.Error())
return
}

api.JSON(w, http.StatusOK, map[string]interface{}{
"restored": true,
"id":       id,
})
}
}



// HandleGetEvents returns the event history for an aggregate.
func HandleGetEvents(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()
		id := r.PathValue("id")
		from := getIntQueryParam(r, "from", 0)

		events, err := app.store.Read(ctx, id, from)
		if err != nil {
			api.Error(w, http.StatusInternalServerError, "READ_FAILED", err.Error())
			return
		}

		api.JSON(w, http.StatusOK, map[string]interface{}{
			"events": events,
		})
	}
}

// HandleGetStateAtVersion returns the aggregate state at a specific version.
func HandleGetStateAtVersion(app *Application) http.HandlerFunc {
	return func(w http.ResponseWriter, r *http.Request) {
		ctx := r.Context()
		id := r.PathValue("id")
		versionStr := r.PathValue("version")

		version := getInt(versionStr, 0)
		if version <= 0 {
			api.Error(w, http.StatusBadRequest, "INVALID_VERSION", "version must be a positive integer")
			return
		}

		events, err := app.store.Read(ctx, id, 0)
		if err != nil {
			api.Error(w, http.StatusInternalServerError, "READ_FAILED", err.Error())
			return
		}

		// Create temporary aggregate and replay up to version
		agg := NewAggregate(id)
		for _, evt := range events {
			if evt.Version > version {
				break
			}
			if err := agg.Apply(evt); err != nil {
				api.Error(w, http.StatusInternalServerError, "APPLY_FAILED", err.Error())
				return
			}
		}

		api.JSON(w, http.StatusOK, map[string]interface{}{
			"id":      agg.ID(),
			"version": version,
			"state":   agg.State(),
		})
	}
}





// Helper functions

func getIntQueryParam(r *http.Request, name string, defaultVal int) int {
	val := r.URL.Query().Get(name)
	return getInt(val, defaultVal)
}

func getInt(s string, defaultVal int) int {
	if s == "" {
		return defaultVal
	}

	intVal, err := strconv.Atoi(s)
	if err != nil {
		return defaultVal
	}

	return intVal
}


// HandleGetSchema returns the model schema JSON for the schema viewer.
func HandleGetSchema() http.HandlerFunc {
	// Schema JSON is embedded at generation time (base64 encoded)
	schemaBase64 := "ewogICJuYW1lIjogInRpYy10YWMtdG9lIiwKICAidmVyc2lvbiI6ICIyLjAuMCIsCiAgImRlc2NyaXB0aW9uIjogIlRpYy10YWMtdG9lIGdhbWUgbW9kZWxlZCBhcyBhIFBldHJpIG5ldCB3aXRoIHdpbiBwYXR0ZXJucyBhcyB0cmFuc2l0aW9ucyBmb3IgT0RFLWJhc2VkIHN0cmF0ZWdpYyBhbmFseXNpcyIsCiAgInBsYWNlcyI6IFsKICAgIHsKICAgICAgImlkIjogInAwMCIsCiAgICAgICJkZXNjcmlwdGlvbiI6ICJDZWxsICgwLDApIGVtcHR5IiwKICAgICAgImluaXRpYWwiOiAxLAogICAgICAia2luZCI6ICJ0b2tlbiIKICAgIH0sCiAgICB7CiAgICAgICJpZCI6ICJwMDEiLAogICAgICAiZGVzY3JpcHRpb24iOiAiQ2VsbCAoMCwxKSBlbXB0eSIsCiAgICAgICJpbml0aWFsIjogMSwKICAgICAgImtpbmQiOiAidG9rZW4iCiAgICB9LAogICAgewogICAgICAiaWQiOiAicDAyIiwKICAgICAgImRlc2NyaXB0aW9uIjogIkNlbGwgKDAsMikgZW1wdHkiLAogICAgICAiaW5pdGlhbCI6IDEsCiAgICAgICJraW5kIjogInRva2VuIgogICAgfSwKICAgIHsKICAgICAgImlkIjogInAxMCIsCiAgICAgICJkZXNjcmlwdGlvbiI6ICJDZWxsICgxLDApIGVtcHR5IiwKICAgICAgImluaXRpYWwiOiAxLAogICAgICAia2luZCI6ICJ0b2tlbiIKICAgIH0sCiAgICB7CiAgICAgICJpZCI6ICJwMTEiLAogICAgICAiZGVzY3JpcHRpb24iOiAiQ2VsbCAoMSwxKSBlbXB0eSAtIGNlbnRlciIsCiAgICAgICJpbml0aWFsIjogMSwKICAgICAgImtpbmQiOiAidG9rZW4iCiAgICB9LAogICAgewogICAgICAiaWQiOiAicDEyIiwKICAgICAgImRlc2NyaXB0aW9uIjogIkNlbGwgKDEsMikgZW1wdHkiLAogICAgICAiaW5pdGlhbCI6IDEsCiAgICAgICJraW5kIjogInRva2VuIgogICAgfSwKICAgIHsKICAgICAgImlkIjogInAyMCIsCiAgICAgICJkZXNjcmlwdGlvbiI6ICJDZWxsICgyLDApIGVtcHR5IiwKICAgICAgImluaXRpYWwiOiAxLAogICAgICAia2luZCI6ICJ0b2tlbiIKICAgIH0sCiAgICB7CiAgICAgICJpZCI6ICJwMjEiLAogICAgICAiZGVzY3JpcHRpb24iOiAiQ2VsbCAoMiwxKSBlbXB0eSIsCiAgICAgICJpbml0aWFsIjogMSwKICAgICAgImtpbmQiOiAidG9rZW4iCiAgICB9LAogICAgewogICAgICAiaWQiOiAicDIyIiwKICAgICAgImRlc2NyaXB0aW9uIjogIkNlbGwgKDIsMikgZW1wdHkiLAogICAgICAiaW5pdGlhbCI6IDEsCiAgICAgICJraW5kIjogInRva2VuIgogICAgfSwKICAgIHsKICAgICAgImlkIjogIngwMCIsCiAgICAgICJkZXNjcmlwdGlvbiI6ICJYIHBpZWNlIGF0ICgwLDApIiwKICAgICAgImluaXRpYWwiOiAwLAogICAgICAia2luZCI6ICJ0b2tlbiIKICAgIH0sCiAgICB7CiAgICAgICJpZCI6ICJ4MDEiLAogICAgICAiZGVzY3JpcHRpb24iOiAiWCBwaWVjZSBhdCAoMCwxKSIsCiAgICAgICJpbml0aWFsIjogMCwKICAgICAgImtpbmQiOiAidG9rZW4iCiAgICB9LAogICAgewogICAgICAiaWQiOiAieDAyIiwKICAgICAgImRlc2NyaXB0aW9uIjogIlggcGllY2UgYXQgKDAsMikiLAogICAgICAiaW5pdGlhbCI6IDAsCiAgICAgICJraW5kIjogInRva2VuIgogICAgfSwKICAgIHsKICAgICAgImlkIjogIngxMCIsCiAgICAgICJkZXNjcmlwdGlvbiI6ICJYIHBpZWNlIGF0ICgxLDApIiwKICAgICAgImluaXRpYWwiOiAwLAogICAgICAia2luZCI6ICJ0b2tlbiIKICAgIH0sCiAgICB7CiAgICAgICJpZCI6ICJ4MTEiLAogICAgICAiZGVzY3JpcHRpb24iOiAiWCBwaWVjZSBhdCAoMSwxKSIsCiAgICAgICJpbml0aWFsIjogMCwKICAgICAgImtpbmQiOiAidG9rZW4iCiAgICB9LAogICAgewogICAgICAiaWQiOiAieDEyIiwKICAgICAgImRlc2NyaXB0aW9uIjogIlggcGllY2UgYXQgKDEsMikiLAogICAgICAiaW5pdGlhbCI6IDAsCiAgICAgICJraW5kIjogInRva2VuIgogICAgfSwKICAgIHsKICAgICAgImlkIjogIngyMCIsCiAgICAgICJkZXNjcmlwdGlvbiI6ICJYIHBpZWNlIGF0ICgyLDApIiwKICAgICAgImluaXRpYWwiOiAwLAogICAgICAia2luZCI6ICJ0b2tlbiIKICAgIH0sCiAgICB7CiAgICAgICJpZCI6ICJ4MjEiLAogICAgICAiZGVzY3JpcHRpb24iOiAiWCBwaWVjZSBhdCAoMiwxKSIsCiAgICAgICJpbml0aWFsIjogMCwKICAgICAgImtpbmQiOiAidG9rZW4iCiAgICB9LAogICAgewogICAgICAiaWQiOiAieDIyIiwKICAgICAgImRlc2NyaXB0aW9uIjogIlggcGllY2UgYXQgKDIsMikiLAogICAgICAiaW5pdGlhbCI6IDAsCiAgICAgICJraW5kIjogInRva2VuIgogICAgfSwKICAgIHsKICAgICAgImlkIjogIm8wMCIsCiAgICAgICJkZXNjcmlwdGlvbiI6ICJPIHBpZWNlIGF0ICgwLDApIiwKICAgICAgImluaXRpYWwiOiAwLAogICAgICAia2luZCI6ICJ0b2tlbiIKICAgIH0sCiAgICB7CiAgICAgICJpZCI6ICJvMDEiLAogICAgICAiZGVzY3JpcHRpb24iOiAiTyBwaWVjZSBhdCAoMCwxKSIsCiAgICAgICJpbml0aWFsIjogMCwKICAgICAgImtpbmQiOiAidG9rZW4iCiAgICB9LAogICAgewogICAgICAiaWQiOiAibzAyIiwKICAgICAgImRlc2NyaXB0aW9uIjogIk8gcGllY2UgYXQgKDAsMikiLAogICAgICAiaW5pdGlhbCI6IDAsCiAgICAgICJraW5kIjogInRva2VuIgogICAgfSwKICAgIHsKICAgICAgImlkIjogIm8xMCIsCiAgICAgICJkZXNjcmlwdGlvbiI6ICJPIHBpZWNlIGF0ICgxLDApIiwKICAgICAgImluaXRpYWwiOiAwLAogICAgICAia2luZCI6ICJ0b2tlbiIKICAgIH0sCiAgICB7CiAgICAgICJpZCI6ICJvMTEiLAogICAgICAiZGVzY3JpcHRpb24iOiAiTyBwaWVjZSBhdCAoMSwxKSIsCiAgICAgICJpbml0aWFsIjogMCwKICAgICAgImtpbmQiOiAidG9rZW4iCiAgICB9LAogICAgewogICAgICAiaWQiOiAibzEyIiwKICAgICAgImRlc2NyaXB0aW9uIjogIk8gcGllY2UgYXQgKDEsMikiLAogICAgICAiaW5pdGlhbCI6IDAsCiAgICAgICJraW5kIjogInRva2VuIgogICAgfSwKICAgIHsKICAgICAgImlkIjogIm8yMCIsCiAgICAgICJkZXNjcmlwdGlvbiI6ICJPIHBpZWNlIGF0ICgyLDApIiwKICAgICAgImluaXRpYWwiOiAwLAogICAgICAia2luZCI6ICJ0b2tlbiIKICAgIH0sCiAgICB7CiAgICAgICJpZCI6ICJvMjEiLAogICAgICAiZGVzY3JpcHRpb24iOiAiTyBwaWVjZSBhdCAoMiwxKSIsCiAgICAgICJpbml0aWFsIjogMCwKICAgICAgImtpbmQiOiAidG9rZW4iCiAgICB9LAogICAgewogICAgICAiaWQiOiAibzIyIiwKICAgICAgImRlc2NyaXB0aW9uIjogIk8gcGllY2UgYXQgKDIsMikiLAogICAgICAiaW5pdGlhbCI6IDAsCiAgICAgICJraW5kIjogInRva2VuIgogICAgfSwKICAgIHsKICAgICAgImlkIjogInhfdHVybiIsCiAgICAgICJkZXNjcmlwdGlvbiI6ICJYJ3MgdHVybiB0byBwbGF5IiwKICAgICAgImluaXRpYWwiOiAxLAogICAgICAia2luZCI6ICJ0b2tlbiIKICAgIH0sCiAgICB7CiAgICAgICJpZCI6ICJvX3R1cm4iLAogICAgICAiZGVzY3JpcHRpb24iOiAiTydzIHR1cm4gdG8gcGxheSIsCiAgICAgICJpbml0aWFsIjogMCwKICAgICAgImtpbmQiOiAidG9rZW4iCiAgICB9LAogICAgewogICAgICAiaWQiOiAid2luX3giLAogICAgICAiZGVzY3JpcHRpb24iOiAiWCBoYXMgd29uIiwKICAgICAgImluaXRpYWwiOiAwLAogICAgICAia2luZCI6ICJ0b2tlbiIKICAgIH0sCiAgICB7CiAgICAgICJpZCI6ICJ3aW5fbyIsCiAgICAgICJkZXNjcmlwdGlvbiI6ICJPIGhhcyB3b24iLAogICAgICAiaW5pdGlhbCI6IDAsCiAgICAgICJraW5kIjogInRva2VuIgogICAgfSwKICAgIHsKICAgICAgImlkIjogImNhbl9yZXNldCIsCiAgICAgICJkZXNjcmlwdGlvbiI6ICJUb2tlbiBlbmFibGluZyByZXNldCBhY3Rpb24iLAogICAgICAiaW5pdGlhbCI6IDEsCiAgICAgICJraW5kIjogInRva2VuIgogICAgfQogIF0sCiAgInRyYW5zaXRpb25zIjogWwogICAgewogICAgICAiaWQiOiAieF9wbGF5XzAwIiwKICAgICAgImRlc2NyaXB0aW9uIjogIlggcGxheXMgYXQgKDAsMCkiLAogICAgICAiZXZlbnQiOiAiWFBsYXllZCIsCiAgICAgICJodHRwX21ldGhvZCI6ICJQT1NUIiwKICAgICAgImh0dHBfcGF0aCI6ICIvYXBpL3hfcGxheV8wMCIsCiAgICAgICJldmVudF90eXBlIjogIlhQbGF5ZWQwMCIKICAgIH0sCiAgICB7CiAgICAgICJpZCI6ICJ4X3BsYXlfMDEiLAogICAgICAiZGVzY3JpcHRpb24iOiAiWCBwbGF5cyBhdCAoMCwxKSIsCiAgICAgICJldmVudCI6ICJYUGxheWVkIiwKICAgICAgImh0dHBfbWV0aG9kIjogIlBPU1QiLAogICAgICAiaHR0cF9wYXRoIjogIi9hcGkveF9wbGF5XzAxIiwKICAgICAgImV2ZW50X3R5cGUiOiAiWFBsYXllZDAxIgogICAgfSwKICAgIHsKICAgICAgImlkIjogInhfcGxheV8wMiIsCiAgICAgICJkZXNjcmlwdGlvbiI6ICJYIHBsYXlzIGF0ICgwLDIpIiwKICAgICAgImV2ZW50IjogIlhQbGF5ZWQiLAogICAgICAiaHR0cF9tZXRob2QiOiAiUE9TVCIsCiAgICAgICJodHRwX3BhdGgiOiAiL2FwaS94X3BsYXlfMDIiLAogICAgICAiZXZlbnRfdHlwZSI6ICJYUGxheWVkMDIiCiAgICB9LAogICAgewogICAgICAiaWQiOiAieF9wbGF5XzEwIiwKICAgICAgImRlc2NyaXB0aW9uIjogIlggcGxheXMgYXQgKDEsMCkiLAogICAgICAiZXZlbnQiOiAiWFBsYXllZCIsCiAgICAgICJodHRwX21ldGhvZCI6ICJQT1NUIiwKICAgICAgImh0dHBfcGF0aCI6ICIvYXBpL3hfcGxheV8xMCIsCiAgICAgICJldmVudF90eXBlIjogIlhQbGF5ZWQxMCIKICAgIH0sCiAgICB7CiAgICAgICJpZCI6ICJ4X3BsYXlfMTEiLAogICAgICAiZGVzY3JpcHRpb24iOiAiWCBwbGF5cyBhdCAoMSwxKSAtIGNlbnRlciIsCiAgICAgICJldmVudCI6ICJYUGxheWVkIiwKICAgICAgImh0dHBfbWV0aG9kIjogIlBPU1QiLAogICAgICAiaHR0cF9wYXRoIjogIi9hcGkveF9wbGF5XzExIiwKICAgICAgImV2ZW50X3R5cGUiOiAiWFBsYXllZDExIgogICAgfSwKICAgIHsKICAgICAgImlkIjogInhfcGxheV8xMiIsCiAgICAgICJkZXNjcmlwdGlvbiI6ICJYIHBsYXlzIGF0ICgxLDIpIiwKICAgICAgImV2ZW50IjogIlhQbGF5ZWQiLAogICAgICAiaHR0cF9tZXRob2QiOiAiUE9TVCIsCiAgICAgICJodHRwX3BhdGgiOiAiL2FwaS94X3BsYXlfMTIiLAogICAgICAiZXZlbnRfdHlwZSI6ICJYUGxheWVkMTIiCiAgICB9LAogICAgewogICAgICAiaWQiOiAieF9wbGF5XzIwIiwKICAgICAgImRlc2NyaXB0aW9uIjogIlggcGxheXMgYXQgKDIsMCkiLAogICAgICAiZXZlbnQiOiAiWFBsYXllZCIsCiAgICAgICJodHRwX21ldGhvZCI6ICJQT1NUIiwKICAgICAgImh0dHBfcGF0aCI6ICIvYXBpL3hfcGxheV8yMCIsCiAgICAgICJldmVudF90eXBlIjogIlhQbGF5ZWQyMCIKICAgIH0sCiAgICB7CiAgICAgICJpZCI6ICJ4X3BsYXlfMjEiLAogICAgICAiZGVzY3JpcHRpb24iOiAiWCBwbGF5cyBhdCAoMiwxKSIsCiAgICAgICJldmVudCI6ICJYUGxheWVkIiwKICAgICAgImh0dHBfbWV0aG9kIjogIlBPU1QiLAogICAgICAiaHR0cF9wYXRoIjogIi9hcGkveF9wbGF5XzIxIiwKICAgICAgImV2ZW50X3R5cGUiOiAiWFBsYXllZDIxIgogICAgfSwKICAgIHsKICAgICAgImlkIjogInhfcGxheV8yMiIsCiAgICAgICJkZXNjcmlwdGlvbiI6ICJYIHBsYXlzIGF0ICgyLDIpIiwKICAgICAgImV2ZW50IjogIlhQbGF5ZWQiLAogICAgICAiaHR0cF9tZXRob2QiOiAiUE9TVCIsCiAgICAgICJodHRwX3BhdGgiOiAiL2FwaS94X3BsYXlfMjIiLAogICAgICAiZXZlbnRfdHlwZSI6ICJYUGxheWVkMjIiCiAgICB9LAogICAgewogICAgICAiaWQiOiAib19wbGF5XzAwIiwKICAgICAgImRlc2NyaXB0aW9uIjogIk8gcGxheXMgYXQgKDAsMCkiLAogICAgICAiZXZlbnQiOiAiT1BsYXllZCIsCiAgICAgICJodHRwX21ldGhvZCI6ICJQT1NUIiwKICAgICAgImh0dHBfcGF0aCI6ICIvYXBpL29fcGxheV8wMCIsCiAgICAgICJldmVudF90eXBlIjogIk9QbGF5ZWQwMCIKICAgIH0sCiAgICB7CiAgICAgICJpZCI6ICJvX3BsYXlfMDEiLAogICAgICAiZGVzY3JpcHRpb24iOiAiTyBwbGF5cyBhdCAoMCwxKSIsCiAgICAgICJldmVudCI6ICJPUGxheWVkIiwKICAgICAgImh0dHBfbWV0aG9kIjogIlBPU1QiLAogICAgICAiaHR0cF9wYXRoIjogIi9hcGkvb19wbGF5XzAxIiwKICAgICAgImV2ZW50X3R5cGUiOiAiT1BsYXllZDAxIgogICAgfSwKICAgIHsKICAgICAgImlkIjogIm9fcGxheV8wMiIsCiAgICAgICJkZXNjcmlwdGlvbiI6ICJPIHBsYXlzIGF0ICgwLDIpIiwKICAgICAgImV2ZW50IjogIk9QbGF5ZWQiLAogICAgICAiaHR0cF9tZXRob2QiOiAiUE9TVCIsCiAgICAgICJodHRwX3BhdGgiOiAiL2FwaS9vX3BsYXlfMDIiLAogICAgICAiZXZlbnRfdHlwZSI6ICJPUGxheWVkMDIiCiAgICB9LAogICAgewogICAgICAiaWQiOiAib19wbGF5XzEwIiwKICAgICAgImRlc2NyaXB0aW9uIjogIk8gcGxheXMgYXQgKDEsMCkiLAogICAgICAiZXZlbnQiOiAiT1BsYXllZCIsCiAgICAgICJodHRwX21ldGhvZCI6ICJQT1NUIiwKICAgICAgImh0dHBfcGF0aCI6ICIvYXBpL29fcGxheV8xMCIsCiAgICAgICJldmVudF90eXBlIjogIk9QbGF5ZWQxMCIKICAgIH0sCiAgICB7CiAgICAgICJpZCI6ICJvX3BsYXlfMTEiLAogICAgICAiZGVzY3JpcHRpb24iOiAiTyBwbGF5cyBhdCAoMSwxKSAtIGNlbnRlciIsCiAgICAgICJldmVudCI6ICJPUGxheWVkIiwKICAgICAgImh0dHBfbWV0aG9kIjogIlBPU1QiLAogICAgICAiaHR0cF9wYXRoIjogIi9hcGkvb19wbGF5XzExIiwKICAgICAgImV2ZW50X3R5cGUiOiAiT1BsYXllZDExIgogICAgfSwKICAgIHsKICAgICAgImlkIjogIm9fcGxheV8xMiIsCiAgICAgICJkZXNjcmlwdGlvbiI6ICJPIHBsYXlzIGF0ICgxLDIpIiwKICAgICAgImV2ZW50IjogIk9QbGF5ZWQiLAogICAgICAiaHR0cF9tZXRob2QiOiAiUE9TVCIsCiAgICAgICJodHRwX3BhdGgiOiAiL2FwaS9vX3BsYXlfMTIiLAogICAgICAiZXZlbnRfdHlwZSI6ICJPUGxheWVkMTIiCiAgICB9LAogICAgewogICAgICAiaWQiOiAib19wbGF5XzIwIiwKICAgICAgImRlc2NyaXB0aW9uIjogIk8gcGxheXMgYXQgKDIsMCkiLAogICAgICAiZXZlbnQiOiAiT1BsYXllZCIsCiAgICAgICJodHRwX21ldGhvZCI6ICJQT1NUIiwKICAgICAgImh0dHBfcGF0aCI6ICIvYXBpL29fcGxheV8yMCIsCiAgICAgICJldmVudF90eXBlIjogIk9QbGF5ZWQyMCIKICAgIH0sCiAgICB7CiAgICAgICJpZCI6ICJvX3BsYXlfMjEiLAogICAgICAiZGVzY3JpcHRpb24iOiAiTyBwbGF5cyBhdCAoMiwxKSIsCiAgICAgICJldmVudCI6ICJPUGxheWVkIiwKICAgICAgImh0dHBfbWV0aG9kIjogIlBPU1QiLAogICAgICAiaHR0cF9wYXRoIjogIi9hcGkvb19wbGF5XzIxIiwKICAgICAgImV2ZW50X3R5cGUiOiAiT1BsYXllZDIxIgogICAgfSwKICAgIHsKICAgICAgImlkIjogIm9fcGxheV8yMiIsCiAgICAgICJkZXNjcmlwdGlvbiI6ICJPIHBsYXlzIGF0ICgyLDIpIiwKICAgICAgImV2ZW50IjogIk9QbGF5ZWQiLAogICAgICAiaHR0cF9tZXRob2QiOiAiUE9TVCIsCiAgICAgICJodHRwX3BhdGgiOiAiL2FwaS9vX3BsYXlfMjIiLAogICAgICAiZXZlbnRfdHlwZSI6ICJPUGxheWVkMjIiCiAgICB9LAogICAgewogICAgICAiaWQiOiAicmVzZXQiLAogICAgICAiZGVzY3JpcHRpb24iOiAiUmVzZXQgZ2FtZSB0byBpbml0aWFsIHN0YXRlIiwKICAgICAgImV2ZW50IjogIkdhbWVSZXNldCIsCiAgICAgICJodHRwX21ldGhvZCI6ICJQT1NUIiwKICAgICAgImh0dHBfcGF0aCI6ICIvYXBpL3Jlc2V0IiwKICAgICAgImNsZWFyc0hpc3RvcnkiOiB0cnVlLAogICAgICAiZXZlbnRfdHlwZSI6ICJHYW1lUmVzZXQiCiAgICB9LAogICAgewogICAgICAiaWQiOiAieF93aW5fcm93MCIsCiAgICAgICJkZXNjcmlwdGlvbiI6ICJYIHdpbnMgdG9wIHJvdyAoMCwwKS0oMCwxKS0oMCwyKSIsCiAgICAgICJodHRwX21ldGhvZCI6ICJQT1NUIiwKICAgICAgImh0dHBfcGF0aCI6ICIvYXBpL3hfd2luX3JvdzAiLAogICAgICAiZXZlbnRfdHlwZSI6ICJYV2luUm93MGVkIgogICAgfSwKICAgIHsKICAgICAgImlkIjogInhfd2luX3JvdzEiLAogICAgICAiZGVzY3JpcHRpb24iOiAiWCB3aW5zIG1pZGRsZSByb3cgKDEsMCktKDEsMSktKDEsMikiLAogICAgICAiaHR0cF9tZXRob2QiOiAiUE9TVCIsCiAgICAgICJodHRwX3BhdGgiOiAiL2FwaS94X3dpbl9yb3cxIiwKICAgICAgImV2ZW50X3R5cGUiOiAiWFdpblJvdzFlZCIKICAgIH0sCiAgICB7CiAgICAgICJpZCI6ICJ4X3dpbl9yb3cyIiwKICAgICAgImRlc2NyaXB0aW9uIjogIlggd2lucyBib3R0b20gcm93ICgyLDApLSgyLDEpLSgyLDIpIiwKICAgICAgImh0dHBfbWV0aG9kIjogIlBPU1QiLAogICAgICAiaHR0cF9wYXRoIjogIi9hcGkveF93aW5fcm93MiIsCiAgICAgICJldmVudF90eXBlIjogIlhXaW5Sb3cyZWQiCiAgICB9LAogICAgewogICAgICAiaWQiOiAieF93aW5fY29sMCIsCiAgICAgICJkZXNjcmlwdGlvbiI6ICJYIHdpbnMgbGVmdCBjb2x1bW4gKDAsMCktKDEsMCktKDIsMCkiLAogICAgICAiaHR0cF9tZXRob2QiOiAiUE9TVCIsCiAgICAgICJodHRwX3BhdGgiOiAiL2FwaS94X3dpbl9jb2wwIiwKICAgICAgImV2ZW50X3R5cGUiOiAiWFdpbkNvbDBlZCIKICAgIH0sCiAgICB7CiAgICAgICJpZCI6ICJ4X3dpbl9jb2wxIiwKICAgICAgImRlc2NyaXB0aW9uIjogIlggd2lucyBjZW50ZXIgY29sdW1uICgwLDEpLSgxLDEpLSgyLDEpIiwKICAgICAgImh0dHBfbWV0aG9kIjogIlBPU1QiLAogICAgICAiaHR0cF9wYXRoIjogIi9hcGkveF93aW5fY29sMSIsCiAgICAgICJldmVudF90eXBlIjogIlhXaW5Db2wxZWQiCiAgICB9LAogICAgewogICAgICAiaWQiOiAieF93aW5fY29sMiIsCiAgICAgICJkZXNjcmlwdGlvbiI6ICJYIHdpbnMgcmlnaHQgY29sdW1uICgwLDIpLSgxLDIpLSgyLDIpIiwKICAgICAgImh0dHBfbWV0aG9kIjogIlBPU1QiLAogICAgICAiaHR0cF9wYXRoIjogIi9hcGkveF93aW5fY29sMiIsCiAgICAgICJldmVudF90eXBlIjogIlhXaW5Db2wyZWQiCiAgICB9LAogICAgewogICAgICAiaWQiOiAieF93aW5fZGlhZyIsCiAgICAgICJkZXNjcmlwdGlvbiI6ICJYIHdpbnMgbWFpbiBkaWFnb25hbCAoMCwwKS0oMSwxKS0oMiwyKSIsCiAgICAgICJodHRwX21ldGhvZCI6ICJQT1NUIiwKICAgICAgImh0dHBfcGF0aCI6ICIvYXBpL3hfd2luX2RpYWciLAogICAgICAiZXZlbnRfdHlwZSI6ICJYV2luRGlhZ2VkIgogICAgfSwKICAgIHsKICAgICAgImlkIjogInhfd2luX2FudGkiLAogICAgICAiZGVzY3JpcHRpb24iOiAiWCB3aW5zIGFudGktZGlhZ29uYWwgKDAsMiktKDEsMSktKDIsMCkiLAogICAgICAiaHR0cF9tZXRob2QiOiAiUE9TVCIsCiAgICAgICJodHRwX3BhdGgiOiAiL2FwaS94X3dpbl9hbnRpIiwKICAgICAgImV2ZW50X3R5cGUiOiAiWFdpbkFudGllZCIKICAgIH0sCiAgICB7CiAgICAgICJpZCI6ICJvX3dpbl9yb3cwIiwKICAgICAgImRlc2NyaXB0aW9uIjogIk8gd2lucyB0b3Agcm93ICgwLDApLSgwLDEpLSgwLDIpIiwKICAgICAgImh0dHBfbWV0aG9kIjogIlBPU1QiLAogICAgICAiaHR0cF9wYXRoIjogIi9hcGkvb193aW5fcm93MCIsCiAgICAgICJldmVudF90eXBlIjogIk9XaW5Sb3cwZWQiCiAgICB9LAogICAgewogICAgICAiaWQiOiAib193aW5fcm93MSIsCiAgICAgICJkZXNjcmlwdGlvbiI6ICJPIHdpbnMgbWlkZGxlIHJvdyAoMSwwKS0oMSwxKS0oMSwyKSIsCiAgICAgICJodHRwX21ldGhvZCI6ICJQT1NUIiwKICAgICAgImh0dHBfcGF0aCI6ICIvYXBpL29fd2luX3JvdzEiLAogICAgICAiZXZlbnRfdHlwZSI6ICJPV2luUm93MWVkIgogICAgfSwKICAgIHsKICAgICAgImlkIjogIm9fd2luX3JvdzIiLAogICAgICAiZGVzY3JpcHRpb24iOiAiTyB3aW5zIGJvdHRvbSByb3cgKDIsMCktKDIsMSktKDIsMikiLAogICAgICAiaHR0cF9tZXRob2QiOiAiUE9TVCIsCiAgICAgICJodHRwX3BhdGgiOiAiL2FwaS9vX3dpbl9yb3cyIiwKICAgICAgImV2ZW50X3R5cGUiOiAiT1dpblJvdzJlZCIKICAgIH0sCiAgICB7CiAgICAgICJpZCI6ICJvX3dpbl9jb2wwIiwKICAgICAgImRlc2NyaXB0aW9uIjogIk8gd2lucyBsZWZ0IGNvbHVtbiAoMCwwKS0oMSwwKS0oMiwwKSIsCiAgICAgICJodHRwX21ldGhvZCI6ICJQT1NUIiwKICAgICAgImh0dHBfcGF0aCI6ICIvYXBpL29fd2luX2NvbDAiLAogICAgICAiZXZlbnRfdHlwZSI6ICJPV2luQ29sMGVkIgogICAgfSwKICAgIHsKICAgICAgImlkIjogIm9fd2luX2NvbDEiLAogICAgICAiZGVzY3JpcHRpb24iOiAiTyB3aW5zIGNlbnRlciBjb2x1bW4gKDAsMSktKDEsMSktKDIsMSkiLAogICAgICAiaHR0cF9tZXRob2QiOiAiUE9TVCIsCiAgICAgICJodHRwX3BhdGgiOiAiL2FwaS9vX3dpbl9jb2wxIiwKICAgICAgImV2ZW50X3R5cGUiOiAiT1dpbkNvbDFlZCIKICAgIH0sCiAgICB7CiAgICAgICJpZCI6ICJvX3dpbl9jb2wyIiwKICAgICAgImRlc2NyaXB0aW9uIjogIk8gd2lucyByaWdodCBjb2x1bW4gKDAsMiktKDEsMiktKDIsMikiLAogICAgICAiaHR0cF9tZXRob2QiOiAiUE9TVCIsCiAgICAgICJodHRwX3BhdGgiOiAiL2FwaS9vX3dpbl9jb2wyIiwKICAgICAgImV2ZW50X3R5cGUiOiAiT1dpbkNvbDJlZCIKICAgIH0sCiAgICB7CiAgICAgICJpZCI6ICJvX3dpbl9kaWFnIiwKICAgICAgImRlc2NyaXB0aW9uIjogIk8gd2lucyBtYWluIGRpYWdvbmFsICgwLDApLSgxLDEpLSgyLDIpIiwKICAgICAgImh0dHBfbWV0aG9kIjogIlBPU1QiLAogICAgICAiaHR0cF9wYXRoIjogIi9hcGkvb193aW5fZGlhZyIsCiAgICAgICJldmVudF90eXBlIjogIk9XaW5EaWFnZWQiCiAgICB9LAogICAgewogICAgICAiaWQiOiAib193aW5fYW50aSIsCiAgICAgICJkZXNjcmlwdGlvbiI6ICJPIHdpbnMgYW50aS1kaWFnb25hbCAoMCwyKS0oMSwxKS0oMiwwKSIsCiAgICAgICJodHRwX21ldGhvZCI6ICJQT1NUIiwKICAgICAgImh0dHBfcGF0aCI6ICIvYXBpL29fd2luX2FudGkiLAogICAgICAiZXZlbnRfdHlwZSI6ICJPV2luQW50aWVkIgogICAgfQogIF0sCiAgImFyY3MiOiBbCiAgICB7CiAgICAgICJmcm9tIjogInAwMCIsCiAgICAgICJ0byI6ICJ4X3BsYXlfMDAiCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJ4X3R1cm4iLAogICAgICAidG8iOiAieF9wbGF5XzAwIgogICAgfSwKICAgIHsKICAgICAgImZyb20iOiAieF9wbGF5XzAwIiwKICAgICAgInRvIjogIngwMCIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogInhfcGxheV8wMCIsCiAgICAgICJ0byI6ICJvX3R1cm4iCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJwMDEiLAogICAgICAidG8iOiAieF9wbGF5XzAxIgogICAgfSwKICAgIHsKICAgICAgImZyb20iOiAieF90dXJuIiwKICAgICAgInRvIjogInhfcGxheV8wMSIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogInhfcGxheV8wMSIsCiAgICAgICJ0byI6ICJ4MDEiCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJ4X3BsYXlfMDEiLAogICAgICAidG8iOiAib190dXJuIgogICAgfSwKICAgIHsKICAgICAgImZyb20iOiAicDAyIiwKICAgICAgInRvIjogInhfcGxheV8wMiIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogInhfdHVybiIsCiAgICAgICJ0byI6ICJ4X3BsYXlfMDIiCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJ4X3BsYXlfMDIiLAogICAgICAidG8iOiAieDAyIgogICAgfSwKICAgIHsKICAgICAgImZyb20iOiAieF9wbGF5XzAyIiwKICAgICAgInRvIjogIm9fdHVybiIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogInAxMCIsCiAgICAgICJ0byI6ICJ4X3BsYXlfMTAiCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJ4X3R1cm4iLAogICAgICAidG8iOiAieF9wbGF5XzEwIgogICAgfSwKICAgIHsKICAgICAgImZyb20iOiAieF9wbGF5XzEwIiwKICAgICAgInRvIjogIngxMCIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogInhfcGxheV8xMCIsCiAgICAgICJ0byI6ICJvX3R1cm4iCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJwMTEiLAogICAgICAidG8iOiAieF9wbGF5XzExIgogICAgfSwKICAgIHsKICAgICAgImZyb20iOiAieF90dXJuIiwKICAgICAgInRvIjogInhfcGxheV8xMSIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogInhfcGxheV8xMSIsCiAgICAgICJ0byI6ICJ4MTEiCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJ4X3BsYXlfMTEiLAogICAgICAidG8iOiAib190dXJuIgogICAgfSwKICAgIHsKICAgICAgImZyb20iOiAicDEyIiwKICAgICAgInRvIjogInhfcGxheV8xMiIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogInhfdHVybiIsCiAgICAgICJ0byI6ICJ4X3BsYXlfMTIiCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJ4X3BsYXlfMTIiLAogICAgICAidG8iOiAieDEyIgogICAgfSwKICAgIHsKICAgICAgImZyb20iOiAieF9wbGF5XzEyIiwKICAgICAgInRvIjogIm9fdHVybiIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogInAyMCIsCiAgICAgICJ0byI6ICJ4X3BsYXlfMjAiCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJ4X3R1cm4iLAogICAgICAidG8iOiAieF9wbGF5XzIwIgogICAgfSwKICAgIHsKICAgICAgImZyb20iOiAieF9wbGF5XzIwIiwKICAgICAgInRvIjogIngyMCIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogInhfcGxheV8yMCIsCiAgICAgICJ0byI6ICJvX3R1cm4iCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJwMjEiLAogICAgICAidG8iOiAieF9wbGF5XzIxIgogICAgfSwKICAgIHsKICAgICAgImZyb20iOiAieF90dXJuIiwKICAgICAgInRvIjogInhfcGxheV8yMSIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogInhfcGxheV8yMSIsCiAgICAgICJ0byI6ICJ4MjEiCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJ4X3BsYXlfMjEiLAogICAgICAidG8iOiAib190dXJuIgogICAgfSwKICAgIHsKICAgICAgImZyb20iOiAicDIyIiwKICAgICAgInRvIjogInhfcGxheV8yMiIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogInhfdHVybiIsCiAgICAgICJ0byI6ICJ4X3BsYXlfMjIiCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJ4X3BsYXlfMjIiLAogICAgICAidG8iOiAieDIyIgogICAgfSwKICAgIHsKICAgICAgImZyb20iOiAieF9wbGF5XzIyIiwKICAgICAgInRvIjogIm9fdHVybiIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogInAwMCIsCiAgICAgICJ0byI6ICJvX3BsYXlfMDAiCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJvX3R1cm4iLAogICAgICAidG8iOiAib19wbGF5XzAwIgogICAgfSwKICAgIHsKICAgICAgImZyb20iOiAib19wbGF5XzAwIiwKICAgICAgInRvIjogIm8wMCIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogIm9fcGxheV8wMCIsCiAgICAgICJ0byI6ICJ4X3R1cm4iCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJwMDEiLAogICAgICAidG8iOiAib19wbGF5XzAxIgogICAgfSwKICAgIHsKICAgICAgImZyb20iOiAib190dXJuIiwKICAgICAgInRvIjogIm9fcGxheV8wMSIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogIm9fcGxheV8wMSIsCiAgICAgICJ0byI6ICJvMDEiCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJvX3BsYXlfMDEiLAogICAgICAidG8iOiAieF90dXJuIgogICAgfSwKICAgIHsKICAgICAgImZyb20iOiAicDAyIiwKICAgICAgInRvIjogIm9fcGxheV8wMiIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogIm9fdHVybiIsCiAgICAgICJ0byI6ICJvX3BsYXlfMDIiCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJvX3BsYXlfMDIiLAogICAgICAidG8iOiAibzAyIgogICAgfSwKICAgIHsKICAgICAgImZyb20iOiAib19wbGF5XzAyIiwKICAgICAgInRvIjogInhfdHVybiIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogInAxMCIsCiAgICAgICJ0byI6ICJvX3BsYXlfMTAiCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJvX3R1cm4iLAogICAgICAidG8iOiAib19wbGF5XzEwIgogICAgfSwKICAgIHsKICAgICAgImZyb20iOiAib19wbGF5XzEwIiwKICAgICAgInRvIjogIm8xMCIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogIm9fcGxheV8xMCIsCiAgICAgICJ0byI6ICJ4X3R1cm4iCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJwMTEiLAogICAgICAidG8iOiAib19wbGF5XzExIgogICAgfSwKICAgIHsKICAgICAgImZyb20iOiAib190dXJuIiwKICAgICAgInRvIjogIm9fcGxheV8xMSIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogIm9fcGxheV8xMSIsCiAgICAgICJ0byI6ICJvMTEiCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJvX3BsYXlfMTEiLAogICAgICAidG8iOiAieF90dXJuIgogICAgfSwKICAgIHsKICAgICAgImZyb20iOiAicDEyIiwKICAgICAgInRvIjogIm9fcGxheV8xMiIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogIm9fdHVybiIsCiAgICAgICJ0byI6ICJvX3BsYXlfMTIiCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJvX3BsYXlfMTIiLAogICAgICAidG8iOiAibzEyIgogICAgfSwKICAgIHsKICAgICAgImZyb20iOiAib19wbGF5XzEyIiwKICAgICAgInRvIjogInhfdHVybiIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogInAyMCIsCiAgICAgICJ0byI6ICJvX3BsYXlfMjAiCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJvX3R1cm4iLAogICAgICAidG8iOiAib19wbGF5XzIwIgogICAgfSwKICAgIHsKICAgICAgImZyb20iOiAib19wbGF5XzIwIiwKICAgICAgInRvIjogIm8yMCIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogIm9fcGxheV8yMCIsCiAgICAgICJ0byI6ICJ4X3R1cm4iCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJwMjEiLAogICAgICAidG8iOiAib19wbGF5XzIxIgogICAgfSwKICAgIHsKICAgICAgImZyb20iOiAib190dXJuIiwKICAgICAgInRvIjogIm9fcGxheV8yMSIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogIm9fcGxheV8yMSIsCiAgICAgICJ0byI6ICJvMjEiCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJvX3BsYXlfMjEiLAogICAgICAidG8iOiAieF90dXJuIgogICAgfSwKICAgIHsKICAgICAgImZyb20iOiAicDIyIiwKICAgICAgInRvIjogIm9fcGxheV8yMiIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogIm9fdHVybiIsCiAgICAgICJ0byI6ICJvX3BsYXlfMjIiCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJvX3BsYXlfMjIiLAogICAgICAidG8iOiAibzIyIgogICAgfSwKICAgIHsKICAgICAgImZyb20iOiAib19wbGF5XzIyIiwKICAgICAgInRvIjogInhfdHVybiIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogIngwMCIsCiAgICAgICJ0byI6ICJ4X3dpbl9yb3cwIgogICAgfSwKICAgIHsKICAgICAgImZyb20iOiAieDAxIiwKICAgICAgInRvIjogInhfd2luX3JvdzAiCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJ4MDIiLAogICAgICAidG8iOiAieF93aW5fcm93MCIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogInhfd2luX3JvdzAiLAogICAgICAidG8iOiAid2luX3giCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJ4MTAiLAogICAgICAidG8iOiAieF93aW5fcm93MSIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogIngxMSIsCiAgICAgICJ0byI6ICJ4X3dpbl9yb3cxIgogICAgfSwKICAgIHsKICAgICAgImZyb20iOiAieDEyIiwKICAgICAgInRvIjogInhfd2luX3JvdzEiCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJ4X3dpbl9yb3cxIiwKICAgICAgInRvIjogIndpbl94IgogICAgfSwKICAgIHsKICAgICAgImZyb20iOiAieDIwIiwKICAgICAgInRvIjogInhfd2luX3JvdzIiCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJ4MjEiLAogICAgICAidG8iOiAieF93aW5fcm93MiIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogIngyMiIsCiAgICAgICJ0byI6ICJ4X3dpbl9yb3cyIgogICAgfSwKICAgIHsKICAgICAgImZyb20iOiAieF93aW5fcm93MiIsCiAgICAgICJ0byI6ICJ3aW5feCIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogIngwMCIsCiAgICAgICJ0byI6ICJ4X3dpbl9jb2wwIgogICAgfSwKICAgIHsKICAgICAgImZyb20iOiAieDEwIiwKICAgICAgInRvIjogInhfd2luX2NvbDAiCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJ4MjAiLAogICAgICAidG8iOiAieF93aW5fY29sMCIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogInhfd2luX2NvbDAiLAogICAgICAidG8iOiAid2luX3giCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJ4MDEiLAogICAgICAidG8iOiAieF93aW5fY29sMSIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogIngxMSIsCiAgICAgICJ0byI6ICJ4X3dpbl9jb2wxIgogICAgfSwKICAgIHsKICAgICAgImZyb20iOiAieDIxIiwKICAgICAgInRvIjogInhfd2luX2NvbDEiCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJ4X3dpbl9jb2wxIiwKICAgICAgInRvIjogIndpbl94IgogICAgfSwKICAgIHsKICAgICAgImZyb20iOiAieDAyIiwKICAgICAgInRvIjogInhfd2luX2NvbDIiCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJ4MTIiLAogICAgICAidG8iOiAieF93aW5fY29sMiIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogIngyMiIsCiAgICAgICJ0byI6ICJ4X3dpbl9jb2wyIgogICAgfSwKICAgIHsKICAgICAgImZyb20iOiAieF93aW5fY29sMiIsCiAgICAgICJ0byI6ICJ3aW5feCIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogIngwMCIsCiAgICAgICJ0byI6ICJ4X3dpbl9kaWFnIgogICAgfSwKICAgIHsKICAgICAgImZyb20iOiAieDExIiwKICAgICAgInRvIjogInhfd2luX2RpYWciCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJ4MjIiLAogICAgICAidG8iOiAieF93aW5fZGlhZyIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogInhfd2luX2RpYWciLAogICAgICAidG8iOiAid2luX3giCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJ4MDIiLAogICAgICAidG8iOiAieF93aW5fYW50aSIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogIngxMSIsCiAgICAgICJ0byI6ICJ4X3dpbl9hbnRpIgogICAgfSwKICAgIHsKICAgICAgImZyb20iOiAieDIwIiwKICAgICAgInRvIjogInhfd2luX2FudGkiCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJ4X3dpbl9hbnRpIiwKICAgICAgInRvIjogIndpbl94IgogICAgfSwKICAgIHsKICAgICAgImZyb20iOiAibzAwIiwKICAgICAgInRvIjogIm9fd2luX3JvdzAiCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJvMDEiLAogICAgICAidG8iOiAib193aW5fcm93MCIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogIm8wMiIsCiAgICAgICJ0byI6ICJvX3dpbl9yb3cwIgogICAgfSwKICAgIHsKICAgICAgImZyb20iOiAib193aW5fcm93MCIsCiAgICAgICJ0byI6ICJ3aW5fbyIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogIm8xMCIsCiAgICAgICJ0byI6ICJvX3dpbl9yb3cxIgogICAgfSwKICAgIHsKICAgICAgImZyb20iOiAibzExIiwKICAgICAgInRvIjogIm9fd2luX3JvdzEiCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJvMTIiLAogICAgICAidG8iOiAib193aW5fcm93MSIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogIm9fd2luX3JvdzEiLAogICAgICAidG8iOiAid2luX28iCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJvMjAiLAogICAgICAidG8iOiAib193aW5fcm93MiIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogIm8yMSIsCiAgICAgICJ0byI6ICJvX3dpbl9yb3cyIgogICAgfSwKICAgIHsKICAgICAgImZyb20iOiAibzIyIiwKICAgICAgInRvIjogIm9fd2luX3JvdzIiCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJvX3dpbl9yb3cyIiwKICAgICAgInRvIjogIndpbl9vIgogICAgfSwKICAgIHsKICAgICAgImZyb20iOiAibzAwIiwKICAgICAgInRvIjogIm9fd2luX2NvbDAiCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJvMTAiLAogICAgICAidG8iOiAib193aW5fY29sMCIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogIm8yMCIsCiAgICAgICJ0byI6ICJvX3dpbl9jb2wwIgogICAgfSwKICAgIHsKICAgICAgImZyb20iOiAib193aW5fY29sMCIsCiAgICAgICJ0byI6ICJ3aW5fbyIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogIm8wMSIsCiAgICAgICJ0byI6ICJvX3dpbl9jb2wxIgogICAgfSwKICAgIHsKICAgICAgImZyb20iOiAibzExIiwKICAgICAgInRvIjogIm9fd2luX2NvbDEiCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJvMjEiLAogICAgICAidG8iOiAib193aW5fY29sMSIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogIm9fd2luX2NvbDEiLAogICAgICAidG8iOiAid2luX28iCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJvMDIiLAogICAgICAidG8iOiAib193aW5fY29sMiIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogIm8xMiIsCiAgICAgICJ0byI6ICJvX3dpbl9jb2wyIgogICAgfSwKICAgIHsKICAgICAgImZyb20iOiAibzIyIiwKICAgICAgInRvIjogIm9fd2luX2NvbDIiCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJvX3dpbl9jb2wyIiwKICAgICAgInRvIjogIndpbl9vIgogICAgfSwKICAgIHsKICAgICAgImZyb20iOiAibzAwIiwKICAgICAgInRvIjogIm9fd2luX2RpYWciCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJvMTEiLAogICAgICAidG8iOiAib193aW5fZGlhZyIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogIm8yMiIsCiAgICAgICJ0byI6ICJvX3dpbl9kaWFnIgogICAgfSwKICAgIHsKICAgICAgImZyb20iOiAib193aW5fZGlhZyIsCiAgICAgICJ0byI6ICJ3aW5fbyIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogIm8wMiIsCiAgICAgICJ0byI6ICJvX3dpbl9hbnRpIgogICAgfSwKICAgIHsKICAgICAgImZyb20iOiAibzExIiwKICAgICAgInRvIjogIm9fd2luX2FudGkiCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJvMjAiLAogICAgICAidG8iOiAib193aW5fYW50aSIKICAgIH0sCiAgICB7CiAgICAgICJmcm9tIjogIm9fd2luX2FudGkiLAogICAgICAidG8iOiAid2luX28iCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJjYW5fcmVzZXQiLAogICAgICAidG8iOiAicmVzZXQiCiAgICB9LAogICAgewogICAgICAiZnJvbSI6ICJyZXNldCIsCiAgICAgICJ0byI6ICJjYW5fcmVzZXQiCiAgICB9CiAgXSwKICAiZXZlbnRzIjogWwogICAgewogICAgICAiaWQiOiAiWFBsYXllZCIsCiAgICAgICJuYW1lIjogIlhQbGF5ZWQiLAogICAgICAiZGVzY3JpcHRpb24iOiAiWCBwbGFjZWQgYSBwaWVjZSBvbiB0aGUgYm9hcmQiLAogICAgICAiZmllbGRzIjogWwogICAgICAgIHsKICAgICAgICAgICJuYW1lIjogInJvdyIsCiAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIiwKICAgICAgICAgICJyZXF1aXJlZCI6IHRydWUKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICJuYW1lIjogImNvbCIsCiAgICAgICAgICAidHlwZSI6ICJpbnRlZ2VyIiwKICAgICAgICAgICJyZXF1aXJlZCI6IHRydWUKICAgICAgICB9CiAgICAgIF0KICAgIH0sCiAgICB7CiAgICAgICJpZCI6ICJPUGxheWVkIiwKICAgICAgIm5hbWUiOiAiT1BsYXllZCIsCiAgICAgICJkZXNjcmlwdGlvbiI6ICJPIHBsYWNlZCBhIHBpZWNlIG9uIHRoZSBib2FyZCIsCiAgICAgICJmaWVsZHMiOiBbCiAgICAgICAgewogICAgICAgICAgIm5hbWUiOiAicm93IiwKICAgICAgICAgICJ0eXBlIjogImludGVnZXIiLAogICAgICAgICAgInJlcXVpcmVkIjogdHJ1ZQogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgIm5hbWUiOiAiY29sIiwKICAgICAgICAgICJ0eXBlIjogImludGVnZXIiLAogICAgICAgICAgInJlcXVpcmVkIjogdHJ1ZQogICAgICAgIH0KICAgICAgXQogICAgfSwKICAgIHsKICAgICAgImlkIjogIkdhbWVSZXNldCIsCiAgICAgICJuYW1lIjogIkdhbWVSZXNldCIsCiAgICAgICJkZXNjcmlwdGlvbiI6ICJHYW1lIHdhcyByZXNldCB0byBpbml0aWFsIHN0YXRlIiwKICAgICAgImZpZWxkcyI6IG51bGwKICAgIH0KICBdLAogICJhZG1pbiI6IHsKICAgICJlbmFibGVkIjogdHJ1ZSwKICAgICJwYXRoIjogIiIsCiAgICAicm9sZXMiOiBudWxsLAogICAgImZlYXR1cmVzIjogbnVsbAogIH0sCiAgImRlYnVnIjogewogICAgImVuYWJsZWQiOiB0cnVlLAogICAgImV2YWwiOiB0cnVlCiAgfSwKICAic29mdERlbGV0ZSI6IHsKICAgICJlbmFibGVkIjogdHJ1ZSwKICAgICJyZXRlbnRpb25EYXlzIjogMzAKICB9LAogICJzdGF0dXMiOiB7CiAgICAicGxhY2VzIjogewogICAgICAid2luX28iOiAiTyBXaW5zIiwKICAgICAgIndpbl94IjogIlggV2lucyIKICAgIH0sCiAgICAiZGVmYXVsdCI6ICJJbiBQcm9ncmVzcyIKICB9Cn0="

	return func(w http.ResponseWriter, r *http.Request) {
		schemaJSON, err := base64.StdEncoding.DecodeString(schemaBase64)
		if err != nil {
			api.Error(w, http.StatusInternalServerError, "schema_decode_error", "Failed to decode schema")
			return
		}
		w.Header().Set("Content-Type", "application/json")
		w.WriteHeader(http.StatusOK)
		w.Write(schemaJSON)
	}
}

