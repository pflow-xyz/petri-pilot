// Code generated by petri-pilot. DO NOT EDIT.

package tictactoe

import (
	"database/sql"
	"net/http"

	"github.com/pflow-xyz/petri-pilot/pkg/runtime/eventstore"
	"github.com/pflow-xyz/petri-pilot/pkg/serve"
	_ "modernc.org/sqlite"
)

// ServiceName is the registered name for this service.
const ServiceName = "tictactoe"

func init() {
	serve.Register(ServiceName, NewService)
}

// Service implements serve.Service for the tic-tac-toe workflow.
type Service struct {
	store           eventstore.Store
	app             *Application
	debugBroker     *DebugBroker
	featuresDB      *sql.DB
	softDeleteStore *SoftDeleteStore
}

// NewService creates a new tic-tac-toe service instance.
func NewService() (serve.Service, error) {
	svc := &Service{}

	// Initialize event store with SQLite for persistence
	var err error
	svc.store, err = eventstore.NewSQLiteStore("tictactoe.db")
	if err != nil {
		return nil, err
	}

	// Create application
	svc.app = NewApplication(svc.store)
	// Initialize debug broker
	svc.debugBroker = NewDebugBroker()
	// Initialize features database
	svc.featuresDB, err = sql.Open("sqlite", "features.db")
	if err != nil {
		return nil, err
	}
	// Initialize soft delete store
	svc.softDeleteStore = NewSoftDeleteStore(svc.featuresDB, 30)
	if err := svc.softDeleteStore.InitSchema(); err != nil {
		return nil, err
	}

	return svc, nil
}

// Name returns the service name.
func (s *Service) Name() string {
	return ServiceName
}

// BuildHandler returns the HTTP handler for this service.
func (s *Service) BuildHandler() http.Handler {
	return BuildRouter(s.app, s.debugBroker, s.softDeleteStore)
}

// Close cleans up resources used by the service.
func (s *Service) Close() error {
	if s.featuresDB != nil {
		s.featuresDB.Close()
	}
	if s.store != nil {
		return s.store.Close()
	}
	return nil
}
