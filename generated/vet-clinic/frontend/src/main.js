// Generated by petri-pilot. DO NOT EDIT.

import { createNavigation, refreshNavigation } from './navigation.js'
import { navigate, initRouter, getRouteParams, getCurrentRoute } from './router.js'
import { loadViews, renderFormView, renderDetailView, renderTableView, getFormData } from './views.js'
import { renderDashboard, getDashboardStyles } from './dashboard.js'
import { renderSimulation, getSimulationStyles, cleanupSimulation } from './simulation.js'
import { initDebug } from './debug.js'

// API client
const API_BASE = ''

// ============================================================================
// Token Amount Scaling
// ============================================================================
// Decimals: 0 (0 = no scaling)
// Unit: ""

const TOKEN_DECIMALS = 0
const TOKEN_UNIT = ""
const TOKEN_SCALE = TOKEN_DECIMALS > 0 ? Math.pow(10, TOKEN_DECIMALS) : 1

// Convert from smallest unit (wei) to display unit (ETH)
// e.g., "1000000000000000000" -> "1"
// Handles both string and number inputs
function toDisplayAmount(rawAmount) {
  if (TOKEN_DECIMALS === 0) return rawAmount
  if (rawAmount === null || rawAmount === undefined) return ''

  // Handle string amounts (may be very large)
  const str = String(rawAmount)
  if (str === '0') return '0'

  // Pad with leading zeros if needed
  const padded = str.padStart(TOKEN_DECIMALS + 1, '0')
  const intPart = padded.slice(0, -TOKEN_DECIMALS) || '0'
  const fracPart = padded.slice(-TOKEN_DECIMALS).replace(/0+$/, '')

  return fracPart ? `${intPart}.${fracPart}` : intPart
}

// Convert from display unit (ETH) to smallest unit (wei)
// e.g., 1.0 -> "1000000000000000000"
// Returns a STRING to avoid JavaScript number precision issues with large values
function toRawAmount(displayAmount) {
  if (TOKEN_DECIMALS === 0) return displayAmount
  if (displayAmount === null || displayAmount === undefined || displayAmount === '') return "0"

  const amount = typeof displayAmount === 'string' ? parseFloat(displayAmount) : displayAmount
  if (isNaN(amount)) return "0"

  // Use BigInt arithmetic to avoid precision loss
  const multiplier = BigInt(10 ** TOKEN_DECIMALS)
  const whole = BigInt(Math.floor(amount))
  const frac = amount - Math.floor(amount)
  const fracWei = BigInt(Math.round(frac * Number(multiplier)))
  return String(whole * multiplier + fracWei)
}

// Format amount for display with unit
function formatAmount(rawAmount) {
  const display = toDisplayAmount(rawAmount)
  if (TOKEN_UNIT) {
    return `${display} ${TOKEN_UNIT}`
  }
  return display.toString()
}

// Check if a field name represents a token amount (should be scaled)
function isAmountField(fieldName) {
  const amountFields = ['amount', 'value', 'balance', 'total_supply', 'allowance']
  return amountFields.some(f => fieldName.toLowerCase().includes(f))
}

// Scale form data for API submission
function scaleFormData(data) {
  if (TOKEN_DECIMALS === 0) return data
  const scaled = { ...data }
  for (const [key, value] of Object.entries(scaled)) {
    if (isAmountField(key) && (typeof value === 'number' || !isNaN(parseFloat(value)))) {
      scaled[key] = toRawAmount(value)
    }
  }
  return scaled
}

// Check if value is a numeric amount (number or numeric string)
function isNumericAmount(value) {
  if (typeof value === 'number') return true
  if (typeof value === 'string' && /^\d+$/.test(value)) return true
  return false
}

// Unscale state data for display
function unscaleStateData(state) {
  if (TOKEN_DECIMALS === 0) return state
  const unscaled = { ...state }
  for (const [key, value] of Object.entries(unscaled)) {
    if (isAmountField(key)) {
      if (isNumericAmount(value)) {
        unscaled[key] = toDisplayAmount(value)
      } else if (typeof value === 'object' && value !== null) {
        // Handle maps like balances: { alice: 1000000000000000000 }
        // and nested maps like allowances: { owner: { spender: amount } }
        unscaled[key] = {}
        for (const [k, v] of Object.entries(value)) {
          if (isNumericAmount(v)) {
            unscaled[key][k] = toDisplayAmount(v)
          } else if (typeof v === 'object' && v !== null) {
            // Handle nested map (2 levels deep)
            unscaled[key][k] = {}
            for (const [k2, v2] of Object.entries(v)) {
              unscaled[key][k][k2] = isNumericAmount(v2) ? toDisplayAmount(v2) : v2
            }
          } else {
            unscaled[key][k] = v
          }
        }
      }
    }
  }
  return unscaled
}

// App state
let currentUser = null
let authToken = null
let instances = []
let currentInstance = null
let currentAttachments = []

// Attachment type options
const ATTACHMENT_TYPES = [
  { id: 'lab_report', name: 'Lab Report' },
  { id: 'xray', name: 'X-Ray / Imaging' },
  { id: 'prescription', name: 'Prescription' },
  { id: 'consent_form', name: 'Consent Form' },
  { id: 'clinical_notes', name: 'Clinical Notes' },
  { id: 'other', name: 'Other' },
]

// Transition definitions with fields (populated in renderInstanceDetail)
const TRANSITION_DEFS = [
  {
    id: 'schedule',
    name: 'Schedule',
    description: "",
    fields: [
    ]
  },
  {
    id: 'check_in',
    name: 'Check In',
    description: "",
    fields: [
    ]
  },
  {
    id: 'start_exam',
    name: 'Start Exam',
    description: "",
    fields: [
    ]
  },
  {
    id: 'complete',
    name: 'Complete',
    description: "",
    fields: [
    ]
  },
  {
    id: 'checkout',
    name: 'Checkout',
    description: "",
    fields: [
    ]
  },
  {
    id: 'cancel_requested',
    name: 'Cancel Requested',
    description: "",
    fields: [
    ]
  },
  {
    id: 'cancel_scheduled',
    name: 'Cancel Scheduled',
    description: "",
    fields: [
    ]
  },
  {
    id: 'mark_no_show',
    name: 'Mark No Show',
    description: "",
    fields: [
    ]
  },
  {
    id: 'send_to_lab',
    name: 'Send To Lab',
    description: "",
    fields: [
    ]
  },
  {
    id: 'receive_results',
    name: 'Receive Results',
    description: "",
    fields: [
    ]
  },
  {
    id: 'request_auth',
    name: 'Request Auth',
    description: "",
    fields: [
    ]
  },
  {
    id: 'authorize',
    name: 'Authorize',
    description: "",
    fields: [
    ]
  },
  {
    id: 'refer_out',
    name: 'Refer Out',
    description: "",
    fields: [
    ]
  },
]

// ============================================================================
// Auth
// ============================================================================

function loadAuth() {
  const stored = localStorage.getItem('auth')
  if (stored) {
    try {
      const auth = JSON.parse(stored)
      if (auth.expires_at && new Date(auth.expires_at) > new Date()) {
        authToken = auth.token
        currentUser = auth.user
        return true
      }
      localStorage.removeItem('auth')
    } catch (e) {
      localStorage.removeItem('auth')
    }
  }
  return false
}

function saveAuth(data) {
  localStorage.setItem('auth', JSON.stringify(data))
  authToken = data.token
  currentUser = data.user
  window.dispatchEvent(new CustomEvent('auth-change'))
}

function clearAuth() {
  localStorage.removeItem('auth')
  authToken = null
  currentUser = null
  window.dispatchEvent(new CustomEvent('auth-change'))
}

// Reload auth from localStorage (called when wallet module updates auth)
function reloadAuth() {
  const stored = localStorage.getItem('auth')
  if (stored) {
    try {
      const auth = JSON.parse(stored)
      authToken = auth.token
      currentUser = auth.user
      return true
    } catch (e) {
      return false
    }
  }
  authToken = null
  currentUser = null
  return false
}

// Listen for auth changes from wallet module
window.addEventListener('auth-change', () => {
  reloadAuth()
})

function getHeaders() {
  const headers = { 'Content-Type': 'application/json' }
  if (authToken) {
    headers['Authorization'] = `Bearer ${authToken}`
  }
  return headers
}

// ============================================================================
// API
// ============================================================================

async function handleResponse(response) {
  if (response.status === 401) {
    clearAuth()
    showError('Session expired. Please log in again.')
    throw new Error('Unauthorized')
  }
  if (!response.ok) {
    const error = await response.json().catch(() => ({}))
    throw new Error(error.message || response.statusText)
  }
  return response.json()
}

const api = {
  async getMe() {
    const response = await fetch(`${API_BASE}/auth/me`, { headers: getHeaders() })
    return handleResponse(response)
  },

  async logout() {
    await fetch(`${API_BASE}/auth/logout`, { method: 'POST', headers: getHeaders() })
    clearAuth()
  },

  async listInstances() {
    const response = await fetch(`${API_BASE}/admin/instances`, { headers: getHeaders() })
    return handleResponse(response)
  },

  async getInstance(id) {
    const response = await fetch(`${API_BASE}/api/vetclinic/${id}`, { headers: getHeaders() })
    return handleResponse(response)
  },

  async createInstance(data = {}) {
    const response = await fetch(`${API_BASE}/api/vetclinic`, {
      method: 'POST',
      headers: getHeaders(),
      body: JSON.stringify(data),
    })
    return handleResponse(response)
  },

  async executeTransition(transitionId, aggregateId, data = {}) {
    // Scale amount fields before sending to API
    const scaledData = scaleFormData(data)
    // Get the API path from transition definition, or fall back to default
    const transition = window.pilot?.getTransition?.(transitionId)
    let apiPath = transition?.apiPath || `/api/${transitionId}`
    // Substitute {id} placeholder with actual aggregate ID
    apiPath = apiPath.replace('{id}', aggregateId)
    const response = await fetch(`${API_BASE}${apiPath}`, {
      method: 'POST',
      headers: getHeaders(),
      body: JSON.stringify({ aggregate_id: aggregateId, data: scaledData }),
    })
    return handleResponse(response)
  },

  // Attachment APIs
  async listAttachments(appointmentId) {
    const response = await fetch(`${API_BASE}/api/vetclinic/${appointmentId}/attachments`, { headers: getHeaders() })
    return handleResponse(response)
  },

  async uploadAttachment(appointmentId, file, attachmentType) {
    const formData = new FormData()
    formData.append('file', file)
    formData.append('stream_id', appointmentId)
    formData.append('attachment_type', attachmentType)

    const headers = {}
    if (authToken) {
      headers['Authorization'] = `Bearer ${authToken}`
    }

    const response = await fetch(`${API_BASE}/api/blobs`, {
      method: 'POST',
      headers: headers,
      body: formData,
    })
    return handleResponse(response)
  },

  async deleteAttachment(blobId) {
    const response = await fetch(`${API_BASE}/api/blobs/${blobId}`, {
      method: 'DELETE',
      headers: getHeaders(),
    })
    return handleResponse(response)
  },

  getAttachmentUrl(blobId) {
    return `${API_BASE}/api/blobs/${blobId}`
  },
}

// Export for global access
window.api = api

// Export current instance for debug wallet view
Object.defineProperty(window, 'currentInstance', {
  get: function() { return currentInstance }
})

// Export auth functions for testing
window.setAuthToken = function(token) {
  authToken = token
}
window.saveAuth = saveAuth
window.clearAuth = clearAuth

// ============================================================================
// UI Helpers
// ============================================================================

function showError(message) {
  const app = document.getElementById('app')
  const existing = app.querySelector('.alert-error')
  if (existing) existing.remove()

  const alert = document.createElement('div')
  alert.className = 'alert alert-error'
  alert.textContent = message
  app.insertBefore(alert, app.firstChild)

  setTimeout(() => alert.remove(), 5000)
}

function showSuccess(message) {
  const app = document.getElementById('app')
  const existing = app.querySelector('.alert-success')
  if (existing) existing.remove()

  const alert = document.createElement('div')
  alert.className = 'alert alert-success'
  alert.textContent = message
  app.insertBefore(alert, app.firstChild)

  setTimeout(() => alert.remove(), 3000)
}

// Get human-readable status from places
function getStatus(places) {
  if (!places) return 'unknown'
  for (const [place, tokens] of Object.entries(places)) {
    if (tokens > 0) return place
  }
  return 'unknown'
}

// Format status as badge
function formatStatus(status) {
  const statusClass = `badge-${status.toLowerCase().replace(/_/g, '-')}`
  return `<span class="badge ${statusClass}">${status.replace(/_/g, ' ')}</span>`
}

// ============================================================================
// Page Renderers
// ============================================================================

// List page - shows all instances
async function renderListPage() {
  const app = document.getElementById('app')
  app.innerHTML = `
    <div class="page">
      <div class="page-header">
        <h1>vet-clinic</h1>
        <button class="btn btn-primary" onclick="handleCreateNew()">+ New</button>
      </div>
      <div id="instances-list" class="entity-list">
        <div class="loading">Loading...</div>
      </div>
    </div>
  `

  try {
    const result = await api.listInstances()
    instances = result.instances || []
    renderInstancesList()
  } catch (err) {
    document.getElementById('instances-list').innerHTML = `
      <div class="empty-state">
        <h3>No instances yet</h3>
        <p>Create your first instance to get started.</p>
        <button class="btn btn-primary" onclick="handleCreateNew()" style="margin-top: 1rem">+ Create New</button>
      </div>
    `
  }
}

function renderInstancesList() {
  const container = document.getElementById('instances-list')
  if (!container) return

  if (instances.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <h3>No instances yet</h3>
        <p>Create your first instance to get started.</p>
        <button class="btn btn-primary" onclick="handleCreateNew()" style="margin-top: 1rem">+ Create New</button>
      </div>
    `
    return
  }

  container.innerHTML = instances.map(inst => {
    const status = getStatus(inst.state || inst.places)
    return `
      <div class="entity-card" onclick="navigate('/vet-clinic/${inst.id}')">
        <div class="entity-info">
          <h3>${inst.id}</h3>
          <div class="entity-meta">
            ${formatStatus(status)} &middot; Version ${inst.version || 0}
          </div>
        </div>
        <div class="entity-actions">
          <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); navigate('/vet-clinic/${inst.id}')">
            View
          </button>
        </div>
      </div>
    `
  }).join('')
}

// Detail page - shows single instance with actions
async function renderDetailPage() {
  const params = getRouteParams()
  const id = params.id

  const app = document.getElementById('app')
  app.innerHTML = `
    <div class="page">
      <div class="page-header">
        <div>
          <button class="btn btn-link" onclick="navigate('/vet-clinic')" style="margin-left: -0.5rem">
            &larr; Back to List
          </button>
          <h1 style="margin-top: 0.5rem">Appointment: ${id}</h1>
        </div>
      </div>
      <div id="instance-detail">
        <div class="loading">Loading...</div>
      </div>
    </div>
  `

  try {
    // Load instance and attachments in parallel
    const [result, attachmentsResult] = await Promise.all([
      api.getInstance(id),
      api.listAttachments(id).catch(() => ({ attachments: [] }))
    ])

    currentInstance = {
      id: result.aggregate_id || id,
      version: result.version,
      state: result.state,
      displayState: unscaleStateData(result.state), // Unscaled for display
      places: result.places,
      enabled: result.enabled || result.enabled_transitions || [],
    }
    currentAttachments = attachmentsResult.attachments || []

    // Store state for debug wallet view
    window.currentInstanceState = currentInstance.state
    renderInstanceDetail()
  } catch (err) {
    document.getElementById('instance-detail').innerHTML = `
      <div class="alert alert-error">Failed to load instance: ${err.message}</div>
    `
  }
}

function renderInstanceDetail() {
  const container = document.getElementById('instance-detail')
  if (!container || !currentInstance) return

  const status = getStatus(currentInstance.places)
  const enabled = currentInstance.enabled || []

  // Use global transition definitions
  const transitions = TRANSITION_DEFS

  container.innerHTML = `
    <div class="card">
      <div class="card-header">Status</div>
      <div class="detail-list">
        <div class="detail-field">
          <dt>ID</dt>
          <dd><code>${currentInstance.id}</code></dd>
        </div>
        <div class="detail-field">
          <dt>Status</dt>
          <dd>${formatStatus(status)}</dd>
        </div>
        <div class="detail-field">
          <dt>Version</dt>
          <dd>${currentInstance.version || 0}</dd>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">Actions</div>
      <div class="view-actions">
        ${transitions.map(t => {
          const isEnabled = enabled.includes(t.id)
          return `
            <button
              class="btn ${isEnabled ? 'btn-primary' : 'btn-secondary'}"
              onclick="handleTransition('${t.id}')"
              ${isEnabled ? '' : 'disabled'}
              title="${t.description || t.name}"
            >
              ${t.name}
            </button>
          `
        }).join('')}
      </div>
      ${enabled.length === 0 ? '<p style="color: #666; margin-top: 1rem;">No actions available in current state.</p>' : ''}
    </div>

    <div class="card">
      <div class="card-header">Current State${TOKEN_UNIT ? ` (${TOKEN_UNIT})` : ''}</div>
      <div class="detail-list">
        ${renderStateDisplay(currentInstance.displayState || currentInstance.state)}
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <span>Attachments</span>
        <span style="font-size: 0.85rem; color: #666; margin-left: 0.5rem;">(${currentAttachments.length})</span>
      </div>
      <div class="attachments-section">
        ${renderAttachmentUploadForm()}
        ${renderAttachmentsList()}
      </div>
    </div>
  `
}

// Render attachment upload form
function renderAttachmentUploadForm() {
  return `
    <form id="attachment-upload-form" class="attachment-upload" onsubmit="handleAttachmentUpload(event)">
      <div class="upload-row">
        <select name="attachment_type" required class="form-control" style="width: auto; min-width: 150px;">
          <option value="">Select type...</option>
          ${ATTACHMENT_TYPES.map(t => `<option value="${t.id}">${t.name}</option>`).join('')}
        </select>
        <input type="file" name="file" required class="form-control" style="flex: 1;" accept=".pdf,.jpg,.jpeg,.png,.gif,.txt" />
        <button type="submit" class="btn btn-primary">Upload</button>
      </div>
      <p class="upload-hint">Supported: PDF, JPEG, PNG, GIF, TXT (max 10MB)</p>
    </form>
  `
}

// Render attachments list
function renderAttachmentsList() {
  if (!currentAttachments || currentAttachments.length === 0) {
    return '<p class="empty-attachments">No attachments yet.</p>'
  }

  return `
    <table class="attachments-table">
      <thead>
        <tr>
          <th>Filename</th>
          <th>Type</th>
          <th>Size</th>
          <th>Uploaded</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        ${currentAttachments.map(att => {
          const typeLabel = ATTACHMENT_TYPES.find(t => t.id === att.attachmentType)?.name || att.attachmentType || 'Other'
          const sizeStr = formatFileSize(att.size)
          const dateStr = new Date(att.createdAt).toLocaleDateString()
          return `
            <tr>
              <td class="filename-cell">
                <span class="file-icon">${getFileIcon(att.contentType)}</span>
                <span class="filename">${escapeHtml(att.filename)}</span>
              </td>
              <td><span class="badge badge-type">${typeLabel}</span></td>
              <td>${sizeStr}</td>
              <td>${dateStr}</td>
              <td class="actions-cell">
                <a href="${api.getAttachmentUrl(att.id)}" download class="btn btn-sm btn-secondary" title="Download">
                  Download
                </a>
                <button onclick="handleDeleteAttachment('${att.id}')" class="btn btn-sm btn-danger" title="Delete">
                  Delete
                </button>
              </td>
            </tr>
          `
        }).join('')}
      </tbody>
    </table>
  `
}

// Format file size for display
function formatFileSize(bytes) {
  if (bytes < 1024) return bytes + ' B'
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB'
  return (bytes / (1024 * 1024)).toFixed(1) + ' MB'
}

// Get file icon based on content type
function getFileIcon(contentType) {
  if (contentType.startsWith('image/')) return '\u{1F5BC}'  // picture frame emoji
  if (contentType === 'application/pdf') return '\u{1F4C4}'  // page facing up emoji
  if (contentType.startsWith('text/')) return '\u{1F4DD}'  // memo emoji
  return '\u{1F4CE}'  // paperclip emoji
}

// Escape HTML to prevent XSS
function escapeHtml(text) {
  const div = document.createElement('div')
  div.textContent = text
  return div.innerHTML
}

// Handle attachment upload
window.handleAttachmentUpload = async function(event) {
  event.preventDefault()

  if (!currentInstance) return

  const form = event.target
  const formData = new FormData(form)
  const file = formData.get('file')
  const attachmentType = formData.get('attachment_type')

  if (!file || !attachmentType) {
    showError('Please select a file and attachment type')
    return
  }

  // Check file size (10MB max)
  if (file.size > 10 * 1024 * 1024) {
    showError('File too large. Maximum size is 10MB.')
    return
  }

  try {
    const result = await api.uploadAttachment(currentInstance.id, file, attachmentType)
    currentAttachments = [result, ...currentAttachments]
    renderInstanceDetail()
    showSuccess('Attachment uploaded successfully!')
    form.reset()
  } catch (err) {
    showError('Failed to upload attachment: ' + err.message)
  }
}

// Handle attachment deletion
window.handleDeleteAttachment = async function(blobId) {
  if (!confirm('Are you sure you want to delete this attachment?')) {
    return
  }

  try {
    await api.deleteAttachment(blobId)
    currentAttachments = currentAttachments.filter(a => a.id !== blobId)
    renderInstanceDetail()
    showSuccess('Attachment deleted!')
  } catch (err) {
    showError('Failed to delete attachment: ' + err.message)
  }
}

// Render state data for display (handles nested objects like balances map)
function renderStateDisplay(state) {
  if (!state || Object.keys(state).length === 0) {
    return '<p style="color: #999;">No state data</p>'
  }

  return Object.entries(state).map(([key, value]) => {
    if (typeof value === 'object' && value !== null) {
      // Render nested object (like balances: { alice: 750, bob: 250 })
      // or doubly nested (like allowances: { owner: { spender: amount } })
      const entries = Object.entries(value)
      if (entries.length === 0) {
        return `
          <div class="detail-field">
            <dt>${formatFieldName(key)}</dt>
            <dd><span style="color: #999;">Empty</span></dd>
          </div>
        `
      }
      return `
        <div class="detail-field">
          <dt>${formatFieldName(key)}</dt>
          <dd>
            <div class="nested-state">
              ${entries.map(([k, v]) => {
                if (typeof v === 'object' && v !== null) {
                  // Handle nested map (2 levels deep, like allowances)
                  const innerEntries = Object.entries(v)
                  if (innerEntries.length === 0) {
                    return `
                      <div class="state-entry">
                        <span class="state-key">${k}</span>
                        <span class="state-value" style="color: #999;">Empty</span>
                      </div>
                    `
                  }
                  return `
                    <div class="state-entry nested-group">
                      <span class="state-key">${k}</span>
                      <div class="nested-state" style="margin-left: 1rem;">
                        ${innerEntries.map(([k2, v2]) => `
                          <div class="state-entry">
                            <span class="state-key">${k2}</span>
                            <span class="state-value">${formatStateValue(key, v2)}</span>
                          </div>
                        `).join('')}
                      </div>
                    </div>
                  `
                }
                return `
                  <div class="state-entry">
                    <span class="state-key">${k}</span>
                    <span class="state-value">${formatStateValue(key, v)}</span>
                  </div>
                `
              }).join('')}
            </div>
          </dd>
        </div>
      `
    }
    return `
      <div class="detail-field">
        <dt>${formatFieldName(key)}</dt>
        <dd>${formatStateValue(key, value)}</dd>
      </div>
    `
  }).join('')
}

// Format field name for display (e.g., "total_supply" -> "Total Supply")
function formatFieldName(name) {
  return name.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase())
}

// Format state value with unit if applicable
function formatStateValue(fieldName, value) {
  if (isAmountField(fieldName) && TOKEN_UNIT) {
    return `<strong>${value}</strong> ${TOKEN_UNIT}`
  }
  return `<strong>${value}</strong>`
}

// ============================================================================
// Action Form Modal
// ============================================================================

// Get the connected wallet address (if wallet feature is enabled)
function getConnectedWallet() {
  if (typeof wallet !== 'undefined' && wallet.getAccount) {
    const account = wallet.getAccount()
    return account?.address || null
  }
  return null
}

// Resolve auto-fill value
function resolveAutoFill(autoFill, state) {
  if (!autoFill) return ''
  if (autoFill === 'wallet') {
    return getConnectedWallet() || ''
  }
  if (autoFill === 'user') {
    return currentUser?.id || currentUser?.login || ''
  }
  // State path like "balances.{wallet}"
  if (autoFill.startsWith('balances.') || autoFill.includes('.')) {
    // Could resolve from state if needed
    return ''
  }
  return ''
}

// Create action form modal HTML
function createActionModal() {
  return `
    <div id="action-modal" class="modal" style="display: none;">
      <div class="modal-backdrop" onclick="hideActionModal()"></div>
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="action-modal-title">Execute Action</h3>
          <button onclick="hideActionModal()" class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <form id="action-form" onsubmit="handleActionSubmit(event)">
            <div id="action-form-fields"></div>
            <div class="form-actions">
              <button type="submit" class="btn btn-primary">Execute</button>
              <button type="button" class="btn btn-secondary" onclick="hideActionModal()">Cancel</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <style>
      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .modal-backdrop {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
      }
      .modal-content {
        position: relative;
        background: white;
        border-radius: 8px;
        padding: 0;
        min-width: 400px;
        max-width: 90%;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #eee;
      }
      .modal-header h3 {
        margin: 0;
        font-size: 1.25rem;
      }
      .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #666;
        padding: 0;
        line-height: 1;
      }
      .modal-close:hover {
        color: #333;
      }
      .modal-body {
        padding: 1.5rem;
      }
      .address-input-wrapper {
        position: relative;
      }
      .address-picker-btn {
        position: absolute;
        right: 4px;
        top: 50%;
        transform: translateY(-50%);
        background: #f0f0f0;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 4px 8px;
        font-size: 0.85rem;
        cursor: pointer;
      }
      .address-picker-btn:hover {
        background: #e0e0e0;
      }
      .field-description {
        font-size: 0.85rem;
        color: #666;
        margin-top: 0.25rem;
      }
    </style>
  `
}

// Current action being executed
let currentActionId = null

// Show action modal for a transition
function showActionModal(transitionId) {
  const transition = TRANSITION_DEFS.find(t => t.id === transitionId)
  if (!transition) return

  currentActionId = transitionId

  // Update modal title
  document.getElementById('action-modal-title').textContent = transition.name

  // Build form fields
  const fieldsHtml = transition.fields.map(field => {
    const autoValue = resolveAutoFill(field.autoFill, currentInstance?.state)
    const value = autoValue || field.defaultValue || ''
    const required = field.required ? 'required' : ''

    // Determine input type
    let inputHtml = ''
    if (field.type === 'amount') {
      inputHtml = `
        <input
          type="number"
          name="${field.name}"
          value="${value}"
          placeholder="${field.placeholder || 'Amount'}"
          step="any"
          ${required}
          class="form-control"
        />
        ${TOKEN_UNIT ? `<span class="field-description">Amount in ${TOKEN_UNIT}</span>` : ''}
      `
    } else if (field.type === 'address') {
      // Use dropdown for address fields in demo mode
      const accounts = getWalletAccounts()
      if (accounts.length > 0) {
        inputHtml = `
          <select name="${field.name}" ${required} class="form-control">
            <option value="">Select address...</option>
            ${accounts.map(acc => `
              <option value="${acc.address}" ${acc.address === value ? 'selected' : ''}>
                ${acc.name || 'Account'} (${acc.address.slice(0, 8)}...${acc.address.slice(-6)})
              </option>
            `).join('')}
          </select>
        `
      } else {
        inputHtml = `
          <input
            type="text"
            name="${field.name}"
            value="${value}"
            placeholder="${field.placeholder || '0x...'}"
            ${required}
            class="form-control"
          />
        `
      }
    } else if (field.type === 'hidden') {
      inputHtml = `<input type="hidden" name="${field.name}" value="${value}" />`
    } else {
      inputHtml = `
        <input
          type="${field.type === 'number' ? 'number' : 'text'}"
          name="${field.name}"
          value="${value}"
          placeholder="${field.placeholder || ''}"
          ${required}
          class="form-control"
        />
      `
    }

    // Hidden fields don't need labels
    if (field.type === 'hidden') {
      return inputHtml
    }

    return `
      <div class="form-field">
        <label>${field.label}${field.required ? ' *' : ''}</label>
        ${inputHtml}
      </div>
    `
  }).join('')

  document.getElementById('action-form-fields').innerHTML = fieldsHtml

  // Show modal
  document.getElementById('action-modal').style.display = 'flex'
}

// Hide action modal
window.hideActionModal = function() {
  document.getElementById('action-modal').style.display = 'none'
  currentActionId = null
}

// Handle action form submission
window.handleActionSubmit = async function(event) {
  event.preventDefault()

  if (!currentActionId || !currentInstance) return

  // Save action ID before hiding modal (which clears it)
  const actionId = currentActionId
  const instanceId = currentInstance.id

  const form = event.target
  const formData = new FormData(form)
  const data = {}

  for (const [key, value] of formData.entries()) {
    // Convert numeric strings to numbers for amount fields
    const field = TRANSITION_DEFS.find(t => t.id === actionId)?.fields.find(f => f.name === key)
    if (field && (field.type === 'amount' || field.type === 'number')) {
      data[key] = parseFloat(value) || 0
    } else {
      data[key] = value
    }
  }

  hideActionModal()

  try {
    const result = await api.executeTransition(actionId, instanceId, data)
    currentInstance = {
      ...currentInstance,
      version: result.version,
      state: result.state,
      displayState: unscaleStateData(result.state),
      places: result.state,
      enabled: result.enabled || [],
    }
    // Store state for wallet balance display
    window.currentInstanceState = currentInstance.state
    renderInstanceDetail()
    showSuccess(`Action "${actionId}" completed!`)
  } catch (err) {
    showError(`Failed to execute ${actionId}: ${err.message}`)
  }
}

// Check if wallet accounts are available for address picker
function hasWalletAccounts() {
  if (typeof wallet !== 'undefined' && wallet.getAccounts) {
    const accounts = wallet.getAccounts()
    return accounts && accounts.length > 0
  }
  return false
}

// Get wallet accounts for dropdowns
function getWalletAccounts() {
  if (typeof wallet !== 'undefined' && wallet.getAccounts) {
    return wallet.getAccounts() || []
  }
  return []
}

// Show address picker dropdown
window.showAddressPicker = function(fieldName) {
  if (typeof wallet === 'undefined' || !wallet.getAccounts) return

  const accounts = wallet.getAccounts()
  if (!accounts || accounts.length === 0) return

  // Create dropdown
  const existing = document.querySelector('.address-picker-dropdown')
  if (existing) existing.remove()

  const input = document.querySelector(`[name="${fieldName}"]`)
  if (!input) return

  const rect = input.getBoundingClientRect()
  const dropdown = document.createElement('div')
  dropdown.className = 'address-picker-dropdown'
  dropdown.style.cssText = `
    position: fixed;
    top: ${rect.bottom + 4}px;
    left: ${rect.left}px;
    width: ${rect.width}px;
    background: white;
    border: 1px solid #ddd;
    border-radius: 4px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 2000;
    max-height: 200px;
    overflow-y: auto;
  `

  dropdown.innerHTML = accounts.map(acc => `
    <div class="address-picker-option" onclick="selectAddress('${fieldName}', '${acc.address}')" style="
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    ">
      <div style="font-weight: 500;">${acc.name || 'Account'}</div>
      <div style="font-size: 0.85rem; color: #666; font-family: monospace;">${acc.address.slice(0, 10)}...${acc.address.slice(-8)}</div>
    </div>
  `).join('')

  document.body.appendChild(dropdown)

  // Close on click outside
  setTimeout(() => {
    document.addEventListener('click', function closeDropdown(e) {
      if (!dropdown.contains(e.target)) {
        dropdown.remove()
        document.removeEventListener('click', closeDropdown)
      }
    })
  }, 0)
}

// Select address from picker
window.selectAddress = function(fieldName, address) {
  const input = document.querySelector(`[name="${fieldName}"]`)
  if (input) {
    input.value = address
    input.dispatchEvent(new Event('input', { bubbles: true }))
  }
  const dropdown = document.querySelector('.address-picker-dropdown')
  if (dropdown) dropdown.remove()
}

// Form page - create new instance
async function renderFormPage() {
  const app = document.getElementById('app')
  app.innerHTML = `
    <div class="page">
      <div class="page-header">
        <div>
          <button class="btn btn-link" onclick="navigate('/vet-clinic')" style="margin-left: -0.5rem">
            &larr; Cancel
          </button>
          <h1 style="margin-top: 0.5rem">Create New</h1>
        </div>
      </div>
      <div class="card">
        <form id="create-form" onsubmit="handleSubmitCreate(event)">
          <p style="color: #666; margin-bottom: 1rem;">Create a new workflow instance. The instance will start in the initial state.</p>
          <div class="form-actions">
            <button type="submit" class="btn btn-primary">Create</button>
            <button type="button" class="btn btn-secondary" onclick="navigate('/vet-clinic')">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  `
}

// Financial Analytics Dashboard
async function renderDashboardPage() {
  const app = document.getElementById('app')

  // Add dashboard styles if not already present
  if (!document.getElementById('dashboard-styles')) {
    const styleEl = document.createElement('style')
    styleEl.id = 'dashboard-styles'
    styleEl.textContent = getDashboardStyles()
    document.head.appendChild(styleEl)
  }

  // Render the dashboard
  await renderDashboard(app)
}

// Simulation Mode Page
async function renderSimulationPage() {
  const app = document.getElementById('app')

  // Add simulation styles if not already present
  if (!document.getElementById('simulation-styles')) {
    const styleEl = document.createElement('style')
    styleEl.id = 'simulation-styles'
    styleEl.textContent = getSimulationStyles()
    document.head.appendChild(styleEl)
  }

  // Render the simulation control panel
  await renderSimulation(app)
}

// Admin dashboard
async function renderAdminPage() {
  const app = document.getElementById('app')
  app.innerHTML = `
    <div class="page">
      <div class="page-header">
        <h1>Admin Dashboard</h1>
      </div>
      <div id="admin-stats" class="card">
        <div class="loading">Loading statistics...</div>
      </div>
      <div id="admin-instances" class="card">
        <div class="card-header">Recent Instances</div>
        <div class="loading">Loading...</div>
      </div>
    </div>
  `

  try {
    const [stats, instancesResult] = await Promise.all([
      fetch(`${API_BASE}/admin/stats`, { headers: getHeaders() }).then(r => r.json()).catch(() => null),
      api.listInstances()
    ])

    if (stats) {
      document.getElementById('admin-stats').innerHTML = `
        <div class="card-header">Statistics</div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
          <div>
            <div style="font-size: 2rem; font-weight: 600;">${stats.total_streams || 0}</div>
            <div style="color: #666;">Total Instances</div>
          </div>
          <div>
            <div style="font-size: 2rem; font-weight: 600;">${stats.total_events || 0}</div>
            <div style="color: #666;">Total Events</div>
          </div>
        </div>
      `
    } else {
      document.getElementById('admin-stats').innerHTML = ''
    }

    instances = instancesResult.instances || []
    const container = document.getElementById('admin-instances').querySelector('.loading')
    if (container) {
      container.outerHTML = instances.length > 0
        ? `<table class="table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Status</th>
                <th>Version</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${instances.slice(0, 20).map(inst => {
                const status = getStatus(inst.state || inst.places)
                return `
                  <tr>
                    <td><code>${inst.id}</code></td>
                    <td>${formatStatus(status)}</td>
                    <td>${inst.version || 0}</td>
                    <td><button class="btn btn-sm btn-link" onclick="navigate('/vet-clinic/${inst.id}')">View</button></td>
                  </tr>
                `
              }).join('')}
            </tbody>
          </table>`
        : '<p style="color: #666; padding: 1rem;">No instances yet.</p>'
    }
  } catch (err) {
    showError('Failed to load admin data: ' + err.message)
  }
}

// ============================================================================
// Event Handlers
// ============================================================================

window.navigate = navigate

window.handleCreateNew = async function() {
  navigate('/vet-clinic/new')
}

window.handleSubmitCreate = async function(event) {
  event.preventDefault()
  try {
    const result = await api.createInstance({})
    showSuccess('Instance created successfully!')
    navigate(`/vet-clinic/${result.aggregate_id || result.id}`)
  } catch (err) {
    showError('Failed to create: ' + err.message)
  }
}

window.handleTransition = async function(transitionId) {
  if (!currentInstance) return

  // Check if transition has fields - show modal if so
  const transition = TRANSITION_DEFS.find(t => t.id === transitionId)
  if (transition && transition.fields && transition.fields.length > 0) {
    showActionModal(transitionId)
    return
  }

  // No fields - execute directly
  try {
    const result = await api.executeTransition(transitionId, currentInstance.id)
    currentInstance = {
      ...currentInstance,
      version: result.version,
      state: result.state,
      displayState: unscaleStateData(result.state),
      places: result.state,
      enabled: result.enabled || [],
    }
    // Store state for wallet balance display
    window.currentInstanceState = currentInstance.state
    renderInstanceDetail()
    showSuccess(`Action "${transitionId}" completed!`)
  } catch (err) {
    showError(`Failed to execute ${transitionId}: ${err.message}`)
  }
}

// ============================================================================
// Routing
// ============================================================================

function handleRouteChange(event) {
  const route = event.detail?.route || getCurrentRoute()
  if (!route) {
    renderListPage()
    return
  }

  const path = route.path

  // Cleanup previous page if needed
  cleanupSimulation()

  if (path === '/vet-clinic' || path === '/') {
    renderListPage()
  } else if (path === '/vet-clinic/new') {
    renderFormPage()
  } else if (path === '/vet-clinic/:id') {
    renderDetailPage()
  } else if (path === '/dashboard') {
    renderDashboardPage()
  } else if (path === '/simulation') {
    renderSimulationPage()
  } else if (path === '/admin' || path.startsWith('/admin')) {
    renderAdminPage()
  } else {
    renderListPage()
  }
}

// ============================================================================
// OAuth Callback Handler
// ============================================================================

async function handleOAuthCallback() {
  const params = new URLSearchParams(window.location.search)
  const token = params.get('token')
  const expiresAt = params.get('expires_at')

  if (token) {
    authToken = token
    try {
      const user = await api.getMe()
      saveAuth({ token, expires_at: expiresAt, user })
      window.history.replaceState({}, '', window.location.pathname)
      await refreshNavigation()
    } catch (err) {
      clearAuth()
      showError('Failed to complete login')
    }
  }
}

// ============================================================================
// Initialize
// ============================================================================

async function init() {
  // Initialize debug WebSocket for e2e testing
  initDebug()

  // Load auth state
  loadAuth()

  // Handle OAuth callback
  await handleOAuthCallback()

  // Load view definitions
  await loadViews()

  // Render navigation
  const nav = document.getElementById('nav')
  nav.innerHTML = await createNavigation()

  // Add action modal to body
  const modalContainer = document.createElement('div')
  modalContainer.innerHTML = createActionModal()
  document.body.appendChild(modalContainer)

  // Setup routing
  window.addEventListener('route-change', handleRouteChange)
  initRouter()

  // Initial render
  handleRouteChange({ detail: { route: getCurrentRoute() } })
}



// Start the app
init()
