// Generated by petri-pilot. DO NOT EDIT.

/**
 * Simulation Dashboard for coffeeshop application
 * ODE-based resource prediction with Chart.js visualization
 */

// Chart.js must be loaded via CDN in index.html:
// <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

let simulationChart = null
let simulationData = null

/**
 * Render the simulation page
 */
export function renderSimulationPage() {
  return `
    <div class="page page-simulation">
      <div class="page-header">
        <h1>Resource Prediction</h1>
        <p class="subtitle">ODE-based simulation of resource consumption</p>
      </div>

      <div class="simulation-controls">
        <div class="control-group">
          <label for="simulation-hours">Simulation Duration (hours):</label>
          <input type="number" id="simulation-hours" value="8" min="1" max="24" step="1">
        </div>
        <button id="run-simulation" class="btn btn-primary">Run Simulation</button>
        <button id="check-runout" class="btn btn-secondary">Check Runout Times</button>
      </div>

      <div class="simulation-chart-container">
        <canvas id="simulation-chart"></canvas>
      </div>

      <div id="runout-warnings" class="runout-warnings" style="display: none;">
        <h3>Runout Predictions</h3>
        <div id="runout-list"></div>
      </div>

      <div id="simulation-loading" class="loading" style="display: none;">
        <p>Running simulation...</p>
      </div>

      <div id="simulation-error" class="error" style="display: none;"></div>
    </div>
  `
}
/**
 * Initialize simulation page after DOM is ready
 */
export function initSimulation() {
  const runBtn = document.getElementById('run-simulation')
  const runoutBtn = document.getElementById('check-runout')

  if (runBtn) {
    runBtn.addEventListener('click', runSimulation)
  }
  if (runoutBtn) {
    runoutBtn.addEventListener('click', checkRunout)
  }
}

/**
 * Run the ODE simulation
 */
async function runSimulation() {
  const hoursInput = document.getElementById('simulation-hours')
  const hours = hoursInput ? parseFloat(hoursInput.value) || 8 : 8

  showLoading()
  hideError()

  try {
    const response = await fetch(`/api/coffeeshop/predict?hours=${hours}`)
    if (!response.ok) {
      throw new Error(`Simulation failed: ${response.statusText}`)
    }

    simulationData = await response.json()
    renderChart(simulationData)
    renderRunoutWarnings(simulationData.runoutTime)
    hideLoading()
  } catch (error) {
    hideLoading()
    showError(error.message)
    console.error('Simulation error:', error)
  }
}

/**
 * Check runout times only
 */
async function checkRunout() {
  showLoading()
  hideError()

  try {
    const response = await fetch('/api/coffeeshop/runout')
    if (!response.ok) {
      throw new Error(`Runout check failed: ${response.statusText}`)
    }

    const runoutTime = await response.json()
    renderRunoutWarnings(runoutTime)
    hideLoading()
  } catch (error) {
    hideLoading()
    showError(error.message)
    console.error('Runout check error:', error)
  }
}

/**
 * Render the Chart.js visualization
 */
function renderChart(data) {
  const canvas = document.getElementById('simulation-chart')
  if (!canvas) return

  // Destroy existing chart if any
  if (simulationChart) {
    simulationChart.destroy()
  }

  // Convert time points to hours for display
  const timeLabels = data.timePoints.map(t => `${(t / 60).toFixed(1)}h`)

  // Generate colors for each resource
  const colors = [
    'rgb(75, 192, 192)',
    'rgb(255, 99, 132)',
    'rgb(255, 205, 86)',
    'rgb(54, 162, 235)',
    'rgb(153, 102, 255)',
    'rgb(255, 159, 64)',
  ]

  // Build datasets
  const datasets = Object.entries(data.resources).map(([name, values], index) => ({
    label: formatResourceName(name),
    data: values,
    borderColor: colors[index % colors.length],
    backgroundColor: colors[index % colors.length].replace('rgb', 'rgba').replace(')', ', 0.1)'),
    borderWidth: 2,
    fill: true,
    tension: 0.4,
  }))

  simulationChart = new Chart(canvas, {
    type: 'line',
    data: {
      labels: timeLabels,
      datasets: datasets,
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        title: {
          display: true,
          text: 'Resource Levels Over Time',
        },
        legend: {
          position: 'top',
        },
      },
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Quantity',
          },
        },
        x: {
          title: {
            display: true,
            text: 'Time',
          },
        },
      },
    },
  })
}

/**
 * Render runout warnings
 */
function renderRunoutWarnings(runoutTime) {
  const container = document.getElementById('runout-warnings')
  const list = document.getElementById('runout-list')

  if (!container || !list) return

  if (!runoutTime || Object.keys(runoutTime).length === 0) {
    container.style.display = 'none'
    return
  }

  container.style.display = 'block'
  list.innerHTML = Object.entries(runoutTime)
    .map(([resource, time]) => {
      const hours = (time / 60).toFixed(1)
      return `<div class="warning-item">
        <span class="warning-icon">&#9888;</span>
        <span class="warning-text">
          <strong>${formatResourceName(resource)}</strong> depleted at ${hours} hours
        </span>
      </div>`
    })
    .join('')
}

/**
 * Format resource name for display
 */
function formatResourceName(name) {
  return name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())
}

function showLoading() {
  const el = document.getElementById('simulation-loading')
  if (el) el.style.display = 'block'
}

function hideLoading() {
  const el = document.getElementById('simulation-loading')
  if (el) el.style.display = 'none'
}

function showError(message) {
  const el = document.getElementById('simulation-error')
  if (el) {
    el.textContent = message
    el.style.display = 'block'
  }
}

function hideError() {
  const el = document.getElementById('simulation-error')
  if (el) el.style.display = 'none'
}

// Export for router integration
export const simulationRenderers = {
  'SimulationPage': renderSimulationPage,
}
